function htmlEncode(b){return b?a=jQuery("<div />").text(b).html():""}function htmlDecode(a){return a?$("<div />").html(a).text():""}function utf8_to_b64(a){return window.btoa(unescape(encodeURIComponent(a)))}function b64_to_utf8(a){return decodeURIComponent(escape(window.atob(a)))}function handlepaste(a,b){var c=a.innerHTML;return b&&b.clipboardData&&b.clipboardData.getData?(/text\/html/.test(b.clipboardData.types)?(txt=UI.tagSelection?UI.tagSelection:htmlEncode(b.clipboardData.getData("text/plain")),a.innerHTML=txt):/text\/plain/.test(b.clipboardData.types)?(txt=UI.tagSelection?UI.tagSelection:htmlEncode(b.clipboardData.getData("text/plain")),a.innerHTML=txt):a.innerHTML="",waitforpastedata(a,c),b.preventDefault&&(b.stopPropagation(),b.preventDefault()),!1):(a.innerHTML="",waitforpastedata(a,c),!0)}function waitforpastedata(a,b){a.childNodes&&a.childNodes.length>0?processpaste(a,b):(that={e:a,s:b},that.callself=function(){waitforpastedata(that.e,that.s)},setTimeout(that.callself,20))}function processpaste(a,b){pasteddata=a.innerHTML,a.innerHTML=b,$("#placeHolder").before(pasteddata),focusOnPlaceholder(),$("#placeHolder").remove()}function focusOnPlaceholder(){var a=document.getElementById("placeHolder");if(a){var b,c;window.getSelection&&document.createRange?(c=document.createRange(),c.selectNodeContents(a),c.collapse(!0),b=window.getSelection(),b.removeAllRanges(),b.addRange(c)):document.body.createTextRange&&(c=document.body.createTextRange(),c.moveToElementText(a),c.select())}}function truncate_filename(a,b){var c=a.substring(a.lastIndexOf(".")+1,a.length).toLowerCase(),d=a.replace("."+c,"");return d.length<=b?a:(d=d.substr(0,b)+(a.length>b?"[...]":""),d+"."+c)}function insertNodeAtCursor(a){var b,c;window.getSelection&&window.getSelection().getRangeAt?("Caret"==window.getSelection().type||UI.isFirefox)&&(b=window.getSelection().getRangeAt(0),b.insertNode(a),setCursorAfterNode(b,a)):document.selection&&document.selection.createRange&&(b=document.selection.createRange(),c=3==a.nodeType?a.data:a.outerHTML,b.pasteHTML(c))}function setCursorAfterNode(a,b){a.setStartAfter(b),a.setEndAfter(b),window.getSelection().removeAllRanges(),window.getSelection().addRange(a)}function pasteHtmlAtCaret(a,b){var c,d;if(window.getSelection){if(c=window.getSelection(),c.getRangeAt&&c.rangeCount){d=c.getRangeAt(0),d.deleteContents();var e=document.createElement("div");e.innerHTML=a;for(var f,g,h=document.createDocumentFragment();f=e.firstChild;)g=h.appendChild(f);var i=h.firstChild;d.insertNode(h),g&&(d=d.cloneRange(),d.setStartAfter(g),b?d.setStartBefore(i):d.collapse(!0),c.removeAllRanges(),c.addRange(d))}}else if((c=document.selection)&&"Control"!=c.type){var j=c.createRange();j.collapse(!0),c.createRange().pasteHTML(a),b&&(d=c.createRange(),d.setEndPoint("StartToStart",j),d.select())}}function setCursorPosition(a,b){b=b||0;var c=document.createRange(),d=window.getSelection();c.setStart(a,b),"end"==b&&c.setStartAfter(a),c.collapse(!0),d.removeAllRanges(),d.addRange(c),"undefined"!=typeof a[0]&&a.focus()}function removeSelectedText(){if(window.getSelection||document.getSelection){var a=(window.getSelection?window:document).getSelection();if("Caret"==a.type)a.extentOffset!=a.baseOffset&&a.deleteFromDocument();else if("Range"==a.type){var b=$(a.baseNode).parent()[0];$(b).hasClass("selected")?$(b).remove():a.deleteFromDocument()}}else document.selection.clear()}function fileUpload(a,b,c){console.log("div_id: ",c);var d=document.createElement("iframe");d.setAttribute("id","upload_iframe"),d.setAttribute("name","upload_iframe"),d.setAttribute("width","0"),d.setAttribute("height","0"),d.setAttribute("border","0"),d.setAttribute("style","width: 0; height: 0; border: none;"),a.parentNode.appendChild(d),window.frames.upload_iframe.name="upload_iframe",iframeId=document.getElementById("upload_iframe");var e=function(){iframeId.detachEvent?iframeId.detachEvent("onload",e):iframeId.removeEventListener("load",e,!1),iframeId.contentDocument?content=iframeId.contentDocument.body.innerHTML:iframeId.contentWindow?content=iframeId.contentWindow.document.body.innerHTML:iframeId.document&&(content=iframeId.document.body.innerHTML),document.getElementById(c).innerHTML=content,setTimeout("iframeId.parentNode.removeChild(iframeId)",250)};iframeId.addEventListener&&iframeId.addEventListener("load",e,!0),iframeId.attachEvent&&iframeId.attachEvent("onload",e),a.setAttribute("target","upload_iframe"),a.setAttribute("action",b),a.setAttribute("method","post"),a.setAttribute("enctype","multipart/form-data"),a.setAttribute("encoding","multipart/form-data"),$(a).append('<input type="hidden" name="job_id" value="'+config.job_id+'" />').append('<input type="hidden" name="exec" value="newTM" />').append('<input type="hidden" name="job_pass" value="'+config.password+'" />').append('<input type="hidden" name="tm_key" value="'+$("#addtm-tr-key").val()+'" />').append('<input type="hidden" name="name" value="'+$("#uploadTMX").text()+'" />').append('<input type="hidden" name="r" value="1" />').append('<input type="hidden" name="w" value="1" />'),a.submit(),$(".popup-addtm-tr .x-popup").click(),UI.showMessage({msg:"Uploading your TM..."}),$("#messageBar .msg").after('<span class="progress"></span>'),TMKey=$("#addtm-tr-key").val(),TMName=$("#uploadTMX").text(),console.log("TMKey 1: ",TMKey),console.log("TMName 1: ",TMName),setTimeout(function(){UI.pollForUploadCallback(TMKey,TMName)},3e3)}function stripHTML(a){var b=document.createElement("div");return b.innerHTML=a,b.textContent||b.innerText}function stackTrace(){var a=new Error;return a.stack}function placehold_xliff_tags(a){return a=a.replace(/<(g\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER),a=a.replace(/<(\/g)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER),a=a.replace(/<(x.*?\/?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER),a=a.replace(/<(bx.*?\/?])>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(ex.*?\/?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(bpt\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/bpt)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(ept\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/ept)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(ph\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/ph)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(it\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/ph)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(it\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/it)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(mrk\s*.*?)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a),a=a.replace(/<(\/mrk)>/gi,LTPLACEHOLDER+"$1"+GTPLACEHOLDER,a)}function restore_xliff_tags(a){return a=a.replace(re_lt,"<"),a=a.replace(re_gt,">")}function restore_xliff_tags_for_view(a){return a=a.replace(re_lt,"&lt;"),a=a.replace(re_gt,"&gt;")}function view2rawxliff(a){return a=placehold_xliff_tags(a),a=htmlEncode(a),a=restore_xliff_tags(a)}function rawxliff2view(a){return a=placehold_xliff_tags(a),a=htmlDecode(a),a=a.replace(/<(.*?)>/i,"&lt;$1&gt;"),a=restore_xliff_tags_for_view(a)}function rawxliff2rawview(a){return a=placehold_xliff_tags(a),a=htmlDecode(a),a=restore_xliff_tags_for_view(a)}function saveSelection(){var a=UI.editarea;UI.savedSel&&rangy.removeMarkers(UI.savedSel),UI.savedSel=rangy.saveSelection();try{a.html(a.html().replace(UI.cursorPlaceholder,""))}catch(b){UI.editarea=$("<div>")}UI.savedSelActiveElement=document.activeElement}function restoreSelection(){UI.savedSel&&(rangy.restoreSelection(UI.savedSel,!0),UI.savedSel=null,window.setTimeout(function(){UI.savedSelActiveElement&&"undefined"!=typeof UI.savedSelActiveElement.focus&&UI.savedSelActiveElement.focus()},1))}function selectText(a){var b,c,d=document,e=a;d.body.createTextRange?(b=document.body.createTextRange(),b.moveToElementText(e),b.select()):window.getSelection&&(c=window.getSelection(),b=document.createRange(),b.selectNodeContents(e),c.removeAllRanges(),c.addRange(b))}function getSelectionHtml(){var a="";if("undefined"!=typeof window.getSelection){var b=window.getSelection();if(b.rangeCount){for(var c=document.createElement("div"),d=0,e=b.rangeCount;e>d;++d)c.appendChild(b.getRangeAt(d).cloneContents());a=c.innerHTML}}else"undefined"!=typeof document.selection&&"Text"==document.selection.type&&(a=document.selection.createRange().htmlText);return a}function insertHtmlAfterSelection(a){var b,c,d;if(window.getSelection){if(b=window.getSelection(),b.getRangeAt&&b.rangeCount){c=window.getSelection().getRangeAt(0),c.collapse(!1);var e=document.createElement("div");e.innerHTML=a;for(var d,f,g=document.createDocumentFragment();d=e.firstChild;)f=g.appendChild(d);c.insertNode(g)}}else document.selection&&document.selection.createRange&&(c=document.selection.createRange(),c.collapse(!1),c.pasteHTML(a))}function setBrowserHistoryBehavior(){window.onpopstate=function(){segmentId=location.hash.substr(1),UI.segmentIsLoaded(segmentId)?$(".editarea",$("#segment-"+segmentId)).click():$("section").length&&UI.pointBackToSegment(segmentId)}}function goodbye(a){function b(b){return"undefined"!=typeof b?(a||(a=window.event),a.cancelBubble=!0,a.returnValue=b,a.stopPropagation&&(a.stopPropagation(),a.preventDefault()),b):void 0}return UI.clearStorage("contribution"),$("#downloadProject").hasClass("disabled")||$("tr td a.downloading").length||$(".popup-tm td.uploadfile.uploading").length?b("You have a pending operation. Are you sure you want to quit?"):UI.offline&&UI.setTranslationTail.length?b("You are working in offline mode. If you proceed to refresh you will lose all the pending translations. Do you want to proceed with the refresh ?"):void 0}function lev(a,b){if(a==b)return 0;var c=a.length,d=b.length;if(0===c)return d;if(0===d)return c;var e=!1;try{e=!"0"[0]}catch(f){e=!0}e&&(a=a.split(""),b=b.split(""));var g=new Array(c+1),h=new Array(c+1),i=0,j=0,k=0;for(i=0;c+1>i;i++)g[i]=i;var l="",m="";for(j=1;d>=j;j++){for(h[0]=j,m=b[j-1],i=0;c>i;i++){l=a[i],k=l==m?0:1;var n=g[i+1]+1,o=h[i]+1,p=g[i]+k;n>o&&(n=o),n>p&&(n=p),h[i+1]=n}var q=g;g=h,h=q}return g[c]}function replaceSelectedText(a){var b,c;window.getSelection?(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.deleteContents(),c.insertNode(document.createTextNode(a)))):document.selection&&document.selection.createRange&&(console.log("c"),c=document.selection.createRange(),c.text=a)}function replaceSelectedHtml(a){var b,c;window.getSelection?(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.deleteContents(),pasteHtmlAtCaret(a))):document.selection&&document.selection.createRange&&(console.log("c"),c=document.selection.createRange(),c.text=replacementText)}function capitaliseFirstLetter(a){return a.charAt(0).toUpperCase()+a.slice(1)}function toTitleCase(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}function getRangeObject(a){if(UI.isSafari){var b=document.createRange();return b.setStart(a.anchorNode,a.anchorOffset),b.setEnd(a.focusNode,a.focusOffset),b}return a.getRangeAt(0)}UI=null,UI={toggleFileMenu:function(){if(console.log("ddd"),jobMenu=$("#jobMenu"),jobMenu.is(":animated"))return!1;currSegment=jobMenu.find(".currSegment"),this.body.hasClass("editing")?currSegment.show():currSegment.hide();var a=jobMenu.height(),b=UI.body.hasClass("incomingMsg");messageBarHeight=b?$("#messageBar").height()+5:0,console.log("messageBarHeight: ",messageBarHeight);var c=UI.body.hasClass("filterOpen");return console.log("searchBoxIsOpen: ",c),searchBoxHeight=c?$(".searchbox").height()+1:0,console.log("searchBoxHeight: ",searchBoxHeight),jobMenu.css("top",messageBarHeight+searchBoxHeight+43-a+"px"),jobMenu.hasClass("open")?jobMenu.animate({top:"-="+a+"px"},500).removeClass("open"):jobMenu.animate({top:"+="+a+"px"},300,function(){$("body").on("click",function(){jobMenu.hasClass("open")&&UI.toggleFileMenu()})}).addClass("open"),!0},activateSegment:function(a){this.createFooter(this.currentSegment,a),this.createButtons(),this.createHeader()},cacheObjects:function(a){this.editarea=$(a),this.lastOpenedSegment=this.currentSegment,this.lastOpenedEditarea=$(".editarea",this.currentSegment),this.currentSegmentId=this.lastOpenedSegmentId=this.editarea.data("sid"),this.currentSegment=segment=$("#segment-"+this.currentSegmentId),this.currentFile=segment.parent(),this.currentFileId=this.currentFile.attr("id").split("-")[1];var b=$(".source",this.currentSegment).html().match(/(&lt;\s*\/*\s*(g|x|bx|ex|bpt|ept|ph|it|mrk)\s*.*?&gt;)/gi);this.sourceTags=b||[]},changeStatus:function(a,b,c){var d=c?$(a).parents("section"):$("#"+$(a).data("segmentid"));segment_id=this.getSegmentId(d),$(".percentuage",d).removeClass("visible"),this.setTranslation(this.getSegmentId(d),b,!1),d.removeClass("saved"),this.setContribution(segment_id,b,c),this.setContributionMT(segment_id,b,c),this.getNextSegment(this.currentSegment,"untranslated"),this.nextUntranslatedSegmentId||$(window).trigger({type:"allTranslated"}),$(window).trigger({type:"statusChanged",segment:d,status:b})},getSegmentId:function(a){if("undefined"==typeof a)return!1;try{return $(a).attr("id").replace("segment-","")}catch(b){return!1}},checkHeaviness:function(){},checkIfFinished:function(a){this.progress_perc!=this.done_percentage&&"100"==this.progress_perc||a&&"100"==this.progress_perc?this.body.addClass("justdone"):this.body.removeClass("justdone")},checkIfFinishedFirst:function(){$("section").length==$("section.status-translated, section.status-approved").length&&this.body.addClass("justdone")},closeSegment:function(a,b,c){if("undefined"==typeof a||"undefined"!=typeof UI.toSegment)return this.toSegment=void 0,!0;this.autoSave=!1,$(window).trigger({type:"segmentClosed",segment:a}),clearTimeout(this.liveConcordanceSearchReq);var d=!0;return"noSave"!=c&&("translated"==c||"Save"==c)&&(d=!1),a.hasClass("modified")&&d&&!config.isReview&&this.saveSegment(a),this.deActivateSegment(b),this.removeGlossaryMarksFormSource(),this.lastOpenedEditarea.attr("contenteditable","false"),this.body.removeClass("editing"),$(a).removeClass("editor waiting_for_check_result opened"),$("span.locked.mismatch",a).removeClass("mismatch"),this.opening||this.checkIfFinished(1),$(".sid .actions .split").removeClass("cancel"),source=$(a).find(".source"),$(source).removeAttr("style"),$("section").removeClass("split-action"),$(".split-shortcut").html("CTRL + S"),$(".splitBar, .splitArea").remove(),$(".sid .actions").hide(),!0},copySource:function(){var a=UI.clearMarks($.trim($(".source",this.currentSegment).html()));this.saveInUndoStack("copysource"),$(".editarea",this.currentSegment).html(a).keyup().focus(),this.saveInUndoStack("copysource"),this.highlightEditarea(),this.currentSegmentQA(),$(this.currentSegment).trigger("copySourceToTarget")},clearMarks:function(a){return a=a.replace(/(<mark class="inGlossary">)/gi,"").replace(/<\/mark>/gi,"")},highlightEditarea:function(a){segment=a||this.currentSegment,segment.addClass("highlighted1"),setTimeout(function(){$(".highlighted1").addClass("modified highlighted2")},300),setTimeout(function(){$(".highlighted1, .highlighted2").removeClass("highlighted1 highlighted2")},2e3)},confirmDownload:function(a){a&&UI.isChrome&&($(".download-chrome").addClass("d-open"),setTimeout(function(){$(".download-chrome").removeClass("d-open")},7e3))},copyToNextIfSame:function(a){$(".source",this.currentSegment).data("original")==$(".source",a).data("original")&&$(".editarea",a).hasClass("fromSuggestion")&&$(".editarea",a).text(this.editarea.text())},createButtons:function(){var a=this.currentSegment.hasClass("loaded")?"":' disabled="disabled"',b=this.currentSegment.next(),c=b.hasClass("status-new")||b.hasClass("status-draft"),d=c?"":'<li><a id="segment-'+this.currentSegmentId+'-nextuntranslated" href="#" class="btn next-untranslated" data-segmentid="segment-'+this.currentSegmentId+'" title="Translate and go to next untranslated">T+&gt;&gt;</a><p>'+(UI.isMac?"CMD":"CTRL")+"+SHIFT+ENTER</p></li>";UI.segmentButtons=d+'<li><a id="segment-'+this.currentSegmentId+'-button-translated" data-segmentid="segment-'+this.currentSegmentId+'" href="#" class="translated"'+a+" >TRANSLATED</a><p>"+(UI.isMac?"CMD":"CTRL")+"+ENTER</p></li>",buttonsOb=$("#segment-"+this.currentSegmentId+"-buttons"),UI.currentSegment.trigger("buttonsCreation"),buttonsOb.empty().append(UI.segmentButtons),buttonsOb.before('<p class="warnings"></p>'),UI.segmentButtons=null},createFooter:function(a,b){if(b="undefined"==typeof b?!0:b,""!==$(".matches .overflow",a).text()&&!b)return $(".matches .overflow",a).empty(),!1;if(""!==$(".footer",a).text())return!1;if(UI.footerHTML='<ul class="submenu">	<li class="'+(config.isReview?"":"active")+' tab-switcher-tm" id="segment-'+this.currentSegmentId+'-tm">		<a tabindex="-1" href="#">Translation matches'+(config.mt_enabled?"":" (No MT)")+'</a>	</li>	<li class="tab-switcher-cc" id="segment-'+this.currentSegmentId+'-cc">		<a tabindex="-1" href="#">Concordance</a>	</li>	<li class="tab-switcher-gl" id="segment-'+this.currentSegmentId+'-gl">		<a tabindex="-1" href="#">Glossary&nbsp;<span class="number"></span></a>	</li>	<li class="tab-switcher-al" id="segment-'+this.currentSegmentId+'-al">		<a tabindex="-1" href="#">Translation conflicts&nbsp;<span class="number"></span></a>	</li></ul><div class="tab sub-editor matches" '+(config.isReview?'style="display: none"':"")+' id="segment-'+this.currentSegmentId+'-matches">	<div class="overflow"></div></div><div class="tab sub-editor concordances" id="segment-'+this.currentSegmentId+'-concordances">	<div class="overflow">'+(config.tms_enabled?'<div class="cc-search"><div class="input search-source" contenteditable="true" /><div class="input search-target" contenteditable="true" /></div>':'<ul class="graysmall message"><li>Concordance is not available when the TM feature is disabled</li></ul>')+'		<div class="results"></div>	</div></div><div class="tab sub-editor glossary" id="segment-'+this.currentSegmentId+'-glossary">	<div class="overflow">'+(config.tms_enabled?'		<div class="gl-search">			<div class="input search-source" contenteditable="true" />				<div class="input search-target" contenteditable="true" />					<!-- a class="search-glossary" href="#"></a --><a class="set-glossary disabled" href="#"></a>					<div class="comment">						<a href="#">(+) Comment</a>						<div class="input gl-comment" contenteditable="true" /></div>					</div>					<div class="results"></div>				</div>			</div>		</div>':'<ul class="graysmall message"><li>Glossary is not available when the TM feature is disabled</li></ul>')+"	</div></div>",UI.currentSegment.trigger("footerCreation"),$(".footer",a).html(UI.footerHTML),alternativesTabHtml='<div class="tab sub-editor alternatives" id="segment-'+this.currentSegmentId+'-alternatives">	<div class="overflow"></div></div>',$(".footer .tab.glossary").after(alternativesTabHtml),UI.currentSegment.trigger("afterFooterCreation"),UI.footerHTML=null,$(a).hasClass("loaded")&&a===this.currentSegment&&""===$(a).find(".matches .overflow").text()){var c=JSON.parse(UI.getFromStorage("contribution-"+config.job_id+"-"+UI.getSegmentId(a)));UI.processContributions(c,a)}},createHeader:function(a){if(a=a||!1,!$("h2.percentuage",this.currentSegment).length||a){var b='<h2 title="" class="percentuage"><span></span></h2><a href="#" id="segment-'+this.currentSegmentId+'-close" class="close" title="Close this segment"></a><a href="/referenceFile/'+config.job_id+"/"+config.password+"/"+this.currentSegmentId+'" id="segment-'+this.currentSegmentId+'-context" class="context" title="Open context" target="_blank">Context</a>';$("#"+this.currentSegment.attr("id")+"-header").html(b),this.currentSegment.data("autopropagated")&&!$(".header .repetition",this.currentSegment).length&&$(".header",this.currentSegment).prepend('<span class="repetition">Autopropagated</span>')}},createJobMenu:function(){var a='<nav id="jobMenu" class="topMenu">    <ul>';$.each(config.firstSegmentOfFiles,function(){a+='<li data-file="'+this.id_file+'" data-segment="'+this.first_segment+'"><span class="'+UI.getIconClass(this.file_name.split(".")[this.file_name.split(".").length-1])+'"></span><a href="#" title="'+this.file_name+'" >'+this.file_name+"</a></li>"}),a+='    </ul>	<ul>		<li class="currSegment" data-segment="'+UI.currentSegmentId+'"><a href="#">Go to current segment</a></li>    </ul></nav>',this.body.append(a)},displaySurvey:function(a){this.surveyDisplayed||(survey='<div class="modal survey" data-type="view">	<div class="popup-outer"></div>	<div class="popup survey">		<a href="#" class="x-popup"></a>		<h1>Translation Completed - Take a Survey</h1>		<p class="surveynotice">To stop displaying the survey, click on the <b>X</b> icon on the top right corner of this popup.</p>		<div class="popup-box">			<iframe src="'+a+'" width="100%" height="670" frameborder="0" marginheight="0" marginwidth="0">Loading ...</iframe>		</div>	</div></div>',this.body.append(survey),$(".modal.survey").show())},surveyAlreadyDisplayed:function(){if("undefined"!=typeof $.cookie("surveyedJobs")){var a=$.cookie("surveyedJobs");if(surv=a.split("||")[0],config.survey===surv){jobs=$.cookie("surveyedJobs").split("||")[1].split(",");var b=!1;return $.each(jobs,function(){this==config.job_id&&(b=!0)}),b}return!0}return!1},handleReturn:function(a){if(this.hiddenTextEnabled){a.preventDefault();var b=document.createElement("span"),c=document.createElement("br");b.setAttribute("class","monad softReturn "+config.lfPlaceholderClass),b.setAttribute("contenteditable","false"),b.appendChild(c),insertNodeAtCursor(b),this.unnestMarkers()}},getIconClass:function(a){return c="doc"==a||"dot"==a||"docx"==a||"dotx"==a||"docm"==a||"dotm"==a||"odt"==a||"sxw"==a?"extdoc":"pot"==a||"pps"==a||"ppt"==a||"potm"==a||"potx"==a||"ppsm"==a||"ppsx"==a||"pptm"==a||"pptx"==a||"odp"==a||"sxi"==a?"extppt":"htm"==a||"html"==a?"exthtm":"pdf"==a?"extpdf":"xls"==a||"xlt"==a||"xlsm"==a||"xlsx"==a||"xltx"==a||"ods"==a||"sxc"==a||"csv"==a?"extxls":"txt"==a?"exttxt":"ttx"==a?"extttx":"itd"==a?"extitd":"xlf"==a?"extxlf":"mif"==a?"extmif":"idml"==a?"extidd":"xtg"==a?"extqxp":"xml"==a?"extxml":"rc"==a?"extrcc":"resx"==a?"extres":"sgml"==a?"extsgl":"sgm"==a?"extsgm":"properties"==a?"extpro":"extxif"},createStatusMenu:function(a){$("ul.statusmenu").empty().hide();var b='<li class="arrow"><span class="arrow-mcolor"></span></li><li><a href="#" class="f" data-sid="segment-'+this.currentSegmentId+'" title="set draft as status">DRAFT</a></li><li><a href="#" class="d" data-sid="segment-'+this.currentSegmentId+'" title="set translated as status">TRANSLATED</a></li><li><a href="#" class="a" data-sid="segment-'+this.currentSegmentId+'" title="set approved as status">APPROVED</a></li><li><a href="#" class="r" data-sid="segment-'+this.currentSegmentId+'" title="set rejected as status">REJECTED</a></li>';a.html(b).show()},deActivateSegment:function(a){this.removeButtons(a),this.removeHeader(a),this.removeFooter(a)},detectAdjacentSegment:function(a,b,c){return c||(c=1),"down"==b?(adjacent=a.next(),adjacent.is("section")||(adjacent=this.currentFile.next().find("section:first"))):(adjacent=a.prev(),adjacent.is("section")||(adjacent=$(".editor").parents("article").prev().find("section:last"))),adjacent.length?1==c?adjacent:(this.detectAdjacentSegment(adjacent,b,c-1),!0):!0},detectFirstLast:function(){var a=$("section");this.firstSegment=a.first(),this.lastSegment=a.last()},detectRefSegId:function(a){var b=$("section"),c="after"==a?b.last():"before"==a?b.first():"",d=c.length?this.getSegmentId(c):0;return d},detectStartSegment:function(){if(this.segmentToScrollAtRender)this.startSegmentId=this.segmentToScrollAtRender;else{var a=window.location.hash.substr(1);this.startSegmentId=a?a:config.last_opened_segment}},fixHeaderHeightChange:function(){headerHeight=$("header .wrapper").height()+(this.body.hasClass("filterOpen")?$("header .searchbox").height():0)+(this.body.hasClass("incomingMsg")?$("header #messageBar").height():0),$("#outer").css("margin-top",headerHeight+"px")},nextUnloadedResultSegment:function(){var a="",b=this.getSegmentId($("section").last());return $.each(this.searchResultsSegments,function(){return!$("#segment-"+this).length&&parseInt(this)>parseInt(b)?(a=parseInt(this),!1):void 0}),""===a&&(a=this.searchResultsSegments[0]),a},footerMessage:function(a,b){$(".footer-message",b).remove(),$(".submenu",b).append('<li class="footer-message">'+a+"</div>"),$(".footer-message",b).fadeOut(6e3)},getMoreSegments:function(a){if(!("after"==a&&this.noMoreSegmentsAfter||"before"==a&&this.noMoreSegmentsBefore||this.loadingMore)){this.loadingMore=!0;var b=this.detectRefSegId(a);"before"==a&&$("section").each(function(){return $(this).offset().top>$(window).scrollTop()?(UI.segMoving=UI.getSegmentId($(this)),!1):void 0}),"before"==a?$("#outer").addClass("loadingBefore"):"after"==a&&$("#outer").addClass("loading"),APP.doRequest({data:{action:"getSegments",jid:config.job_id,password:config.password,step:UI.moreSegNum,segment:b,where:a},error:function(){UI.failedConnection(0,"getMoreSegments")},success:function(a){UI.getMoreSegments_success(a)}})}},getMoreSegments_success:function(a){if(a.errors.length&&this.processErrors(a.errors,"getMoreSegments"),where=a.data.where,section=$("section"),"undefined"!=typeof a.data.files){firstSeg=section.first(),lastSeg=section.last();var b=0;$.each(a.data.files,function(){b+=this.segments.length}),this.renderFiles(a.data.files,where,!1),"before"==where&&b&&this.scrollSegment($("#segment-"+this.segMoving)),this.body.hasClass("searchActive")?(segLimit="before"==where?firstSeg:lastSeg,this.markSearchResults({where:where,seg:segLimit})):this.markTags()}0===a.data.files.length&&("after"==where&&(this.noMoreSegmentsAfter=!0),"before"==where&&(this.noMoreSegmentsBefore=!0)),$("#outer").removeClass("loading loadingBefore"),this.loadingMore=!1,this.setWaypoints(),$(window).trigger("segmentsAdded")},getNextSegment:function(a,b){var c=this.currentSegment,d="untranslated"==b?"section.status-draft:not(.readonly), section.status-rejected:not(.readonly), section.status-new:not(.readonly)":"section.status-"+b+":not(.readonly)",e=$(c).nextAll(d).first();e.length||(e=$(c).parents("article").next().find(d).first()),this.nextUntranslatedSegmentId=e.length?this.getSegmentId($(e)):UI.nextUntranslatedSegmentIdByServer;var f=$(c).next();f.length||(f=$(c).parents("article").next().find("section").first()),this.nextSegmentId=f.length?this.getSegmentId($(f)):0},getPercentuageClass:function(a){var b="";switch(m_parse=parseInt(a),isNaN(m_parse)||(a=m_parse),!0){case 100==a:b="per-green";break;case 101==a:b="per-blue";break;case a>0&&99>=a:b="per-orange";break;case"MT"==a:b="per-yellow";break;default:b=""}return b},getSegments:function(a){where=this.startSegmentId?"center":"after";var b=this.initSegNum;$("#outer").addClass("loading");var c=a.segmentToScroll?a.segmentToScroll:this.startSegmentId;APP.doRequest({data:{action:"getSegments",jid:config.job_id,password:config.password,step:b,segment:c,where:where},error:function(){UI.failedConnection(0,"getSegments")},success:function(b){"1"==$.cookie("tmpanel-open")&&UI.openLanguageResourcesPanel(),UI.getSegments_success(b,a)}})},getSegments_success:function(a,b){a.errors.length&&this.processErrors(a.errors,"getSegments"),where=a.data.where,$.each(a.data.files,function(){startSegmentId=this.segments[0].sid}),"undefined"==typeof this.startSegmentId&&(this.startSegmentId=startSegmentId),this.body.addClass("loaded"),"undefined"!=typeof a.data.files&&(this.renderFiles(a.data.files,where,this.firstLoad),!b.openCurrentSegmentAfter||b.segmentToScroll||b.segmentToOpen||(seg=UI.firstLoad?this.currentSegmentId:UI.startSegmentId,this.gotoSegment(seg)),b.segmentToScroll&&this.scrollSegment($("#segment-"+b.segmentToScroll)),b.segmentToOpen&&$("#segment-"+b.segmentToOpen+" .editarea").click(),$("#segment-"+UI.currentSegmentId).length&&!$("section.editor").length&&UI.openSegment(UI.editarea),"link2file"==b.caller&&UI.segmentIsLoaded(UI.currentSegmentId)&&UI.openSegment(UI.editarea),$("#segment-"+UI.startSegmentId).hasClass("readonly")&&this.scrollSegment($("#segment-"+UI.startSegmentId)),b.applySearch&&($("mark.currSearchItem").removeClass("currSearchItem"),this.markSearchResults(),"normal"==this.searchMode?$("#segment-"+b.segmentToScroll+" mark.searchMarker").first().addClass("currSearchItem"):$("#segment-"+b.segmentToScroll+" .editarea mark.searchMarker").first().addClass("currSearchItem"))),$("#outer").removeClass("loading loadingBefore"),b.highlight&&UI.highlightEditarea($("#segment-"+b.segmentToScroll)),this.loadingMore=!1,this.setWaypoints(),this.markTags(),this.checkPendingOperations()},getSegmentSource:function(a){return segment="undefined"==typeof a?this.currentSegment:a,$(".source",segment).text()},getStatus:function(a){return status=$(a).hasClass("status-new")?"new":$(a).hasClass("status-draft")?"draft":$(a).hasClass("status-translated")?"translated":$(a).hasClass("status-approved")?"approved":"rejected"},getSegmentTarget:function(a){return editarea="undefined"==typeof a?this.editarea:$(".editarea",a),editarea.text()},getUpdates:function(){UI.chunkedSegmentsLoaded()&&(lastUpdateRequested=UI.lastUpdateRequested,UI.lastUpdateRequested=new Date,APP.doRequest({data:{action:"getUpdatedTranslations",last_timestamp:lastUpdateRequested.getTime(),first_segment:UI.getSegmentId($("section").first()),last_segment:UI.getSegmentId($("section").last())},error:function(){UI.failedConnection(0,"getUpdatedTranslations")},success:function(a){UI.lastUpdateRequested=new Date,UI.updateSegments(a.data)}})),setTimeout(function(){UI.getUpdates()},UI.checkUpdatesEvery)},updateSegments:function(a){$.each(a,function(){seg=$("#segment-"+this.sid),$(".editarea, .area",seg).text(this.translation),status="DRAFT"==this.status?"draft":"TRANSLATED"==this.status?"translated":"APPROVED"==this.status?"approved":"REJECTED"==this.status?"rejected":"",UI.setStatus(seg,status)})},test:function(a){console.log("params: ",a),console.log("giusto")},gotoNextSegment:function(){var a=$(".editor").next();a.is("section")?(this.scrollSegment(a),$(".editarea",a).trigger("click","moving")):(a=this.currentFile.next().find("section:first"),console.log("next: ",a),a.length&&(this.scrollSegment(a),$(".editarea",a).trigger("click","moving")))},gotoNextUntranslatedSegment:function(){console.log("gotoNextUntranslatedSegment"),UI.segmentIsLoaded(UI.nextUntranslatedSegmentId)?$("#segment-"+UI.nextUntranslatedSegmentId+" .editarea").trigger("click"):UI.nextUntranslatedSegmentId?UI.reloadWarning():UI.closeSegment(UI.currentSegment)},gotoOpenSegment:function(a){a=a||!1,$("#segment-"+this.currentSegmentId).length?this.scrollSegment(this.currentSegment,!1,a):($("#outer").empty(),this.render({firstLoad:!1,segmentToOpen:this.currentSegmentId})),$(window).trigger({type:"scrolledToOpenSegment",segment:this.currentSegment})},gotoPreviousSegment:function(){var a=$(".editor").prev();a.is("section")?$(".editarea",a).click():(a=$(".editor").parents("article").prev().find("section:last"),a.length?$(".editarea",a).click():this.topReached()),a.length&&this.scrollSegment(a)},gotoSegment:function(a){!this.segmentIsLoaded(a)&&a.toString().split("-").length>1&&(a=a.toString().split("-")[0]);var b=$("#segment-"+a+"-target").find(".editarea");$(b).click()},initSegmentNavBar:function(){1==config.firstSegmentOfFiles.length&&$("#segmentNavBar .prevfile, #segmentNavBar .nextfile").addClass("disabled")},justSelecting:function(a){if(window.getSelection().isCollapsed)return!1;var b=$(window.getSelection().getRangeAt(0).startContainer.parentNode);return console.log(b),"editarea"==a?b.hasClass("editarea")&&!b.is(UI.editarea):"readonly"==a?b.hasClass("area")||b.hasClass("source"):void 0},millisecondsToTime:function(a){var b=Math.round(a/1e3%60),c=Math.floor(a/6e4%60);return[c,b]},closeContextMenu:function(){$("#contextMenu").hide(),$("#spellCheck .words").remove()},openSegment:function(a,b){segment_id=$(a).attr("data-sid");var c=$("#segment-"+segment_id);
if(UI.openableSegment=!0,c.trigger("just-open"),!UI.openableSegment)return!1;if(UI.openableSegment=!1,this.openSegmentStart=new Date,UI.warningStopped&&(UI.warningStopped=!1,UI.checkWarnings(!1)),this.byButton||!this.justSelecting("editarea")){this.numOpenedSegments++,this.firstOpenedSegment=0===this.firstOpenedSegment?1:2,this.byButton=!1,this.cacheObjects(a),this.updateJobMenu(),$(window).trigger({type:"segmentOpened",segment:c}),this.clearUndoStack(),this.saveInUndoStack("open"),this.autoSave=!0;var d=$("#segment-"+this.lastTranslatedSegmentId+" .source").text(),e=$(".source",c).text(),f=lev(d,e)/Math.max(d.length,e.length)*100>50,g=d==e;if(getNormally=f||g,this.activateSegment(getNormally),c.trigger("open"),$("section").first().nextAll(".undoCursorPlaceholder").remove(),this.getNextSegment(this.currentSegment,"untranslated"),this.readonly||getNormally||$("#segment-"+segment_id+" .alternatives .overflow").hide(),this.setCurrentSegment(),this.readonly||(getNormally?this.getContribution(c,0):(console.log("riprova dopo 3 secondi"),$(c).removeClass("loaded"),$(".loader",c).addClass("loader_on"),setTimeout(function(){$(".alternatives .overflow",c).show(),UI.getContribution(c,0)},3e3))),this.currentSegment.addClass("opened"),this.currentSegment.attr("data-searchItems",$("mark.searchMarker",this.editarea).length),this.fillCurrentSegmentWarnings(this.globalWarnings,!0),this.setNextWarnedSegment(),this.focusEditarea=setTimeout(function(){UI.editarea.focus(),clearTimeout(UI.focusEditarea)},100),this.currentIsLoaded=!1,this.nextIsLoaded=!1,this.noGlossary||this.getGlossary(c,!0,0),this.opening=!0,!this.currentSegment.is(this.lastOpenedSegment)){var h=$(this.lastOpenedSegment).attr("id");h!="segment-"+this.currentSegmentId&&this.closeSegment(this.lastOpenedSegment,0,b),this.lastOpenedSegment}this.opening=!1,this.body.addClass("editing"),c.addClass("editor"),this.readonly||this.editarea.attr("contenteditable","true"),this.editStart=new Date,$(a).removeClass("indent"),this.lockTags(),this.readonly||(this.getContribution(c,1),this.getContribution(c,2),this.noGlossary||this.getGlossary(c,!0,1),this.noGlossary||this.getGlossary(c,!0,2)),this.debug&&console.log("close/open time: "+(new Date-this.openSegmentStart))}},reactivateJob:function(){APP.doRequest({data:{action:"changeJobsStatus",new_status:"active",res:"job",id:config.job_id,password:config.password},success:function(a){"OK"==a.data&&setTimeout(function(){location.reload(!0)},300)}})},placeCaretAtEnd:function(a){if($(a).focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();b.selectNodeContents(a),b.collapse(!1);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}},registerQACheck:function(){clearTimeout(UI.pendingQACheck),UI.pendingQACheck=setTimeout(function(){UI.currentSegmentQA()},config.segmentQACheckInterval)},reloadToSegment:function(a){this.infiniteScroll=!1,config.last_opened_segment=a,window.location.hash=a,$("#outer").empty(),this.render({firstLoad:!1})},renderUntranslatedOutOfView:function(){this.infiniteScroll=!1,config.last_opened_segment=this.nextUntranslatedSegmentId,window.location.hash=this.nextUntranslatedSegmentId,$("#outer").empty(),this.render({firstLoad:!1})},reloadWarning:function(){this.renderUntranslatedOutOfView()},pointBackToSegment:function(a){this.infiniteScroll&&(""===a?(this.startSegmentId=config.last_opened_segment,$("#outer").empty(),this.render({firstLoad:!1})):($("#outer").empty(),this.render({firstLoad:!1})))},pointToOpenSegment:function(a){a=a||!1,this.gotoOpenSegment(a)},removeButtons:function(a){var b=a?this.currentSegment:this.lastOpenedSegment;$("#"+b.attr("id")+"-buttons").empty(),$("p.warnings",b).remove()},removeFooter:function(a){var b=a?this.currentSegment:this.lastOpenedSegment;$("#"+b.attr("id")+" .footer").empty()},removeHeader:function(a){var b=a?this.currentSegment:this.lastOpenedSegment;$("#"+b.attr("id")+"-header").empty()},removeStatusMenu:function(a){a.empty().hide()},renderFiles:function(a,b,c){$.each(a,function(a){var c="",d=a,e="center"!=b&&$("#file-"+d).length?!1:!0;e&&(filenametoshow=truncate_filename(this.filename,40),c+='<article id="file-'+d+'" class="loading">	<ul class="projectbar" data-job="job-'+this.jid+'">		<li class="filename">			<form class="download" action="/" method="post">				<input type=hidden name="action" value="downloadFile">				<input type=hidden name="id_job" value="'+this.jid+'">				<input type=hidden name="id_file" value="'+d+'">				<input type=hidden name="filename" value="'+this.filename+'">				<input type=hidden name="password" value="'+config.password+'">				<!--input title="Download file" type="submit" value="" class="downloadfile" id="file-'+d+'-download" -->			</form>			<h2 title="'+this.filename+'">'+filenametoshow+'</div>		</li>		<li style="text-align:center;text-indent:-20px">			<strong>'+this.source+'</strong> [<span class="source-lang">'+this.source_code+"</span>]&nbsp;>&nbsp;<strong>"+this.target+'</strong> [<span class="target-lang">'+this.target_code+'</span>]		</li>		<li class="wordcounter">			Payable Words: <strong>'+config.fileCounter[d].TOTAL_FORMATTED+"</strong>		</li>	</ul>"),newSegments=UI.renderSegments(this.segments,!1),c+=newSegments,e&&(c+="</article>"),e?"before"==b?("undefined"!=typeof lastArticleAdded?$("#file-"+d).after(c):$("article").first().before(c),lastArticleAdded=d):"after"==b?$("article").last().after(c):"center"==b&&$("#outer").append(c):"before"==b?$("#file-"+d).prepend(c):"after"==b&&$("#file-"+d).append(c)}),c&&this.init()},getSegmentMarkup:function(a,b,c,d,e,f,g,h){return g=a.split_group||g||"",splitPositionClass=a.sid==g[0]?" splitStart":a.sid==g[g.length-1]?" splitEnd":g.length?" splitInner":"",newSegmentMarkup='<section id="segment-'+a.sid+'" data-hash="'+a.segment_hash+'" data-autopropagated="'+d+'" data-version="'+a.version+'" class="'+(c?"readonly ":"")+"status-"+(a.status?a.status.toLowerCase():"new")+("true"==a.has_reference?" has-reference":"")+splitPositionClass+'" data-split-group="'+(g.length?g.toString():"")+'" data-split-original-id="'+h+'" data-tagmode="crunched">	<a tabindex="-1" href="#'+a.sid+'"></a>	<div class="sid" title="'+a.sid+'"><div class="txt">'+UI.shortenId(a.sid)+'</div><div class="actions"><a class="split" href="#"><span class="icon-split"></span></a><p class="split-shortcut">CTRL + S</p></div></div>'+(a.sid==config.first_job_segment?'	<span class="start-job-marker"></span>':"")+(a.sid==config.last_job_segment?'	<span class="end-job-marker"></span>':"")+'	<div class="body">		<div class="header toggle" id="segment-'+a.sid+'-header">		</div>		<div class="text">			<div class="wrap">				<div class="outersource"><div class="source item" tabindex="0" id="segment-'+a.sid+'-source" data-original="'+e+'">'+UI.decodePlaceholdersToText(a.segment,!0,a.sid,"source")+'</div>				<div class="copy" title="Copy source to target">                   <a href="#"></a>                   <p>ALT+CTRL+I</p>				</div>				<div class="target item" id="segment-'+a.sid+'-target">					<span class="hide toggle"> 						<!-- a href="#" class="warning normalTip exampleTip" title="Warning: as">!</a -->					</span>					<div class="textarea-container">						<span class="loader"></span>						<div class="'+(c?"area":"editarea")+' targetarea invisible" '+(c?"":'contenteditable="false" ')+'spellcheck="true" lang="'+config.target_lang.toLowerCase()+'" id="segment-'+a.sid+'-editarea" data-sid="'+a.sid+'">'+(a.translation?UI.decodePlaceholdersToText(a.translation,!0,a.sid,"translation"):"")+'</div>                       <div class="toolbar">'+(UI.tagModesEnabled?'                           <a href="#" class="tagModeToggle"><span class="icon-chevron-left"></span><span class="icon-tag-expand"></span><span class="icon-chevron-right"></a>':"")+'                           <ul class="editToolbar">                               <li class="uppercase" title="Uppercase"></li>                               <li class="lowercase" title="Lowercase"></li>                               <li class="capitalize" title="Capitalized"></li>                           </ul>                       </div>						<p class="save-warning" title="Segment modified but not saved"></p>					</div> <!-- .textarea-container -->						<ul class="buttons toggle" id="segment-'+a.sid+'-buttons"></ul>				</div> <!-- .target -->			</div></div> <!-- .wrap -->			<div class="status-container">				<a href=# title="'+(a.status?a.status.toLowerCase()+", click to change it":"Change segment status")+'" class="status" id="segment-'+a.sid+'-changestatus"></a>			</div> <!-- .status-container -->		</div> <!-- .text -->		<div class="timetoedit" data-raw_time_to_edit="'+a.time_to_edit+'">'+(b?"			<span class=edit-min>"+a.parsed_time_to_edit[1]+"</span>m:":"")+(b?"			<span class=edit-sec>"+a.parsed_time_to_edit[2]+"</span>s":"")+'		</div>		<div class="footer toggle"></div> <!-- .footer -->     	</div> <!-- .body -->	<ul class="statusmenu"></ul></section> '},stripSpans:function(a){return a.replace(/<span(.*?)>/gi,"").replace(/<\/span>/gi,"")},normalizeSplittedSegments:function(a){return newSegments=[],$.each(a,function(){splittedSourceAr=this.segment.split(UI.splittedTranslationPlaceholder),splittedSourceAr.length>1?(segment=this,splitGroup=[],$.each(splittedSourceAr,function(a){splitGroup.push(segment.sid+"-"+(a+1))}),$.each(splittedSourceAr,function(a){translation=segment.translation.split(UI.splittedTranslationPlaceholder)[a],status=segment.target_chunk_lengths.statuses[a],console.log("vediamo status: ",status),segData={autopropagated_from:"0",has_reference:"false",parsed_time_to_edit:["00","00","00","00"],readonly:"false",segment:splittedSourceAr[a],segment_hash:segment.segment_hash,sid:segment.sid+"-"+(a+1),split_group:splitGroup,split_points_source:[],status:status,time_to_edit:"0",translation:translation,version:segment.version,warning:"0"},newSegments.push(segData),segData=null})):newSegments.push(this)}),newSegments},renderSegments:function(a,b,c,d){a=this.normalizeSplittedSegments(a),c=c||[],d=d||[];var e=config.time_to_edit_enabled;return newSegments="",$.each(a,function(){var a="true"==this.readonly||UI.body.hasClass("archived")?!0:!1,f=0!=this.autopropagated_from;"object"==typeof this.segment&&console.log(this);try{$.parseHTML(this.segment).length&&(this.segment=UI.stripSpans(this.segment))}catch(g){}var h=htmlEncode(this.segment.replace(/\"/g,"&quot;"));h=h.replace(config.lfPlaceholderRegex,"\n"),h=h.replace(config.crPlaceholderRegex,"\r"),h=h.replace(config.crlfPlaceholderRegex,"\r\n"),originalId=this.sid.split("-")[0],("undefined"==typeof this.split_points_source||!this.split_points_source.length||b)&&(newSegments+=UI.getSegmentMarkup(this,e,a,f,h,c,d,originalId,0))}),newSegments},saveSegment:function(a){var b=a.hasClass("status-translated")?"translated":a.hasClass("status-approved")?"approved":a.hasClass("status-rejected")?"rejected":a.hasClass("status-new")?"new":"draft";"new"==b&&(b="draft"),console.log("SAVE SEGMENT"),this.setTranslation(this.getSegmentId(a),b,"autosave"),a.addClass("saved")},renderAndScrollToSegment:function(a){$("#outer").empty(),this.render({firstLoad:!1,caller:"link2file",segmentToScroll:a,scrollToFile:!0})},scrollSegment:function(a,b,c){c=c||!1,b=b||!1,a.length||($("#outer").empty(),this.render({firstLoad:!1,segmentToScroll:a.selector.split("-")[1],highlight:b}));var d=23,e=this.currentSegment,f=$(a).prev("section");if(f.length||(f=$(a),d=103),!f.length)return!1;var g="#"+f.attr("id"),h=$(g).offset().top;if(this.firstScroll&&(h+=100,this.firstScroll=!1),$(e).length)if($(a).offset().top>$(e).offset().top)if(e.is($(a).prev()))console.log("b"),h-=d;else{var i=this.firstLoad?$(e).height()-200+120:20;console.log("a"),h-=i}else h-=d,UI.provaCoso=!0;else console.log("d"),h-=d;$("html,body").stop(),pointSpeed=c?0:500,config.isReview?setTimeout(function(){$("html,body").animate({scrollTop:a.prev().offset().top-$(".header-menu").height()},500)},300):$("html,body").animate({scrollTop:h-20},pointSpeed),setTimeout(function(){UI.goingToNext=!1},pointSpeed)},segmentIsLoaded:function(a){return $("#segment-"+a).length?!0:!1},spellCheck:function(a){return UI.customSpellcheck?(editarea="undefined"==typeof a?UI.editarea:$(a),"block"==$("#contextMenu").css("display")?!0:void APP.doRequest({data:{action:"getSpellcheck",lang:config.target_rfc,sentence:UI.editarea.text()},context:editarea,error:function(){UI.failedConnection(0,"getSpellcheck")},success:function(b){a=this,$.each(b.result,function(b,c){var d=Object.keys(c)[0];replacements=c[d].misses.join(",");var e=new RegExp("(\\b"+d+"\\b)","gi");$(a).html($(a).html().replace(e,'<span class="misspelled" data-replacements="'+replacements+'">$1</span>')),$(a).html($(a).html().replace(/(<span class=\"misspelled\" data-replacements=\"(.*?)\"\>)(<span class=\"misspelled\" data-replacements=\"(.*?)\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"))})}})):!1},addWord:function(a){APP.doRequest({data:{action:"setSpellcheck",slang:config.target_rfc,word:a}})},setCurrentSegment:function(a){reqArguments=arguments;var b=this.currentSegmentId;a?(b=0,UI.currentSegment=void 0):setTimeout(function(){window.location.hash=UI.currentSegmentId},300),this.readonly||APP.doRequest({data:{action:"setCurrentSegment",password:config.password,id_segment:b.toString(),id_job:config.job_id},context:[reqArguments,b],error:function(){UI.failedConnection(this[0],"setCurrentSegment")},success:function(a){UI.setCurrentSegment_success(this[1],a)}})},setCurrentSegment_success:function(a,b){b.errors.length&&this.processErrors(b.errors,"setCurrentSegment"),this.nextUntranslatedSegmentIdByServer=b.nextSegmentId,this.propagationsAvailable=b.data.prop_available,this.getNextSegment(this.currentSegment,"untranslated"),config.alternativesEnabled&&this.getTranslationMismatches(a),$("html").trigger("setCurrentSegment_success",b)},getTranslationMismatches:function(a){APP.doRequest({data:{action:"getTranslationMismatches",password:config.password,id_segment:a.toString(),id_job:config.job_id},context:a,error:function(){UI.failedConnection(this,"getTranslationMismatches")},success:function(a){a.errors.length?UI.processErrors(a.errors,"setTranslation"):UI.detectTranslationAlternatives(a)}})},detectTranslationAlternatives:function(a){console.log("ecco"),sameContentIndex=-1,$.each(a.data.editable,function(a){this.translation==UI.postProcessEditarea(UI.currentSegment).replace(/[ \xA0]+$/,"")&&(sameContentIndex=a)}),-1!=sameContentIndex&&a.data.editable.splice(sameContentIndex,1),sameContentIndex1=-1,$.each(a.data.not_editable,function(a){this.translation==UI.postProcessEditarea(UI.currentSegment).replace(/[ \xA0]+$/,"")&&(sameContentIndex1=a)}),-1!=sameContentIndex1&&a.data.not_editable.splice(sameContentIndex1,1),numAlt=a.data.editable.length+a.data.not_editable.length,numSeg=0,$.each(a.data.editable,function(){numSeg+=this.involved_id.length}),numAlt&&(tab=UI.currentSegment.find(".tab-switcher-al"),tab.find(".number").text("("+numAlt+")"),UI.renderAlternatives(a),tab.show())},renderAlternatives:function(a){console.log("renderAlternatives d: ",a),segment=UI.currentSegment,segment_id=UI.currentSegmentId,escapedSegment=UI.decodePlaceholdersToText(UI.currentSegment.find(".source").html(),!1,segment_id,"render alternatives"),console.log("escapedSegment: ",escapedSegment),mainStr=UI.currentSegment.find(".editarea").text(),$.each(a.data.editable,function(a){console.log("this.translation: ",this.translation),diff_obj=UI.execDiff(mainStr,this.translation),$(".sub-editor.alternatives .overflow",segment).append('<ul class="graysmall" data-item="'+(a+1)+'"><li class="sugg-source"><span id="'+segment_id+"-tm-"+this.id+'-source" class="suggestion_source">'+escapedSegment+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span class="graysmall-message">CTRL+'+(a+1)+'</span><span class="translation">'+UI.dmp.diff_prettyHtml(diff_obj)+'</span><span class="realData hide">'+this.translation+'</span></li><li class="goto"><a href="#" data-goto="'+this.involved_id[0]+'">View</a></li></ul>')}),$.each(a.data.not_editable,function(b){diff_obj=UI.execDiff(mainStr,this.translation),$(".sub-editor.alternatives .overflow",segment).append('<ul class="graysmall notEditable" data-item="'+(b+a.data.editable.length+1)+'"><li class="sugg-source"><span id="'+segment_id+"-tm-"+this.id+'-source" class="suggestion_source">'+escapedSegment+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span class="graysmall-message">CTRL+'+(b+a.data.editable.length+1)+'</span><span class="translation">'+UI.dmp.diff_prettyHtml(diff_obj)+'</span><span class="realData hide">'+this.translation+'</span></li><li class="goto"><a href="#" data-goto="'+this.involved_id[0]+'">View</a></li></ul>')})},execDiff:function(a,b){return _str=b.replace(config.lfPlaceholderRegex,"\n").replace(config.crPlaceholderRegex,"\r").replace(config.crlfPlaceholderRegex,"\r\n").replace(config.tabPlaceholderRegex,"	").replace(config.nbspPlaceholderRegex,String.fromCharCode(parseInt(160,10))),_edit=a.replace(String.fromCharCode(parseInt(8677,10)),"	"),_str=String.fromCharCode(parseInt(8203,10))+_str+String.fromCharCode(parseInt(8203,10)),_edit=String.fromCharCode(parseInt(8203,10))+_edit+String.fromCharCode(parseInt(8203,10)),diff_obj=UI.dmp.diff_main(_edit,_str),UI.dmp.diff_cleanupEfficiency(diff_obj),diff_obj},chooseAlternative:function(a){console.log("chooseAlternative"),this.copyAlternativeInEditarea(UI.decodePlaceholdersToText($(".sugg-target .realData",a).text(),!0,UI.currentSegmentId,"choose alternative")),this.lockTags(this.editarea),this.editarea.focus(),this.highlightEditarea()},copyAlternativeInEditarea:function(a){console.log("translation: ",a),""!==$.trim(a)&&(this.body.hasClass("searchActive")&&this.addWarningToSearchDisplay(),this.saveInUndoStack("copyalternative"),$(UI.editarea).html(a).addClass("fromAlternative"),this.saveInUndoStack("copyalternative"))},setDownloadStatus:function(a){var b="approved",c=parseFloat(a.APPROVED),d=parseFloat(a.TRANSLATED),e=parseFloat(a.DRAFT),f=parseFloat(a.REJECTED);d&&(b="translated"),e&&(b="draft"),f&&(b="draft"),d||e||f||c||(b="draft"),$(".downloadtr-button").removeClass("draft translated approved").addClass(b);var g="translated"==b||"approved"==b?"DOWNLOAD TRANSLATION":"PREVIEW",h="translated"==b||"approved"==b?"true":"false";$("#downloadProject").attr("value",g),$("#previewDropdown").attr("data-download",h)},setProgress:function(a){var b=a;m=$("footer .meter"),b.ANALYSIS_COMPLETE?($("#statistics").show(),$("#analyzing").hide()):($("#statistics").hide(),$("#analyzing").show());var c=b.TRANSLATED_PERC,d=b.APPROVED_PERC,e=b.DRAFT_PERC,f=b.REJECTED_PERC,g=b.TRANSLATED_PERC_FORMATTED,h=b.APPROVED_PERC_FORMATTED,i=b.DRAFT_PERC_FORMATTED,j=b.REJECTED_PERC_FORMATTED,k=b.TODO_FORMATTED,l=b.WORDS_PER_HOUR,n=b.ESTIMATED_COMPLETION;"undefined"==typeof l?$("#stat-wph").hide():$("#stat-wph").show(),"undefined"==typeof n?$("#stat-completion").hide():$("#stat-completion").show(),this.progress_perc=b.PROGRESS_PERC_FORMATTED,this.checkIfFinished(),this.done_percentage=this.progress_perc,$(".approved-bar",m).css("width",d+"%").attr("title","Approved "+h+"%"),$(".translated-bar",m).css("width",c+"%").attr("title","Translated "+g+"%"),$(".draft-bar",m).css("width",e+"%").attr("title","Draft "+i+"%"),$(".rejected-bar",m).css("width",f+"%").attr("title","Rejected "+j+"%"),$("#stat-progress").html(this.progress_perc),$("#stat-todo strong").html(k),$("#stat-wph strong").html(l),$("#stat-completion strong").html(n),$("#total-payable").html(b.TOTAL_FORMATTED)},chunkedSegmentsLoaded:function(){return $("section.readonly").length},showEditToolbar:function(){$(".editor .editToolbar").addClass("visible")},hideEditToolbar:function(){$(".editor .editToolbar").removeClass("visible")},formatSelection:function(a){selection=window.getSelection(),range=selection.getRangeAt(0),prova=$(range.commonAncestorContainer).text().charAt(range.startOffset-1),str=getSelectionHtml(),insertHtmlAfterSelection('<span class="formatSelection-placeholder"></span>'),b=prova.match(/\W$/gi),newStr="";var b=$("<div/>").html(str);b.find(".undoCursorPlaceholder").remove();var c=b.html();$.each($.parseHTML(c),function(c){"#text"==this.nodeName?(d=this.data,jump=!c&&!b,capStr=toTitleCase(d),jump&&(capStr=d.charAt(0)+toTitleCase(d).slice(1)),toAdd="uppercase"==a?d.toUpperCase():"lowercase"==a?d.toLowerCase():"capitalize"==a?capStr:d,newStr+=toAdd):newStr+=this.outerHTML}),console.log("x"),replaceSelectedHtml(newStr),console.log("a: ",UI.editarea.html()),UI.lockTags(),console.log("b: ",UI.editarea.html()),this.saveInUndoStack("formatSelection"),saveSelection(),$(".editor .editarea .formatSelection-placeholder").after($(".editor .editarea .rangySelectionBoundary")),$(".editor .editarea .formatSelection-placeholder").remove(),$(".editor .editarea").trigger("afterFormatSelection")},setStatus:function(a,b){console.log("setStatus - segment: ",a),console.log("setStatus - status: ",b),a.removeClass("status-draft status-translated status-approved status-rejected status-new").addClass("status-"+b)},setStatusButtons:function(a){isTranslatedButton=$(a).hasClass("translated")?!0:!1,this.editStop=new Date;var b=this.currentSegment;tte=$(".timetoedit",b),this.editTime=this.editStop-this.editStart,this.totalTime=this.editTime+tte.data("raw_time_to_edit");var c=this.millisecondsToTime(this.totalTime);if(config.time_to_edit_enabled){var d=$(".timetoedit .edit-sec",b),e=$(".timetoedit .edit-min",b);e.text(APP.zerofill(c[0],2)),d.text(APP.zerofill(c[1],2))}tte.data("raw_time_to_edit",this.totalTime);var f=$(".status",b);f.removeClass("col-approved col-rejected col-done col-draft");var g=$("#segment-"+this.nextUntranslatedSegmentId);return this.nextUntranslatedSegment=g,isTranslatedButton||g.length?(this.buttonClickStop=new Date,this.copyToNextIfSame(g),void(this.byButton=!0)):($(".editor:visible").find(".close").trigger("click","Save"),$(".downloadtr-button").focus(),!1)},collectSegmentErrors:function(a){var b="";return a.hasClass("mismatch")&&(b+="01|"),b.substring(0,b.length-1)},goToFirstError:function(){location.href=$("#point2seg").attr("href")},continueDownload:function(){if(!$("#downloadProject").hasClass("disabled")){$("#downloadProject").addClass("disabled").data("oldValue",$("#downloadProject").val()).val("DOWNLOADING");var a=$(document.createElement("iframe")).hide().prop({id:"iframeDownload",src:""});$("body").append(a);var b=(new Date).getTime()+"_"+parseInt(1e7*Math.random(0,1));a.ready(function(){downloadTimer=window.setInterval(function(){var c=$.cookie(b);c==b&&($("#downloadProject").removeClass("disabled").val($("#downloadProject").data("oldValue")).removeData("oldValue"),window.clearInterval(downloadTimer),$.cookie(b,null,{path:"/",expires:-1}),a.remove())},2e3)});var c=$("#fileDownload").clone().append($(document.createElement("input")).prop({type:"hidden",name:"downloadToken",value:b}));a.contents().find("body").append(c),a.contents().find("#fileDownload").submit()}},setNextWarnedSegment:function(a){a=a||UI.currentSegmentId,idList=UI.globalWarnings,idList.sort(),found=!1,$.each(idList,function(){return this>a?($("#point2seg").attr("href","#"+this),found=!0,!1):void 0}),found||$("#point2seg").attr("href","#"+UI.firstWarnedSegment)},fillWarnings:function(a,b){var c=a.find("p.warnings").parent(),d=a.find("p.warnings");$.each(b,function(a,b){c.before(d).append('<p class="warnings">'+b.debug+"</p>")}),d.remove()},fillCurrentSegmentWarnings:function(a,b){b||UI.fillWarnings(UI.currentSegment,$.parseJSON(a.warnings))},compareArrays:function(a,b){return $.each(a,function(c,d){t=d,$.each(b,function(d,e){return t==e?(a.splice(c,1),b.splice(d,1),UI.compareArrays(a,b),!1):void 0})}),a},startWarning:function(){clearTimeout(UI.startWarningTimeout),UI.startWarningTimeout=setTimeout(function(){UI.checkWarnings(!1)},config.warningPollingInterval)},checkWarnings:function(a){var b=new Date;ts=b.getTime();var c="undefined"==typeof this.currentSegmentId?this.startSegmentId:this.currentSegmentId,d=c+"-"+ts.toString();dataMix={action:"getWarning",id_job:config.job_id,password:config.password,token:d},UI.logEnabled&&(dataMix.logs=this.extractLogs()),APP.doRequest({data:dataMix,error:function(){UI.warningStopped=!0,UI.failedConnection(0,"getWarning")},success:function(b){UI.startWarning();var c="";if(UI.globalWarnings=b.details.sort(),UI.firstWarnedSegment=UI.globalWarnings[0],UI.translationMismatches=b.translation_mismatches,UI.globalWarnings.length>0?(c="#"+b.details[Object.keys(b.details).sort().shift()].id_segment,a&&UI.fillCurrentSegmentWarnings(b.details,!0),$("#notifbox").attr("class","warningbox").attr("title","Click to see the segments with potential issues").find(".numbererror").text(UI.globalWarnings.length)):($("#notifbox").attr("class","notific").attr("title","Well done, no errors found!").find(".numbererror").text(""),$("#point2seg").attr("href","#")),"undefined"!=typeof b.messages){var d=$.parseJSON(b.messages);d.length>0&&UI.displayMessage(d)}UI.setNextWarnedSegment()}})},displayMessage:function(a){return $("body").hasClass("incomingMsg")?!1:void $.each(a,function(){return"undefined"==typeof $.cookie("msg-"+this.token)&&new Date(this.expire)>new Date?(UI.showMessage({msg:this.msg,token:this.token,showOnce:!0,expire:this.expire}),!1):void 0})},showMessage:function(a){APP.showMessage(a)},checkVersion:function(){this.version!=config.build_number&&UI.showMessage({msg:'A new version of MateCat has been released. Please <a href="#" class="reloadPage">click here</a> or clic CTRL+F5 (or CMD+R on Mac) to update.',token:!1,fixed:!0})},currentSegmentQA:function(){this.currentSegment.addClass("waiting_for_check_result");var a=new Date;ts=a.getTime();var b=this.currentSegmentId+"-"+ts.toString();config.brPlaceholdEnabled?(src_content=this.postProcessEditarea(this.currentSegment,".source"),trg_content=this.postProcessEditarea(this.currentSegment)):(src_content=this.getSegmentSource(),trg_content=this.getSegmentTarget()),this.checkSegmentsArray[b]=trg_content,APP.doRequest({data:{action:"getWarning",id:this.currentSegmentId,token:b,password:config.password,src_content:src_content,trg_content:trg_content},error:function(){UI.failedConnection(0,"getWarning")},success:function(a){if(UI.currentSegment.hasClass("waiting_for_check_result")){if(!a.total)return $("p.warnings",UI.currentSegment).empty(),$("span.locked.mismatch",UI.currentSegment).removeClass("mismatch"),void $(".editor .editarea .order-error").removeClass("order-error");UI.fillCurrentSegmentWarnings(a.details,!1),UI.markTagMismatch(a.details),delete UI.checkSegmentsArray[a.token],UI.currentSegment.removeClass("waiting_for_check_result")}}},"local")},setTranslation:function(a,b,c,d){alreadySet=this.alreadyInSetTranslationTail(a),emptyTranslation=$("#segment-"+a+" .editarea").text().trim().length?!1:!0,toSave=!alreadySet&&!emptyTranslation,toSave?this.addToSetTranslationTail(a,b,c,d=d||{}):this.updateToSetTranslationTail(a,b,c,d=d||{}),this.offline&&config.offlineModeEnabled?(toSave&&(this.decrementOfflineCacheRemaining(),this.failedConnection([a,b,!1],"setTranslation")),this.changeStatusOffline(a),this.checkConnection("Set Translation check Authorized")):this.executingSetTranslation||this.execSetTranslationTail()},alreadyInSetTranslationTail:function(a){return alreadySet=!1,$.each(UI.setTranslationTail,function(){this.id_segment==a&&(alreadySet=!0)}),alreadySet},changeStatusOffline:function(a){""!=$("#segment-"+a+" .editarea").text()&&$("#segment-"+a).removeClass("status-draft status-approved status-new status-rejected").addClass("status-translated")},addToSetTranslationTail:function(a,b,c,d){$("#segment-"+a).addClass("setTranslationPending");var e={id_segment:a,status:b,caller:c,callback:d};this.setTranslationTail.push(e)},updateToSetTranslationTail:function(a,b,c,d){$("#segment-"+a).addClass("setTranslationPending");$.each(UI.setTranslationTail,function(){this.id_segment==a&&(this.status=b,this.caller=c,this.callback=d)})},execSetTranslationTail:function(){UI.setTranslationTail.length&&(item=UI.setTranslationTail[0],UI.setTranslationTail.shift(),UI.execSetTranslation(item.id_segment,item.status,item.caller,item.callback))},execSetTranslation:function(a,b,c,d){this.executingSetTranslation=!0,reqArguments=arguments,segment=$("#segment-"+a),this.lastTranslatedSegmentId=a,c="undefined"==typeof c?!1:c;var e=$(segment).parents("article");if(translation=config.brPlaceholdEnabled?this.postProcessEditarea(segment):$(".editarea",segment).text(),""===translation)return this.unsavedSegmentsToRecover.push(this.currentSegmentId),!1;var f=UI.editTime,g=config.id_translator,h="";h=this.collectSegmentErrors(segment);var i=$(".editarea",segment).data("lastChosenSuggestion");autosave="autosave"==c?!0:!1,isSplitted=a.split("-").length>1?!0:!1,isSplitted&&(translation=this.collectSplittedTranslations(a)),this.tempReqArguments={id_segment:a,id_job:config.job_id,id_first_file:e.attr("id").split("-")[1],password:config.password,status:b,translation:translation,time_to_edit:f,id_translator:g,errors:h,chosen_suggestion_index:i,autosave:autosave,version:segment.attr("data-version")},isSplitted&&(this.tempReqArguments.splitStatuses=this.collectSplittedStatuses(a).toString(),this.setStatus($("#segment-"+a),"translated")),reqData=this.tempReqArguments,reqData.action="setTranslation",this.log("setTranslation",reqData),segment=$("#segment-"+a),APP.doRequest({data:reqData,context:[reqArguments,segment,b],error:function(){UI.addToSetTranslationTail(this[0][0],this[0][1],this[0][2]),UI.changeStatusOffline(this[0][0]),UI.failedConnection(this[0],"setTranslation"),UI.decrementOfflineCacheRemaining()},success:function(a){UI.executingSetTranslation=!1,UI.execSetTranslationTail(),UI.setTranslation_success(a,this[1],this[2],this[0][3])}}),"function"==typeof d&&d.call()},collectSplittedStatuses:function(a){return statuses=[],segmentsIds=$("#segment-"+a).attr("data-split-group").split(","),$.each(segmentsIds,function(){segment=$("#segment-"+this),status=this==a?"translated":UI.getStatus(segment),statuses.push(status)}),statuses},collectSplittedTranslations:function(a){return totalTranslation="",segmentsIds=$("#segment-"+a).attr("data-split-group").split(","),$.each(segmentsIds,function(a){segment=$("#segment-"+this),translation=UI.postProcessEditarea(segment),totalTranslation+=translation,a<segmentsIds.length-1&&(totalTranslation+=UI.splittedTranslationPlaceholder)}),totalTranslation},checkPendingOperations:function(){this.checkInStorage("pending")&&UI.execAbortedOperations()},addInStorage:function(a,b,c){if(this.isPrivateSafari)item={key:a,value:b},this.localStorageArray.push(item);else try{localStorage.setItem(a,b)}catch(d){UI.clearStorage(c),localStorage.setItem(a,b)}},getFromStorage:function(a){return this.isPrivateSafari?(foundVal=0,$.each(this.localStorageArray,function(){this.key==a&&(foundVal=this.value)}),foundVal||!1):localStorage.getItem(a)},removeFromStorage:function(a){this.isPrivateSafari?(foundVal=0,$.each(this.localStorageArray,function(b){this.key==a&&(foundIndex=b)}),this.localStorageArray.splice(foundIndex,1)):localStorage.removeItem(a)},isLocalStorageNameSupported:function(){var a="test",b=window.sessionStorage;try{return b.setItem(a,"1"),b.removeItem(a),!0}catch(c){return!1}},checkInStorage:function(a){var b=!1;return $.each(localStorage,function(c){c.substring(0,a.length)===a&&(b=!0)}),b},clearStorage:function(a){$.each(localStorage,function(b){b.substring(0,a.length)===a&&localStorage.removeItem(b)})},checkAddTMEnable:function(){console.log("checkAddTMEnable"),$("#addtm-tr-key").val().length>19&&UI.checkTMgrants($(".addtm-tr"))?$("#addtm-add").removeAttr("disabled").removeClass("disabled"):$("#addtm-add").attr("disabled","disabled").addClass("disabled")},checkManageTMEnable:function(){console.log($("#addtm-tr-key").val().length),$("#addtm-tr-key").val().length>19?($(".manageTM").removeClass("disabled"),$("#addtm-tr-read, #addtm-tr-write, #addtm-select-file").removeAttr("disabled")):($(".manageTM").addClass("disabled"),$("#addtm-tr-read, #addtm-tr-write, #addtm-select-file").attr("disabled","disabled"))
},clearAddTMpopup:function(){$("#addtm-tr-key").val(""),$(".addtm-select-file").val(""),$("#addtm-tr-read, #addtm-tr-write").prop("checked",!0),$("#uploadTMX").text("").hide(),$(".addtm-tr .error-message, .addtm-tr .warning-message").hide(),$(".manageTM").addClass("disabled"),$("#addtm-tr-read, #addtm-tr-write, #addtm-select-file").attr("disabled","disabled")},log:function(a,b){if(!UI.logEnabled)return!1;data=b;var c=new Date;logValue={data:data,stack:stackTrace()},UI.addInStorage("log-"+a+"-"+c.getTime(),JSON.stringify(logValue),"log")},extractLogs:function(){if(!this.isPrivateSafari){var a=[];return inp="log",$.each(localStorage,function(b,c){b.substring(0,inp.length)===inp&&a.push('{"operation": "'+b.split("-")[1]+'", "time": "'+b.split("-")[2]+'", "log":'+c+"}")}),logs=JSON.stringify(a),this.clearStorage("log"),logs}},postProcessEditarea:function(a,b){b="undefined"==typeof b?".editarea":b,area=$(b,a).clone();var c=$(area).find("div");return c.length?c.each(function(){$(this).find("br:not([class])").remove(),$(this).prepend($('<span class="placeholder">'+config.crPlaceholder+"</span>")).replaceWith($(this).html())}):($(area).find("br:not([class])").replaceWith($('<span class="placeholder">'+config.crPlaceholder+"</span>")),$(area).find("br."+config.crlfPlaceholderClass).replaceWith('<span class="placeholder">'+config.crlfPlaceholder+"</span>"),$(area).find("span."+config.lfPlaceholderClass).replaceWith('<span class="placeholder">'+config.lfPlaceholder+"</span>"),$(area).find("span."+config.crPlaceholderClass).replaceWith('<span class="placeholder">'+config.crPlaceholder+"</span>")),$(area).find("span."+config.tabPlaceholderClass).replaceWith(config.tabPlaceholder),$(area).find("span."+config.nbspPlaceholderClass).replaceWith(config.nbspPlaceholder),$(area).find("span.space-marker").replaceWith(" "),$(area).find("span.rangySelectionBoundary, span.undoCursorPlaceholder").remove(),$(area).text()},decodePlaceholdersToText:function(a,b){if(!UI.hiddenTextEnabled)return a;b=b||!1;var c=a;return UI.markSpacesEnabled&&b&&(c=this.encodeSpacesAsPlaceholders(htmlDecode(c),!0)),c=c.replace(config.lfPlaceholderRegex,'<span class="monad marker softReturn '+config.lfPlaceholderClass+'" contenteditable="false"><br /></span>').replace(config.crPlaceholderRegex,'<span class="monad marker '+config.crPlaceholderClass+'" contenteditable="false"><br /></span>').replace(config.crlfPlaceholderRegex,'<br class="'+config.crlfPlaceholderClass+'" />').replace(config.tabPlaceholderRegex,'<span class="tab-marker monad marker '+config.tabPlaceholderClass+'" contenteditable="false">&#8677;</span>').replace(config.nbspPlaceholderRegex,'<span class="nbsp-marker monad marker '+config.nbspPlaceholderClass+'" contenteditable="false">&nbsp;</span>')},encodeSpacesAsPlaceholders:function(a,b){if(!UI.hiddenTextEnabled)return a;var c="";return $.each($.parseHTML(a),function(){"#text"==this.nodeName?c+=$(this).text().replace(/\s/gi,'<span class="space-marker marker monad" contenteditable="false"> </span>'):(match=this.outerHTML.match(/<.*?>/gi),1==match.length||(c+=2==match.length?htmlEncode(match[0])+this.innerHTML.replace(/\s/gi,'#@-lt-@#span#@-space-@#class="space-marker#@-space-@#marker#@-space-@#monad"#@-space-@#contenteditable="false"#@-gt-@# #@-lt-@#/span#@-gt-@#')+htmlEncode(match[1]):htmlEncode(match[0])+UI.encodeSpacesAsPlaceholders(this.innerHTML)+htmlEncode(match[1],!1)))}),b&&(c=c.replace(/#@-lt-@#/gi,"<").replace(/#@-gt-@#/gi,">").replace(/#@-space-@#/gi," ")),c},unnestMarkers:function(){$(".editor .editarea .marker .marker").each(function(){$(this).parents(".marker").after($(this))})},processErrors:function(a,b){$.each(a,function(){"setTranslation"==b&&"-10"!=this.code&&APP.alert({msg:"Error in saving the translation. Try the following: <br />1) Refresh the page (Ctrl+F5 twice) <br />2) Clear the cache in the browser <br />If the solutions above does not resolve the issue, please stop the translation and report the problem to <b>support@matecat.com</b>"}),"setContribution"==b&&"-10"!=this.code&&UI.savingMemoryErrorNotificationEnabled&&APP.alert({msg:"Error in saving the segment to the translation memory.<br />Try refreshing the page and click on Translated again.<br />Contact <b>support@matecat.com</b> if this happens often."}),"-10"==this.code&&"getSegments"!=b&&APP.alert({msg:"Job canceled or assigned to another translator",callback:"reloadPage"}),"-1000"==this.code&&(console.log("ERROR -1000"),console.log("operation: ",b),UI.blockUIForNoConnection()),"-101"==this.code&&(console.log("ERROR -101"),UI.blockUIForNoConnection())})},reloadPage:function(){console.log("reloadPage"),UI.body.hasClass("cattool")&&location.reload()},someSegmentToSave:function(){return res=$("section.modified").length?!0:!1},setContextMenu:function(){var a=this.isMac?"&#x2325;":"Alt ",b=this.isMac?"&#8984;":"Ctrl ";$("#contextMenu .shortcut .alt").html(a),$("#contextMenu .shortcut .cmd").html(b)},setTranslation_success:function(a,b,c,d){a.errors.length&&this.processErrors(a.errors,"setTranslation"),"OK"==a.data&&(console.log("setTranslation_success - segment: ",b),this.setStatus(b,c),this.setDownloadStatus(a.stats),this.setProgress(a.stats),$(b).removeClass("setTranslationPending"),this.checkWarnings(!1),$(b).attr("data-version",a.version),d||this.beforePropagateTranslation(b,c)),this.resetRecoverUnsavedSegmentsTimer()},recoverUnsavedSetTranslations:function(){$.each(UI.unsavedSegmentsToRecover,function(a){""===$("#segment-"+this+" .editarea").text()?UI.resetRecoverUnsavedSegmentsTimer():(UI.setTranslation(this.toString(),"translated"),UI.unsavedSegmentsToRecover.splice(a,1))})},resetRecoverUnsavedSegmentsTimer:function(){clearTimeout(this.recoverUnsavedSegmentsTimer),this.recoverUnsavedSegmentsTimer=setTimeout(function(){UI.recoverUnsavedSetTranslations()},1e3)},beforePropagateTranslation:function(a,b){return $(a).attr("id").split("-").length>2?!1:void UI.propagateTranslation(a,b,!1)},propagateTranslation:function(a,b,c){this.tempReqArguments=null,"translated"==b&&(plusTranslated=c?", section[data-hash="+$(a).attr("data-hash")+"].status-translated":"",$.each($("section[data-hash="+$(a).attr("data-hash")+"].status-new, section[data-hash="+$(a).attr("data-hash")+"].status-draft, section[data-hash="+$(a).attr("data-hash")+"].status-rejected"+plusTranslated).not(a),function(){$(".editarea",this).html($(".editarea",a).html()),UI.setStatus($(this),"draft"),$(this).data("autopropagated",!0)}),$(a).data("autopropagated",!1),this.createHeader(!0))},doPropagate:function(a){reqData=this.tempReqArguments,reqData.action="setAutoPropagation",reqData.propagateAll=a,this.tempReqArguments=null,APP.doRequest({data:reqData,context:[reqData,a],error:function(){},success:function(){console.log("success setAutoPropagation"),UI.propagateTranslation($("#segment-"+this[0].id_segment),this[0].status,this[1])}})},setWaypoints:function(){this.firstSegment.waypoint("remove"),this.lastSegment.waypoint("remove"),this.detectFirstLast(),this.lastSegment.waypoint(function(a,b){"down"===b&&(UI.lastSegment.waypoint("remove"),UI.infiniteScroll&&(UI.blockGetMoreSegments||(UI.blockGetMoreSegments=!0,UI.getMoreSegments("after"),setTimeout(function(){UI.blockGetMoreSegments=!1},1e3))))},UI.downOpts),this.firstSegment.waypoint(function(a,b){"up"===b&&(UI.firstSegment.waypoint("remove"),UI.getMoreSegments("before"))},UI.upOpts)},showContextMenu:function(a,b,c){$("#contextMenu").width()+c>$(window).width()&&(c=$(window).width()-$("#contextMenu").width()-30),$("#contextMenu").css({top:b+13+"px",left:c+"px"}).show()},storeClientInfo:function(){clientInfo={xRes:window.screen.availWidth,yRes:window.screen.availHeight},$.cookie("client_info",JSON.stringify(clientInfo),{expires:3650})},topReached:function(){},browserScrollPositionRestoreCorrection:function(){1==this.firstOpenedSegment&&($(".editor").isOnScreen()||this.autoscrollCorrectionEnabled&&(this.scrollSegment(this.currentSegment),this.autoscrollCorrectionEnabled=!1))},undoInSegment:function(){console.log("undoInSegment"),0===this.undoStackPosition&&this.saveInUndoStack("undo");var a=0;this.undoStack[this.undoStack.length-1-this.undoStackPosition-1]&&(a=this.undoStack.length-1-this.undoStackPosition-1),this.editarea.html(this.undoStack[a]),console.log("vediamo: ",document.getElementsByClassName("undoCursorPlaceholder")[0]),setCursorPosition(document.getElementsByClassName("undoCursorPlaceholder")[0]),$(".undoCursorPlaceholder").remove(),a||this.lockTags(),this.undoStackPosition<this.undoStack.length-1&&this.undoStackPosition++,this.currentSegment.removeClass("waiting_for_check_result"),this.registerQACheck()},redoInSegment:function(){this.editarea.html(this.undoStack[this.undoStack.length-1-this.undoStackPosition-1+2]),this.undoStackPosition>0&&this.undoStackPosition--,this.currentSegment.removeClass("waiting_for_check_result"),this.registerQACheck()},saveInUndoStack:function(){if(currentItem=this.undoStack[this.undoStack.length-1-this.undoStackPosition],("undefined"==typeof currentItem||currentItem.trim()!=this.editarea.html().trim())&&""!==this.editarea&&""!==this.editarea.html()){var a=this.editarea.html().match(/<span.*?contenteditable\="false".*?\>/gi),b=this.editarea.html().match(/&lt;/gi);if(!b||!b.length||a){var c="undefined"==typeof currentItem?"null":this.dmp.diff_main(currentItem,this.editarea.html())[1][1];if(" selected"!=c){var d=this.undoStackPosition;d>0&&(this.undoStack.splice(this.undoStack.length-d,d),this.undoStackPosition=0),saveSelection(),$(".undoCursorPlaceholder").remove(),$(".rangySelectionBoundary").after('<span class="undoCursorPlaceholder monad" contenteditable="false"></span>'),restoreSelection(),this.undoStack.push(this.editarea.html().replace(/(<.*?)\s?selected\s?(.*?\>)/gi,"$1$2"))}}}},clearUndoStack:function(){this.undoStack=[]},updateJobMenu:function(){$("#jobMenu li.current").removeClass("current"),$("#jobMenu li:not(.currSegment)").each(function(){$(this).attr("data-file")==UI.currentFileId&&$(this).addClass("current")}),$("#jobMenu li.currSegment").attr("data-segment",UI.currentSegmentId)},findCommonPartInSegmentIds:function(){var a=config.first_job_segment,b=config.last_job_segment;for(x=0;x<a.length;x++)if(a[x]!=b[x]){n=x;break}"undefined"==typeof n&&(n=a.length-1),this.commonPartInSegmentIds=a.substring(0,n)},shortenId:function(a){return a.replace(UI.commonPartInSegmentIds,'<span class="implicit">'+UI.commonPartInSegmentIds+"</span>")},isCJK:function(){var a=config.target_rfc;return"zh-CN"==a||"zh-TW"==a||"ja-JP"==a||"ko-KR"==a?!0:!1},isKorean:function(){var a=config.target_rfc;return"ko-KR"==a?!0:!1},start:function(){APP.init(),APP.fitText($(".breadcrumbs"),$("#pname"),30),setBrowserHistoryBehavior(),$("article").each(function(){APP.fitText($(".filename h2",$(this)),$(".filename h2",$(this)),30)}),UI.render({firstLoad:!0}),UI.checkWarnings(!0),$("html").trigger("start")},restart:function(){$("#outer").empty(),this.start()}},$(document).ready(function(){UI.start()}),$(window).resize(function(){UI.fixHeaderHeightChange(),APP.fitText($(".breadcrumbs"),$("#pname"),30)}),$.extend(UI,{init:function(){this.initStart=new Date,this.version="0.5.4",this.debug&&console.log("Render time: "+(this.initStart-renderStart)),this.numContributionMatchesResults=3,this.numDisplayContributionMatches=3,this.numMatchesResults=10,this.numSegments=$("section").length,this.editarea="",this.byButton=!1,this.notYetOpened=!0,this.pendingScroll=0,this.firstScroll=!0,this.blockGetMoreSegments=!0,this.searchParams={},this.searchParams.search=0,this.customSpellcheck=!1,this.noGlossary=!1,setTimeout(function(){UI.blockGetMoreSegments=!1},200),this.loadCustomization(),$("html").trigger("init"),this.setTagMode(),this.detectFirstLast(),this.initSegmentNavBar(),rangy.init(),this.savedSel=null,this.savedSelActiveElement=null,this.firstOpenedSegment=!1,this.autoscrollCorrectionEnabled=!0,this.offline=!1,this.searchEnabled=!0,this.searchEnabled&&$("#filterSwitch").show(100,function(){APP.fitText($(".breadcrumbs"),$("#pname"),30)}),this.fixHeaderHeightChange(),this.viewConcordanceInContextMenu=!0,this.viewConcordanceInContextMenu||$("#searchConcordance").hide(),this.viewSpellCheckInContextMenu=!0,this.viewSpellCheckInContextMenu||$("#spellCheck").hide(),setTimeout(function(){UI.autoscrollCorrectionEnabled=!1},2e3),this.checkSegmentsArray={},this.firstMarking=!0,this.firstMarking=!1,this.surveyDisplayed=!1,this.warningStopped=!1,this.abortedOperations=[],this.propagationsAvailable=!1,this.logEnabled=!0,this.unsavedSegmentsToRecover=[],this.recoverUnsavedSegmentsTimer=!1,this.savingMemoryErrorNotificationEnabled=!1,this.setTranslationTail=[],this.setContributionTail=[],this.executingSetTranslation=!1,this.executingSetContribution=!1,this.executingSetContributionMT=!1,this.localStorageArray=[],this.isPrivateSafari=this.isSafari&&!this.isLocalStorageNameSupported(),config.isAnonymousUser&&this.body.addClass("isAnonymous"),this.globalWarnings=[],this.shortcuts={translate:{label:"Confirm translation",equivalent:"click on Translated",keystrokes:{standard:"ctrl+return",mac:"meta+return"}},translate_nextUntranslated:{label:"Confirm translation and go to Next untranslated segment",equivalent:"click on [T+>>]",keystrokes:{standard:"ctrl+shift+return",mac:"meta+shift+return"}},openNext:{label:"Go to next segment",equivalent:"",keystrokes:{standard:"ctrl+down",mac:"meta+down"}},openPrevious:{label:"Go to previous segment",equivalent:"",keystrokes:{standard:"ctrl+up",mac:"meta+up"}},gotoCurrent:{label:"Go to current segment",equivalent:"",keystrokes:{standard:"ctrl+home",mac:"meta+shift+up"}},copySource:{label:"Copy source to target",equivalent:"click on > between source and target",keystrokes:{standard:"alt+ctrl+i"}},undoInSegment:{label:"Undo in segment",equivalent:"",keystrokes:{standard:"ctrl+z",mac:"meta+z"}},redoInSegment:{label:"Undo in segment",equivalent:"",keystrokes:{standard:"ctrl+y",mac:"meta+shift+z"}},openSearch:{label:"Open/Close search panel",equivalent:"",keystrokes:{standard:"ctrl+f",mac:"meta+f"}},searchInConcordance:{label:"Perform Concordance search on word(s) selected in the source or target segment",equivalent:"",keystrokes:{standard:"alt+c",mac:"alt+meta+c"}}},this.setShortcuts(),this.setContextMenu(),this.createJobMenu(),$("#alertConfirmTranslation p").text("To confirm your translation, please press on Translated or use the shortcut "+(UI.isMac?"CMD":"CTRL")+"+Enter."),APP.initMessageBar(),this.checkVersion(),this.initTM(),this.storeClientInfo(),this.setEvents(),this.surveyAlreadyDisplayed()&&(this.surveyDisplayed=!0)}}),$.extend(UI,{render:function(a){a=a||{},firstLoad=a.firstLoad||!1,segmentToOpen=a.segmentToOpen||!1,segmentToScroll=a.segmentToScroll||!1,scrollToFile=a.scrollToFile||!1,highlight=a.highlight||!1,seg=segmentToOpen||!1,this.segmentToScrollAtRender=seg?seg:!1,this.isSafari=navigator.userAgent.search("Safari")>=0&&navigator.userAgent.search("Chrome")<0,this.isChrome="undefined"!=typeof window.chrome,this.isFirefox="undefined"!=typeof navigator.mozApps,this.isMac="MacIntel"==navigator.platform?!0:!1,this.body=$("body"),this.firstLoad=firstLoad,this.initSegNum=100,this.moreSegNum=25,this.numOpenedSegments=0,this.hasToBeRerendered=!1,this.maxMinutesBeforeRerendering=60,setTimeout(function(){UI.hasToBeRerendered=!0},6e4*this.maxMinutesBeforeRerendering),this.loadingMore=!1,this.infiniteScroll=!0,this.noMoreSegmentsAfter=!1,this.noMoreSegmentsBefore=!1,this.blockButtons=!1,this.blockOpenSegment=!1,this.dmp=new diff_match_patch,this.beforeDropEditareaHTML="",this.beforeDropSearchSourceHTML="",this.currentConcordanceField=null,this.droppingInEditarea=!1,this.draggingInsideEditarea=!1,this.undoStack=[],this.undoStackPosition=0,this.ccSourceUndoStack=[],this.ccSourceUndoStackPosition=0,this.ccTargetUndoStack=[],this.ccTargetUndoStackPosition=0,this.tagSelection=!1,this.nextUntranslatedSegmentIdByServer=0,this.cursorPlaceholder="[[placeholder]]",this.openTagPlaceholder="MATECAT-openTagPlaceholder-MATECAT",this.closeTagPlaceholder="MATECAT-closeTagPlaceholder-MATECAT",this.tempViewPoint="",this.checkUpdatesEvery=18e4,this.autoUpdateEnabled=!0,this.goingToNext=!1,this.preCloseTagAutocomplete=!1,this.hiddenTextEnabled=!0,this.markSpacesEnabled=!1,this.tagModesEnabled="undefined"!=typeof a.tagModesEnabled?a.tagModesEnabled:!0,this.tagModesEnabled?UI.body.addClass("tagModes"):UI.body.removeClass("tagModes"),this.translationMismatches=[],this.downOpts={offset:"130%"},this.upOpts={offset:"-40%"},this.readonly=this.body.hasClass("archived")?!0:!1,this.suggestionShortcutLabel="CTRL+",this.taglockEnabled=config.taglockEnabled,this.debug=!1,this.findCommonPartInSegmentIds(),UI.detectStartSegment(),a.openCurrentSegmentAfter=seg||this.firstLoad?!1:!0,UI.getSegments(a),this.firstLoad&&this.autoUpdateEnabled&&(this.lastUpdateRequested=new Date,setTimeout(function(){UI.getUpdates()},UI.checkUpdatesEvery))}}),$.extend(UI,{bindShortcuts:function(){$("body").removeClass("shortcutsDisabled"),$("body").on("keydown.shortcuts",null,UI.shortcuts.translate.keystrokes.standard,function(a){a.preventDefault(),$(".editor .translated").click(),$("body.review .editor .approved").click()}).on("keydown.shortcuts",null,UI.shortcuts.translate.keystrokes.mac,function(a){a.preventDefault(),$(".editor .translated").click(),$("body.review .editor .approved").click()}).on("keydown.shortcuts",null,UI.shortcuts.translate_nextUntranslated.keystrokes.standard,function(a){a.preventDefault(),$(".editor .next-untranslated").click()}).on("keydown.shortcuts",null,UI.shortcuts.translate_nextUntranslated.keystrokes.mac,function(a){a.preventDefault(),$(".editor .next-untranslated").click()}).on("keydown.shortcuts",null,"Ctrl+pageup",function(a){a.preventDefault()}).on("keydown.shortcuts",null,UI.shortcuts.openNext.keystrokes.standard,function(a){a.preventDefault(),a.stopPropagation(),UI.gotoNextSegment()}).on("keydown.shortcuts",null,UI.shortcuts.openNext.keystrokes.mac,function(a){a.preventDefault(),a.stopPropagation(),UI.gotoNextSegment()}).on("keydown.shortcuts",null,UI.shortcuts.openPrevious.keystrokes.standard,function(a){a.preventDefault(),a.stopPropagation(),UI.gotoPreviousSegment()}).on("keydown.shortcuts",null,UI.shortcuts.openPrevious.keystrokes.mac,function(a){a.preventDefault(),a.stopPropagation(),UI.gotoPreviousSegment()}).on("keydown.shortcuts",null,UI.shortcuts.gotoCurrent.keystrokes.standard,function(a){a.preventDefault(),UI.pointToOpenSegment()}).on("keydown.shortcuts",null,UI.shortcuts.gotoCurrent.keystrokes.mac,function(a){a.preventDefault(),UI.pointToOpenSegment()}).on("keydown.shortcuts",null,UI.shortcuts.copySource.keystrokes.standard,function(a){a.preventDefault(),UI.copySource()}).on("keydown.shortcuts",null,UI.shortcuts.undoInSegment.keystrokes.standard,function(a){a.preventDefault(),UI.undoInSegment(segment),UI.closeTagAutocompletePanel()}).on("keydown.shortcuts",null,UI.shortcuts.undoInSegment.keystrokes.mac,function(a){a.preventDefault(),UI.undoInSegment(segment),UI.closeTagAutocompletePanel()}).on("keydown.shortcuts",null,UI.shortcuts.redoInSegment.keystrokes.standard,function(a){a.preventDefault(),UI.redoInSegment(segment)}).on("keydown.shortcuts",null,UI.shortcuts.redoInSegment.keystrokes.mac,function(a){a.preventDefault(),UI.redoInSegment(segment)}).on("keydown.shortcuts",null,UI.shortcuts.openSearch.keystrokes.standard,function(a){UI.searchEnabled&&$("#filterSwitch").length&&UI.toggleSearch(a)}).on("keydown.shortcuts",null,UI.shortcuts.openSearch.keystrokes.mac,function(a){UI.searchEnabled&&$("#filterSwitch").length&&UI.toggleSearch(a)})},unbindShortcuts:function(){$("body").off(".shortcuts").addClass("shortcutsDisabled")},setEvents:function(){this.bindShortcuts(),$("body").on("keydown",null,"ctrl+1",function(a){a.preventDefault(),active=$(".editor .submenu li.active"),active.hasClass("tab-switcher-tm")?(tab="matches",$(".editor .tab."+tab+" .graysmall[data-item=1]").trigger("dblclick")):active.hasClass("tab-switcher-al")&&(tab="alternatives",$(".editor .tab."+tab+" .graysmall[data-item=1]").trigger("dblclick"))}).on("keydown",null,"ctrl+2",function(a){a.preventDefault(),active=$(".editor .submenu li.active"),active.hasClass("tab-switcher-tm")?(tab="matches",$(".editor .tab."+tab+" .graysmall[data-item=2]").trigger("dblclick")):active.hasClass("tab-switcher-al")&&(tab="alternatives",$(".editor .tab."+tab+" .graysmall[data-item=2]").trigger("dblclick"))}).on("keydown",null,"ctrl+3",function(a){a.preventDefault(),active=$(".editor .submenu li.active"),active.hasClass("tab-switcher-tm")?(tab="matches",$(".editor .tab."+tab+" .graysmall[data-item=3]").trigger("dblclick")):active.hasClass(".tab-switcher-al")&&(tab="alternatives",$(".editor .tab."+tab+" .graysmall[data-item=3]").trigger("dblclick"))}).on("keydown",".editor .editarea","shift+return",function(a){UI.handleReturn(a)}).on("keydown",".editor .editarea","return",function(a){UI.handleReturn(a)}).on("keydown",".editor .editarea","space",function(a){if(UI.markSpacesEnabled){if(!UI.hiddenTextEnabled)return;a.preventDefault(),UI.editarea.find(".lastInserted").removeClass("lastInserted");var b=document.createElement("span");b.setAttribute("class","marker monad space-marker lastInserted"),b.setAttribute("contenteditable","false"),b.textContent=htmlDecode(" "),insertNodeAtCursor(b),UI.unnestMarkers()}}).on("keydown",".editor .editarea","ctrl+shift+space",function(a){if(UI.hiddenTextEnabled){a.preventDefault(),UI.editarea.find(".lastInserted").removeClass("lastInserted");var b=document.createElement("span");b.setAttribute("class","marker monad nbsp-marker lastInserted "+config.nbspPlaceholderClass),b.setAttribute("contenteditable","false"),b.textContent=htmlDecode("&nbsp;"),insertNodeAtCursor(b),UI.unnestMarkers()}}),$("body").bind("keydown","Ctrl+c",function(){UI.tagSelection=!1}).bind("keydown","Meta+shift+l",function(){UI.openLanguageResourcesPanel()}).bind("keydown","Meta+c",function(){UI.tagSelection=!1}).bind("keydown","Meta+shift+s",function(){UI.body.toggleClass("tagmode-default-extended")}).on("click",".tagModeToggle",function(a){a.preventDefault(),console.log("click su tagMode toggle"),$(this).toggleClass("active"),UI.body.toggleClass("tagmode-default-extended"),"undefined"!=typeof UI.currentSegment&&UI.pointToOpenSegment(!0)}).on("click","#settingsSwitcher",function(a){a.preventDefault(),UI.unbindShortcuts(),$(".popup-settings").show()}).on("click",".open-popup-addtm-tr",function(a){a.preventDefault(),UI.openLanguageResourcesPanel()}).on("click","#addtm-create-key",function(a){return a.preventDefault(),$(this).hasClass("disabled")?!1:($(this).addClass("disabled"),$(this).attr("disabled",""),void APP.doRequest({data:{action:"createRandUser"},success:function(a){return $("#addtm-tr-key").val(a.data.key),$("#addtm-create-key").removeClass("disabled"),setTimeout(function(){UI.checkAddTMEnable(),UI.checkManageTMEnable()},100),!1}}))}).on("change","#addtm-tr-read, #addtm-tr-write",function(){UI.checkTMgrants($(".addtm-tr"))&&$(".addtm-tr .error-message").hide()}).on("change","#addtm-tr-key-read, #addtm-tr-key-write",function(){UI.checkTMgrants($(".addtm-tr-key"))&&$(".addtm-tr-key .error-message").hide()}).on("change",".addtm-select-file",function(){}).on("click","#addtm-select-file",function(){$(".addtm-select-file").click()}).on("change",".addtm-select-file",function(){console.log($(this).val()),""!==$(this).val()?$("#uploadTMX").html($(this).val().split("\\")[$(this).val().split("\\").length-1]+'<a class="delete"></a>').show():$("#uploadTMX").hide()}).on("change","#addtm-tr-key",function(){$(".addtm-tr .warning-message").hide()}).on("input","#addtm-tr-key",function(){UI.checkAddTMEnable(),UI.checkManageTMEnable()}).on("change","#addtm-tr-key, .addtm-select-file, #addtm-tr-read, #addtm-tr-write",function(){UI.checkAddTMEnable()}).on("click","#uploadTMX .delete",function(a){a.preventDefault(),$("#uploadTMX").html(""),$(".addtm-select-file").val("")}).on("click","#addtm-add",function(a){return a.preventDefault(),UI.checkTMgrants($(".addtm-tr"))?(console.log("vediamo qui"),$(".addtm-tr .error-message").text("").hide(),console.log("CONTROLLO: ",$("#uploadTMX").text()),operation=""===$("#uploadTMX").text()?"key":"tm",UI.checkTMKey($("#addtm-tr-key").val(),operation),void 0):!1}).on("click",".popup-settings #settings-restore",function(a){a.preventDefault(),APP.closePopup()}).on("click",".popup-settings #settings-save",function(a){a.preventDefault(),APP.closePopup()}).on("click",".modal .x-popup",function(){$("body").hasClass("shortcutsDisabled")&&UI.bindShortcuts()}).on("click",".popup-settings .x-popup",function(){console.log("close")}).on("click",".popup-settings .submenu li",function(a){a.preventDefault(),$(".popup-settings .submenu li.active").removeClass("active"),$(this).addClass("active"),$(".popup-settings .tab").hide(),$("#"+$(this).attr("data-tab")).show()}).on("click",".popup-settings .submenu li a",function(a){a.preventDefault()}).on("click","#settings-shortcuts .list .combination .keystroke",function(){$("#settings-shortcuts .list .combination .msg").remove(),$("#settings-shortcuts .list .combination .keystroke.changing").removeClass("changing"),$(this).toggleClass("changing").after('<span class="msg">New: </span>'),$("#settings-shortcuts").addClass("modifying")}).on("click","#settings-shortcuts #default-shortcuts",function(a){a.preventDefault(),$("#settings-shortcuts .list").remove(),UI.setShortcuts(),$('.popup-settings .submenu li[data-tab="settings-shortcuts"]').removeClass("modified")}).on("click","#spellCheck .words",function(a){a.preventDefault(),UI.selectedMisspelledElement.replaceWith($(this).text()),UI.closeContextMenu()}).on("click","#spellCheck .add",function(a){a.preventDefault(),UI.closeContextMenu(),UI.addWord(UI.selectedMisspelledElement.text())}).on("click",".reloadPage",function(){location.reload(!0)}).on("click",".tag-autocomplete li",function(a){a.preventDefault(),UI.editarea.html(UI.editarea.html().replace(/<span class="tag-autocomplete-endcursor"><\/span>&lt;/gi,'&lt;<span class="tag-autocomplete-endcursor"></span>')),UI.editarea.find(".rangySelectionBoundary").before(UI.editarea.find(".rangySelectionBoundary + .tag-autocomplete-endcursor")),UI.editarea.html(UI.editarea.html().replace(/&lt;(?:[a-z]*(?:&nbsp;)*["<\->\w\s\/=]*)?(<span class="tag-autocomplete-endcursor">)/gi,"$1")),UI.editarea.html(UI.editarea.html().replace(/&lt;(?:[a-z]*(?:&nbsp;)*["\w\s\/=]*)?(<span class="tag-autocomplete-endcursor"\>)/gi,"$1")),UI.editarea.html(UI.editarea.html().replace(/&lt;(?:[a-z]*(?:&nbsp;)*["\w\s\/=]*)?(<span class="undoCursorPlaceholder monad" contenteditable="false"><\/span><span class="tag-autocomplete-endcursor"\>)/gi,"$1")),UI.editarea.html(UI.editarea.html().replace(/(<span class="tag-autocomplete-endcursor"\><\/span><span class="undoCursorPlaceholder monad" contenteditable="false"><\/span>)&lt;/gi,"$1")),saveSelection(),$(".rangySelectionBoundary",UI.editarea).length||(setCursorPosition(document.getElementsByClassName("tag-autocomplete-endcursor")[0]),saveSelection());var b=$(".rangySelectionBoundary",UI.editarea)[0].outerHTML;$(".rangySelectionBoundary",UI.editarea).remove(),$(".tag-autocomplete-endcursor",UI.editarea).after(b),$(".tag-autocomplete-endcursor").before(htmlEncode($(this).text())),restoreSelection(),UI.closeTagAutocompletePanel(),UI.lockTags(UI.editarea),UI.currentSegmentQA()}).on("click",".modal.survey .x-popup",function(){if(UI.surveyDisplayed=!0,"undefined"!=typeof $.cookie("surveyedJobs")){var a=$.cookie("surveyedJobs");surv=a.split("||")[0],config.survey===surv&&$.cookie("surveyedJobs",a+config.job_id+",")}else $.cookie("surveyedJobs",config.survey+"||"+config.job_id+",",{expires:20,path:"/"});$(".modal.survey").remove()}).on("click",".modal.survey .popup-outer",function(){$(".modal.survey").hide().remove()}).on("keydown","#settings-shortcuts.modifying .keystroke",function(a){a.preventDefault();var b=a.which,c=$(this).parents(".combination");c.find(".new").length||$(c).append('<span class="new"></span>');var d=$(".new",c);if(console.log(b),"16"==b||"17"==b||"18"==b||"91"==b){if($(".control",d).length>1)return console.log("troppi tasti control: ",$("span",d).length),!1;k="16"==b?"shift":"17"==b?"ctrl":"18"==b?"alt":"91"==b?"meta":"",d.html(d.html()+'<span class="control">'+UI.viewShortcutSymbols(k)+"</span>+")}else console.log(b),symbol="8"==b?"9003":"9"==b?"8682":"13"==b?"8629":"37"==b?"8592":"38"==b?"8593":"39"==b?"8594":"40"==b?"8595":b,console.log("symbol: ",symbol),d.html(d.html()+'<span class="char">'+UI.viewShortcutSymbols("&#"+symbol)+"</span>+"),console.log(d.html());$("span",d).length>2&&UI.writeNewShortcut(c,d,this)}).on("keyup","#settings-shortcuts.modifying .keystroke",function(){console.log("keyup");var a=$(this).parents(".combination"),b=$(".new",a);$(".control",b).length&&$(".char",b).length&&UI.writeNewShortcut(a,b,this),$(b).remove()}).on("click",".authLink",function(a){return a.preventDefault(),$(".login-google").show(),!1}).on("click","#sign-in",function(a){a.preventDefault();var b=$(this).data("oauth"),c=window.open(b,"name","height=600,width=900");window.focus&&c.focus()}),$(window).on("scroll",function(){UI.browserScrollPositionRestoreCorrection()}).on("allTranslated",function(){config.survey&&UI.displaySurvey(config.survey)}).on("mousedown",function(){return $("body").hasClass(".job_archived")||$("body").hasClass(".job_cancelled")?!1:($(".editor .rangySelectionBoundary.focusOut").length||UI.isSafari||saveSelection(),$(".editor .rangySelectionBoundary").addClass("focusOut"),hasFocusBefore=UI.editarea.is(":focus"),void setTimeout(function(){hasFocusAfter=UI.editarea.is(":focus"),hasFocusBefore&&hasFocusAfter&&$(".editor .rangySelectionBoundary.focusOut").remove()},600))}),window.onbeforeunload=function(a){goodbye(a)},$("header .filter").click(function(a){a.preventDefault(),UI.body.toggleClass("filtering")}),$("#filterSwitch").bind("click",function(a){UI.toggleSearch(a)}),$("#segmentPointer").click(function(a){a.preventDefault(),UI.pointToOpenSegment()}),$(".replace").click(function(a){a.preventDefault(),UI.body.toggleClass("replace-box")}),jQuery(".editarea").trigger("update"),$("div.notification-box").mouseup(function(){return!1}),$(".search-icon, .search-on").click(function(a){a.preventDefault(),$("#search").toggle()}),$(".download-chrome a.close").bind("click",function(a){a.preventDefault(),$(".download-chrome").removeClass("d-open")}),$(".x-stats").click(function(){$(".stats").toggle()}),$("#outer").on("click","a.sid",function(a){return a.preventDefault(),a.stopPropagation(),!1}).on("click","a.status",function(a){a.preventDefault(),a.stopPropagation()}).on("click","section:not(.readonly) a.status",function(){var a=$(this).parents("section"),b=$("ul.statusmenu",a);UI.createStatusMenu(b),b.show(),$("html").bind("click.outOfStatusMenu",function(){$("ul.statusmenu").hide(),$("html").unbind("click.outOfStatusMenu"),UI.removeStatusMenu(b)})}).on("click","section.readonly, section.readonly a.status",function(a){if(a.preventDefault(),!UI.justSelecting("readonly")&&!UI.someUserSelection){var b=UI.body.hasClass("archived")?"Job has been archived and cannot be edited.":"This part has not been assigned to you.";UI.selectingReadonly=setTimeout(function(){APP.alert({msg:b})},200)}}).on("mousedown","section.readonly, section.readonly a.status",function(){sel=window.getSelection(),UI.someUserSelection="Range"==sel.type?!0:!1}).on("dblclick","section.readonly",function(){clearTimeout(UI.selectingReadonly)}).on("dblclick",".matches .graysmall",function(){UI.chooseSuggestion($(this).attr("data-item"))}).on("dblclick",".alternatives .graysmall",function(){UI.chooseAlternative($(this))}).on("dblclick",".glossary .sugg-target",function(){UI.copyGlossaryItemInEditarea($(this))}).on("click",".tab.alternatives .graysmall .goto a",function(a){a.preventDefault(),UI.scrollSegment($("#segment-"+$(this).attr("data-goto")),!0),UI.highlightEditarea($("#segment-"+$(this).attr("data-goto")))}),$(".joblink").click(function(a){return a.preventDefault(),$(".joblist").toggle(),!1
}),$(".statslink").click(function(a){a.preventDefault(),a.stopPropagation(),$(".stats").toggle()}),$(".getoriginal").click(function(a){a.preventDefault(),$("#originalDownload").submit()}),$("form#fileDownload").bind("submit",function(a){a.preventDefault()}),$("html").click(function(){$(".menucolor").hide()}).on("click","#quality-report",function(){var a=window.open($("#quality-report").data("url"),"_self");a.focus()}).on("click","#previewDropdown .downloadTranslation a",function(a){a.preventDefault(),$("#downloadProject").click()}).on("click","#previewDropdown .previewLink a",function(a){a.preventDefault(),$(".downloadtr-button.draft").click()}).on("click","#downloadProject",function(a){return a.preventDefault(),$("#downloadProject").hasClass("disabled")?!1:void($("#notifbox").hasClass("warningbox")&&UI.translationMismatches.total!=UI.globalWarnings.length?APP.confirm({name:"confirmDownload",cancelTxt:"Fix errors",onCancel:"goToFirstError",callback:"continueDownload",okTxt:"Continue",msg:'Potential errors (missing tags, numbers etc.) found in the text. <br>If you continue, part of the content could be untranslated - look for the string "UNTRANSLATED_CONTENT" in the downloaded file(s).<br><br>Continue downloading or fix the error in MateCat:'}):UI.continueDownload())}).on("mousedown",".header-menu .originalDownload, .header-menu .sdlxliff, .header-menu .omegat",function(a){if(1==a.which){a.preventDefault();var b=$(document.createElement("iframe")).hide().prop({id:"iframeDownload_"+(new Date).getTime()+"_"+parseInt(1e7*Math.random(0,1)),src:$(a.currentTarget).attr("href")});$("body").append(b)}}).on("click",".alert .close",function(a){a.preventDefault(),$(".alert").remove()}).on("click",".downloadtr-button.draft",function(){UI.isChrome&&($(".download-chrome").addClass("d-open"),setTimeout(function(){$(".download-chrome").removeClass("d-open")},7e3))}).on("click","#contextMenu #searchConcordance",function(){$("#contextMenu").attr("data-sid")==UI.currentSegmentId?UI.openConcordance():$("#segment-"+$("#contextMenu").attr("data-sid")+" .editarea").trigger("click",["clicking","openConcordance"])}).on("click","#checkConnection",function(a){a.preventDefault(),UI.checkConnection("Click from Human Authorized")}).on("click","#statistics .meter a",function(a){a.preventDefault(),UI.gotoNextUntranslatedSegment()}),$("#outer").on("click","a.percentuage",function(a){a.preventDefault(),a.stopPropagation()}).on("mouseup",".editarea",function(){UI.editarea.find(".locked.selected").length||$(window.getSelection().getRangeAt(0))[0].collapsed||UI.isFirefox||UI.showEditToolbar()}).on("mousedown",".editarea",function(a){return 3==a.which?(a.preventDefault(),!1):void UI.hideEditToolbar()}).on("mousedown",".editToolbar .uppercase",function(){UI.formatSelection("uppercase")}).on("mousedown",".editToolbar .lowercase",function(){UI.formatSelection("lowercase")}).on("mousedown",".editToolbar .capitalize",function(){UI.formatSelection("capitalize")}).on("mouseup",".editToolbar li",function(){restoreSelection()}).on("mousedown",".editarea",function(){}).on("click",".editarea",function(a,b,c){"undefined"==typeof b&&(b="clicking"),UI.saveInUndoStack("click"),this.onclickEditarea=new Date,UI.notYetOpened=!1,UI.closeTagAutocompletePanel(),UI.removeHighlightCorrespondingTags(),$(this).is(UI.editarea)&&""!==UI.editarea&&UI.body.hasClass("editing")||("moving"==b?("moving"==UI.lastOperation&&UI.recentMoving?(UI.segmentToOpen=segment,UI.blockOpenSegment=!0,console.log("ctrl+down troppo vicini")):UI.blockOpenSegment=!1,UI.recentMoving=!0,clearTimeout(UI.recentMovingTimeout),UI.recentMovingTimeout=setTimeout(function(){UI.recentMoving=!1},1e3)):UI.blockOpenSegment=!1,UI.lastOperation=b,UI.openSegment(this,b),"openConcordance"==c&&UI.openConcordance(),"moving"!=b&&(segment=$("#segment-"+$(this).data("sid")),config.isReview&&(segment.hasClass("status-new")||segment.hasClass("status-draft"))||UI.scrollSegment($("#segment-"+$(this).data("sid"))))),UI.lockTags(UI.editarea),UI.checkTagProximity(),UI.debug&&console.log("Total onclick Editarea: "+(new Date-this.onclickEditarea))}).on("keydown",".editor .source, .editor .editarea",UI.shortcuts.searchInConcordance.keystrokes.mac,function(a){a.preventDefault(),UI.preOpenConcordance()}).on("keydown",".editor .source, .editor .editarea",UI.shortcuts.searchInConcordance.keystrokes.standard,function(a){a.preventDefault(),UI.preOpenConcordance()}).on("keyup",".editor .editarea","return",function(a){return console.log("UI.defaultBRmanagement: ",UI.defaultBRmanagement),console.log("Enter key is disabled!"),a.preventDefault(),!1}).on("keydown",".editor .editarea","return",function(a){a.preventDefault()}).on("keypress",".editor .editarea",function(a){if(console.log("keypress: ",UI.editarea.html()),60==a.which&&UI.taglockEnabled){if($(".tag-autocomplete").length)return a.preventDefault(),!1;UI.openTagAutocompletePanel(),console.log("Q: ",UI.editarea.html()),setTimeout(function(){console.log("R: ",UI.editarea.html())},200)}return 62==a.which&&UI.taglockEnabled&&$(".tag-autocomplete").length?(a.preventDefault(),!1):(setTimeout(function(){$(".tag-autocomplete").length&&(tempStr=UI.editarea.html().match(/<span class="tag-autocomplete-endcursor"\><\/span>&lt;/gi),UI.stripAngular=tempStr?tempStr.length?!0:!1:!1,null!==UI.editarea.html().match(/^(<span class="tag-autocomplete-endcursor"\><\/span>&lt;)/gi)&&UI.editarea.html(UI.editarea.html().replace(/^(<span class="tag-autocomplete-endcursor"\><\/span>&lt;)/gi,'&lt;<span class="tag-autocomplete-endcursor"></span>')),UI.checkAutocompleteTags())},50),void(UI.body.hasClass("searchActive")||(console.log("vediamo: ",a.which),(!UI.isCJK||"60"!=a.which&&"62"!=a.which)&&setTimeout(function(){UI.lockTags(UI.editarea)},10))))}).on("keydown",".editor .editarea",function(a){if(8==a.which&&!UI.body.hasClass("tagmode-default-extended")){return!0}if(8==a.which||46==a.which)if($(".selected",$(this)).length)a.preventDefault(),$(".selected",$(this)).remove(),UI.saveInUndoStack("cancel"),UI.currentSegmentQA();else{var b=null!==UI.editarea.text().match(/<.*?\>/gi)?UI.editarea.text().match(/<.*?\>/gi).length:0,c=$(".space-marker",UI.editarea).length;saveSelection(),parentTag=$("span.locked",UI.editarea).has(".rangySelectionBoundary"),isInsideTag=$("span.locked .rangySelectionBoundary",UI.editarea).length,parentMark=$(".searchMarker",UI.editarea).has(".rangySelectionBoundary"),isInsideMark=$(".searchMarker .rangySelectionBoundary",UI.editarea).length,sbIndex=0;var d=$.parseHTML(UI.editarea.html());$.each(d,function(a){$(this).hasClass("rangySelectionBoundary")&&(sbIndex=a)});var e=$(d[sbIndex-1]).hasClass("monad")&&"BR"==$(d[sbIndex-2]).prop("tagName")?!0:!1,f=$(".rangySelectionBoundary",UI.editarea);if(e&&f.prev().remove(),8==a.which){var g=$(d[sbIndex-1]).hasClass("locked")&&"BR"==$(d[sbIndex-2]).prop("tagName")?!0:!1;g&&f.prev().remove()}restoreSelection(),8==a.which&&isInsideTag&&(parentTag.remove(),a.preventDefault()),setTimeout(function(){saveSelection(),$(".monad .rangySelectionBoundary",UI.editarea).length&&$(".monad:has(.rangySelectionBoundary)",UI.editarea).after($(".monad .rangySelectionBoundary",UI.editarea)),restoreSelection();var a=null!==UI.editarea.text().match(/<.*?\>/gi)?UI.editarea.text().match(/<.*?\>/gi).length:0,d=$(".space-marker",UI.editarea).length;b>a&&UI.saveInUndoStack("cancel"),c>d&&UI.saveInUndoStack("cancel")},50),8==a.which&&isInsideMark&&console.log("inside mark")}if(8==a.which&&$(".tag-autocomplete").length&&(UI.closeTagAutocompletePanel(),setTimeout(function(){UI.openTagAutocompletePanel(),added=UI.getPartialTagAutocomplete(),""===added&&UI.closeTagAutocompletePanel()},10)),9==a.which){if(!UI.hiddenTextEnabled)return;a.preventDefault();var h=document.createElement("span");h.setAttribute("class","marker monad tab-marker "+config.tabPlaceholderClass),h.setAttribute("contenteditable","false"),h.textContent=htmlDecode("&#8677;"),insertNodeAtCursor(h),UI.unnestMarkers()}if(37==a.which&&(selection=window.getSelection(),range=selection.getRangeAt(0),setTimeout(function(){UI.checkTagProximity()},10),range.startOffset!=range.endOffset&&(r=range.startContainer.innerText,"<"==r[0]&&">"==r[r.length-1]&&(a.preventDefault(),saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).first().get(0),rr.setStartBefore(referenceNode),rr.setEndBefore(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove())),UI.closeTagAutocompletePanel()),38==a.which){if($(".tag-autocomplete").length&&!$(".tag-autocomplete li.current").is($(".tag-autocomplete li:first")))return $(".tag-autocomplete li.current:not(:first-child)").removeClass("current").prevAll(":not(.hidden)").first().addClass("current"),!1;selection=window.getSelection(),range=selection.getRangeAt(0),range.startOffset!=range.endOffset&&(r=range.startContainer.data,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).last().get(0),rr.setStartAfter(referenceNode),rr.setEndAfter(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove())),setTimeout(function(){UI.checkTagProximity()},10)}if(39==a.which&&(selection=window.getSelection(),range=selection.getRangeAt(0),setTimeout(function(){UI.checkTagProximity()},10),range.startOffset!=range.endOffset&&(r=range.startContainer.innerText,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).last().get(0),rr.setStartAfter(referenceNode),rr.setEndAfter(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove())),UI.closeTagAutocompletePanel(),UI.jumpTag(range,"end")),40==a.which){if($(".tag-autocomplete").length)return $(".tag-autocomplete li.current:not(:last-child)").removeClass("current").nextAll(":not(.hidden)").first().addClass("current"),!1;selection=window.getSelection(),range=selection.getRangeAt(0),range.startOffset!=range.endOffset&&(r=range.startContainer.data,"<"==r[0]&&">"==r[r.length-1]&&(saveSelection(),rr=document.createRange(),referenceNode=$(".rangySelectionBoundary",UI.editarea).last().get(0),rr.setStartAfter(referenceNode),rr.setEndAfter(referenceNode),$(".rangySelectionBoundary",UI.editarea).remove())),setTimeout(function(){UI.checkTagProximity()},10)}return(37==a.which||38==a.which||39==a.which||40==a.which||8==a.which)&&UI.saveInUndoStack("arrow"),37!=a.which&&38!=a.which&&39!=a.which&&40!=a.which&&8!=a.which&&46!=a.which&&91!=a.which&&UI.body.hasClass("searchActive")&&UI.resetSearch(),32==a.which&&setTimeout(function(){UI.saveInUndoStack("space")},100),13==a.which&&$(".tag-autocomplete").length?(a.preventDefault(),$(".tag-autocomplete li.current").click(),!1):void((13==a.which||32==a.which||49==a.which||188==a.which||186==a.which||190==a.which||191==a.which||222==a.which)&&UI.spellCheck())}).on("input",".editarea",function(a){console.log("input in editarea"),UI.currentSegment.addClass("modified").removeClass("waiting_for_check_result"),UI.draggingInsideEditarea&&($(UI.tagToDelete).remove(),UI.draggingInsideEditarea=!1,UI.tagToDelete=null),UI.droppingInEditarea&&UI.cleanDroppedTag(UI.editarea,UI.beforeDropEditareaHTML),UI.editarea.find(".locked").length||UI.currentSegment.removeClass("hasTags"),UI.registerQACheck(),UI.isKorean&&("60"==a.which||"62"==a.which||(a.which="32"))||UI.lockTags(UI.editarea)}).on("input",".editor .cc-search .input",function(){UI.markTagsInSearch($(this))}).on("click",".editor .source .locked,.editor .editarea .locked",function(a){a.preventDefault(),a.stopPropagation(),$(this).hasClass("selected")?($(this).removeClass("selected"),setCursorPosition(this,"end")):(setCursorPosition(this),selectText(this),$(this).toggleClass("selected"))}).on("mousedown",".source",function(a){return 2==a.button?!0:!0}).on("dragstart",".editor .editarea .locked",function(){var a=window.getSelection(),b=a.getRangeAt(0);return b.startContainer.data!=b.endContainer.data?!1:(UI.draggingInsideEditarea=!0,void(UI.tagToDelete=$(this)))}).on("drag",".editarea .locked, .source .locked",function(){UI.draggingTagIsOpening=$(this).text().match(/^<\//gi)?!1:!0,UI.draggingTagText=$(this).text()}).on("drop",".editor .editarea",function(a){a.stopPropagation&&a.stopPropagation(),UI.beforeDropEditareaHTML=UI.editarea.html(),UI.droppingInEditarea=!0,$(window).trigger({type:"droppedInEditarea",segment:UI.currentSegment}),$(this).css("float","left"),setTimeout(function(){var a=UI.editarea.html().replace(/(^.*?)&nbsp;(<span contenteditable\="false" class\="locked).*?$/gi,"$1");UI.beforeDropEditareaHTML.indexOf(a+" ")>=0?(toAddBefore=UI.draggingTagIsOpening?" ":"",toAddAfter=UI.draggingTagIsOpening?"":" "):toAddBefore=toAddAfter="",UI.draggingTagIsOpening=null,UI.editarea.html(UI.editarea.html().replace(/&nbsp;(<span contenteditable\="false" class\="locked)/gi,toAddBefore+"$1").replace(/(&gt;<\/span>)&nbsp;/gi,"$1"+toAddAfter));var b=0;$(".locked",UI.editarea).each(function(){return $(this).text()==UI.draggingTagText?(uniqueEl=$(this),b++,!1):void 0}),b>0&&setCursorPosition(uniqueEl[0].nextSibling,0),UI.draggingTagText=null,UI.editarea.removeAttr("style"),UI.saveInUndoStack("drop")},100)}).on("drop paste",".editor .cc-search .input, .editor .gl-search .input",function(){UI.beforeDropSearchSourceHTML=UI.editarea.html(),UI.currentConcordanceField=$(this),setTimeout(function(){console.log("sto per pulire"),UI.cleanDroppedTag(UI.currentConcordanceField,UI.beforeDropSearchSourceHTML)},100)}).on("click",".editor .editarea, .editor .source",function(){$(".selected",$(this)).removeClass("selected"),UI.currentSelectedText=!1,UI.currentSearchInTarget=!1,$("#contextMenu").hide()}).on("blur",".editor .editarea",function(){UI.hideEditToolbar()}).on("click","a.translated, a.next-untranslated",function(a){var b=$(this).hasClass("translated")?"translated":"next-untranslated";a.preventDefault(),UI.hideEditToolbar(),$(".test-invisible").remove(),UI.currentSegment.removeClass("modified");var c=!1;return"next-untranslated"==b?(console.log("next-untranslated"),UI.segmentIsLoaded(UI.nextUntranslatedSegmentId)?console.log("il nextuntranslated è già caricato: ",UI.nextUntranslatedSegmentId):(console.log("il nextuntranslated non è caricato: ",UI.nextUntranslatedSegmentId),UI.changeStatus(this,"translated",0),c=!0,UI.nextUntranslatedSegmentId?UI.reloadWarning():$("#"+$(this).attr("data-segmentid")+"-close").click())):$(UI.currentSegment).nextAll("section:not(.readonly)").length||(UI.changeStatus(this,"translated",0),c=!0,$("#"+$(this).attr("data-segmentid")+"-close").click()),UI.checkHeaviness(),UI.blockButtons?void(UI.segmentIsLoaded(UI.nextUntranslatedSegmentId)||""===UI.nextUntranslatedSegmentId||UI.noMoreSegmentsAfter||UI.reloadWarning()):(UI.offline||(UI.blockButtons=!0),UI.unlockTags(),UI.setStatusButtons(this),c||UI.changeStatus(this,"translated",0),"translated"==b?UI.gotoNextSegment():$(".editarea",UI.nextUntranslatedSegment).trigger("click","translated"),UI.lockTags($("#"+$(this).attr("data-segmentid")+" .editarea")),UI.lockTags(UI.editarea),UI.changeStatusStop=new Date,void(UI.changeStatusOperations=UI.changeStatusStop-UI.buttonClickStop))}).on("click","a.approved",function(){}).on("click","a.d, a.a, a.r, a.f",function(){var a=$(this).parents("section");return $("a.status",a).removeClass("col-approved col-rejected col-done col-draft"),$("ul.statusmenu",a).toggle(),!1}).on("click","a.d",function(){UI.changeStatus(this,"translated",1)}).on("click","a.a",function(){UI.changeStatus(this,"approved",1)}).on("click","a.r",function(){UI.changeStatus(this,"rejected",1)}).on("click","a.f",function(){UI.changeStatus(this,"draft",1)}).on("click",".editor .outersource .copy",function(a){a.preventDefault(),UI.copySource()}).on("click",".tagmenu, .warning, .viewer, .notification-box li a",function(){return!1}).on("click",".tab-switcher-tm",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.matches").show()}).on("click",".tab-switcher-cc",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.concordances").show(),$(".cc-search .search-source").focus()}).on("click",".tab-switcher-gl",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.glossary").show(),$(".gl-search .search-source").focus()}).on("click",".tab-switcher-al",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.alternatives").show()}).on("click",".alternatives a",function(a){a.preventDefault(),$(".editor .tab-switcher-al").click()}).on("click",".sub-editor.glossary .overflow a.trash",function(a){a.preventDefault(),ul=$(this).parents("ul.graysmall").first(),UI.deleteGlossaryItem($(this).parents("ul.graysmall").first())}).on("click",".sub-editor.glossary .details .comment",function(a){a.preventDefault(),$(this).attr("contenteditable",!0).focus()}).on("blur",".sub-editor.glossary .details .comment",function(a){a.preventDefault(),$(this).attr("contenteditable",!1),item=$(this).parents(".graysmall"),APP.doRequest({data:{action:"glossary",exec:"update",segment:item.find(".suggestion_source").text(),translation:item.find(".translation").text(),comment:$(this).text(),id_item:item.attr("data-id"),id_job:config.job_id,password:config.password},error:function(){UI.failedConnection(0,"glossary")},context:[UI.currentSegment,next]})}).on("keydown",".sub-editor .cc-search .search-source",function(a){if(13==a.which){a.preventDefault();var b=$(this).text();b.length>1&&UI.getConcordance(b,0)}else $(".editor .sub-editor .cc-search .search-target").text().length>0&&($(".editor .sub-editor .cc-search .search-target").text(""),$(".editor .sub-editor.concordances .results").empty())}).on("keydown",".sub-editor .cc-search .search-target",function(a){if(13==a.which){a.preventDefault();var b=$(this).text();b.length>2&&UI.getConcordance(b,1)}else $(".editor .sub-editor .cc-search .search-source").text().length>0&&($(".editor .sub-editor .cc-search .search-source").text(""),$(".editor .sub-editor.concordances .results").empty())}).on("click",".sub-editor .gl-search .search-glossary",function(a){a.preventDefault();var b=$(this).parents(".gl-search").find(".search-source").text();segment=$(this).parents("section").first(),b.length>1?UI.getGlossary(segment,!1):APP.alert({msg:"Please insert a string of two letters at least!"})}).on("keydown",".sub-editor .gl-search .search-source",function(a){if(13==a.which){a.preventDefault();var b=$(this).text();b.length>2&&(segment=$(this).parents("section").first(),UI.getGlossary(segment,!1))}}).on("input",".sub-editor .gl-search .search-target",function(){gl=$(this).parents(".gl-search").find(".set-glossary"),""===$(this).text()?gl.addClass("disabled"):gl.removeClass("disabled")}).on("click",".sub-editor .gl-search .set-glossary",function(a){a.preventDefault()}).on("click",".sub-editor .gl-search .set-glossary:not(.disabled)",function(a){return a.preventDefault(),""===$(this).parents(".gl-search").find(".search-source").text()?(APP.alert({msg:"Please insert a glossary term."}),!1):void UI.setGlossaryItem()}).on("click",".sub-editor .gl-search .comment a",function(a){a.preventDefault(),$(this).parents(".comment").find(".gl-comment").toggle()}).on("paste",".editarea",function(a){console.log("paste in editarea"),UI.saveInUndoStack("paste"),$("#placeHolder").remove();var b=document.createElement("div");b.setAttribute("id","placeHolder"),removeSelectedText(),insertNodeAtCursor(b),UI.isFirefox&&pasteHtmlAtCaret('<div id="placeHolder"></div>');var c=UI.isFirefox?a:event;handlepaste(this,c),UI.lockTags(UI.editarea)}).on("click","a.close",function(a,b){a.preventDefault();var c="undefined"==typeof b?"noSave":b;UI.closeSegment(UI.currentSegment,1,c)}).on("click",".concordances .more",function(a){a.preventDefault(),tab=$(this).parents(".concordances"),container=$(".overflow",$(tab)),UI.setExtendedConcordances($(tab).hasClass("extended")?!1:!0),$(this).parents(".matches").toggleClass("extended")}).on("keyup",".editor .editarea",function(a){13==a.which}).on("click",".tagMode .crunched",function(a){a.preventDefault(),UI.setCrunchedTagMode()}).on("click",".tagMode .extended",function(a){a.preventDefault(),UI.setExtendedTagMode()}),UI.toSegment=!0,this.segmentToScrollAtRender||UI.gotoSegment(this.startSegmentId),$(".end-message-box a.close").on("click",function(a){a.preventDefault(),UI.body.removeClass("justdone")}),this.checkIfFinishedFirst(),$("section .close").bind("keydown","Shift+tab",function(a){a.preventDefault(),$(this).parents("section").find("a.translated").focus()}),$("a.translated").bind("keydown","tab",function(a){a.preventDefault(),$(this).parents("section").find(".close").focus()}),$("#point2seg").bind("mousedown",function(){UI.setNextWarnedSegment()}),$("#navSwitcher").on("click",function(a){a.preventDefault()}),$("#pname").on("click",function(a){a.preventDefault(),UI.toggleFileMenu()}),$("#jobNav .jobstart").on("click",function(a){a.preventDefault(),UI.scrollSegment($("#segment-"+config.firstSegmentOfFiles[0].first_segment))}),$("#jobMenu").on("click","li:not(.currSegment)",function(a){a.preventDefault(),UI.renderAndScrollToSegment($(this).attr("data-segment"))}),$("#jobMenu").on("click","li.currSegment",function(a){a.preventDefault(),UI.pointToOpenSegment()}),$("#jobNav .prevfile").on("click",function(a){a.preventDefault(),currArtId=$(UI.currentFile).attr("id").split("-")[1],$.each(config.firstSegmentOfFiles,function(){currArtId==this.id_file&&(firstSegmentOfCurrentFile=this.first_segment)}),UI.scrollSegment($("#segment-"+firstSegmentOfCurrentFile))}),$("#jobNav .currseg").on("click",function(a){a.preventDefault(),$("#segment-"+UI.currentSegmentId).length?UI.scrollSegment(UI.currentSegment):($("#outer").empty(),UI.render({firstLoad:!1}))}),$("#jobNav .nextfile").on("click",function(a){a.preventDefault(),""===UI.tempViewPoint&&(currFileFirstSegmentId=$(UI.currentFile).attr("id").split("-")[1],$.each(config.firstSegmentOfFiles,function(){this.id_file==currFileFirstSegmentId&&(firstSegId=this.first_segment)}),UI.scrollSegment($("#segment-"+firstSegId)),UI.tempViewPoint=$(UI.currentFile).attr("id").split("-")[1]),$.each(config.firstSegmentOfFiles,function(){console.log(this.id_file)})}),$(".searchbox input, .searchbox select").bind("keydown","return",function(a){a.preventDefault(),"disabled"!=$("#exec-find").attr("disabled")&&$("#exec-find").click()}),$("#exec-find").click(function(a){a.preventDefault(),"find"==$(this).attr("data-func")?UI.execFind():UI.goingToNext||(UI.goingToNext=!0,UI.execNext())}),$("#exec-cancel").click(function(a){a.preventDefault(),$("#filterSwitch").click(),UI.body.removeClass("searchActive"),UI.clearSearchMarkers(),UI.clearSearchFields(),UI.setFindFunction("find"),$("#exec-find").removeAttr("disabled"),$("#exec-replace, #exec-replaceall").attr("disabled","disabled"),UI.enableTagMark(),UI.segmentIsLoaded(UI.currentSegmentId)?UI.gotoOpenSegment():UI.render({firstLoad:!1,segmentToOpen:UI.currentSegmentId})}),$("#exec-replaceall").click(function(a){a.preventDefault(),APP.confirm({name:"confirmReplaceAll",cancelTxt:"Cancel",callback:"execReplaceAll",okTxt:"Continue",msg:"Do you really want to replace this text in all search results? <br>(The page will be refreshed after confirm)"})}),$("#exec-replace").click(function(a){return console.log("ddd"),a.preventDefault(),console.log("a"),$("#search-target").val()==$("#replace-target").val()?(APP.alert({msg:"Attention: you are replacing the same text!"}),!1):(console.log("b"),"onlyStatus"==UI.searchMode||(txt=$("#replace-target").val(),$("mark.currSearchItem").text(txt),segment=$("mark.currSearchItem").parents("section"),segment_id=$(segment).attr("id").split("-")[1],status=UI.getStatus(segment),byStatus=0,UI.setTranslation($(segment).attr("id").split("-")[1],status,"replace"),UI.setContribution(segment_id,status,byStatus),UI.updateSearchDisplayCount(segment),$(segment).attr("data-searchItems",$("mark.searchMarker",segment).length),UI.gotoNextResultItem(!0)),void console.log("c"))}),$("#enable-replace").on("change",function(){$("#enable-replace").is(":checked")&&""!==$("#search-target").val()?$("#replace-target, #exec-replace, #exec-replaceall").removeAttr("disabled"):$("#replace-target, #exec-replace, #exec-replaceall").attr("disabled","disabled")}),$("#search-source, #search-target").on("input",function(){UI.checkSearchChanges()&&UI.setFindFunction("find")}),$("#search-target").on("input",function(){""===$(this).val()?$("#replace-target, #exec-replace, #exec-replaceall").attr("disabled","disabled"):$("#enable-replace").is(":checked")&&$("#replace-target, #exec-replace, #exec-replaceall").removeAttr("disabled")}),$("#select-status").on("change",function(){UI.checkSearchChanges()&&UI.setFindFunction("find")}),$("#match-case, #exact-match").on("change",function(){UI.setFindFunction("find")}),this.initEnd=new Date,this.initTime=this.initEnd-this.initStart,this.debug&&console.log("Init time: "+this.initTime)}}),$("html").on("copySourceToTarget","section",function(){UI.setChosenSuggestion(0)}),$.extend(UI,{chooseSuggestion:function(a){this.copySuggestionInEditarea(this.currentSegment,$(".editor .tab.matches ul[data-item="+a+"] li.b .translation").html(),$(".editor .editarea"),$(".editor .tab.matches ul[data-item="+a+"] ul.graysmall-details .percent").text(),!1,!1,a),this.lockTags(this.editarea),this.setChosenSuggestion(a),this.editarea.focus(),this.highlightEditarea()},copySuggestionInEditarea:function(a,b,c,d,e,f,g){"undefined"==typeof e&&(e=!1),percentageClass=this.getPercentuageClass(d),""!==$.trim(b)&&(e&&(b=htmlDecode(b)),this.body.hasClass("searchActive")&&this.addWarningToSearchDisplay(),this.saveInUndoStack("copysuggestion"),g||(b=UI.encodeSpacesAsPlaceholders(b,!0)),$(c).html(b).addClass("fromSuggestion"),this.saveInUndoStack("copysuggestion"),$(".percentuage",a).text(d).removeClass("per-orange per-green per-blue per-yellow").addClass(percentageClass).addClass("visible"),g&&this.currentSegment.addClass("modified")),$(window).trigger({type:"suggestionChosen",segment:UI.currentSegment,element:UI.editarea,which:g,translation:b})},getContribution:function(a,b){var c=$(0===b?a:1==b?"#segment-"+this.nextSegmentId:"#segment-"+this.nextUntranslatedSegmentId);if($(c).hasClass("loaded")&&(console.log("qualcosa nella tab matches? ",a.find(".footer .matches .overflow").text().length),a.find(".footer .matches .overflow").text().length))return this.spellCheck(),b?this.nextIsLoaded=!0:this.currentIsLoaded=!0,this.currentIsLoaded&&(this.blockButtons=!1),this.currentSegmentId==this.nextUntranslatedSegmentId&&(this.blockButtons=!1),b||this.currentSegmentQA(),!1;if(!c.length&&b)return!1;var d=c.attr("id"),e=d.split("-")[1];return txt=config.brPlaceholdEnabled?this.postProcessEditarea(c,".source"):$(".source",c).text(),txt=view2rawxliff(txt),b||$(".loader",c).addClass("loader_on"),2==b&&this.nextSegmentId==this.nextUntranslatedSegmentId?!1:void APP.doRequest({data:{action:"getContribution",password:config.password,is_concordance:0,id_segment:e,text:txt,id_job:config.job_id,num_results:this.numContributionMatchesResults,id_translator:config.id_translator},context:$("#"+d),error:function(){UI.failedConnection(0,"getContribution")},success:function(a){a.errors.length&&UI.processErrors(a.errors,"getContribution"),UI.getContribution_success(a,this)},complete:function(){UI.getContribution_complete(c)}})},getContribution_complete:function(a){$(".loader",a).removeClass("loader_on")},getContribution_success:function(a,b){this.addInStorage("contribution-"+config.job_id+"-"+UI.getSegmentId(b),JSON.stringify(a),"contribution"),this.processContributions(a,b)},processContributions:function(a,b){return a?(this.renderContributions(a,b),this.getSegmentId(b)==UI.currentSegmentId&&this.currentSegmentQA(),this.lockTags(this.editarea),this.spellCheck(),this.saveInUndoStack(),this.blockButtons=!1,void(a.data.matches.length>0?$(".submenu li.matches a span",b).text("("+a.data.matches.length+")"):$(".sbm > .matches",b).hide())):!0},renderContributions:function(a,b){if(!a)return!0;var c=$(b).hasClass("editor"),d=$(".editarea",b);if(a.data.matches.length){var e=d.text().trim().length;c?d.removeClass("indent"):0===e&&d.addClass("indent");var f=a.data.matches[0].translation,g=$(".percentuage",b).attr("title");$(".percentuage",b).attr("title",""+g+"Created by "+a.data.matches[0].created_by);var h=a.data.matches[0].match,i=!1,j=b.attr("id");$(b).addClass("loaded"),$(".sub-editor.matches .overflow",b).empty(),$.each(a.data.matches,function(c){if(""!==this.segment&&""!==this.translation){var d="0"==this.id?!0:!1;cb=this.created_by,suggestion_info="sentence_confidence"in this&&""!==this.sentence_confidence&&0!==this.sentence_confidence&&"0"!=this.sentence_confidence&&null!==this.sentence_confidence&&this.sentence_confidence!==!1&&"undefined"!=typeof this.sentence_confidence?"Quality: <b>"+this.sentence_confidence+"</b>":"MT"!=this.match?this.last_update_date:"","undefined"==typeof a.data.fieldTest?(percentClass=UI.getPercentuageClass(this.match),percentText=this.match):(quality=parseInt(this.quality),percentClass=quality>98?"per-green":98==quality?"per-red":"per-gray",percentText="MT"),$(".sub-editor.matches",b).length||UI.createFooter(b),escapedSegment=UI.decodePlaceholdersToText(this.segment,!0,j,"contribution source"),$(".sub-editor.matches .overflow",b).append('<ul class="suggestion-item graysmall" data-item="'+(c+1)+'" data-id="'+this.id+'"><li class="sugg-source">'+(d?"":' <a id="'+j+"-tm-"+this.id+'-delete" href="#" class="trash" title="delete this row"></a>')+'<span id="'+j+"-tm-"+this.id+'-source" class="suggestion_source">'+escapedSegment+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span class="graysmall-message">'+UI.suggestionShortcutLabel+(c+1)+'</span><span id="'+j+"-tm-"+this.id+'-translation" class="translation">'+UI.decodePlaceholdersToText(this.translation,!0,j,"contribution translation")+'</span></li><ul class="graysmall-details"><li class="percent '+percentClass+'">'+percentText+"</li><li>"+suggestion_info+'</li><li class="graydesc">Source: <span class="bold">'+cb+"</span></li></ul></ul>")}}),$(".sub-editor.matches .overflow",b).append('<div class="addtmx-tr white-tx"><a class="open-popup-addtm-tr">Add your personal TM</a></div>'),UI.markSuggestionTags(b),UI.setDeleteSuggestion(b),UI.lockTags(),UI.setContributionSourceDiff(),0===e&&(f=$("#"+j+" .matches ul.graysmall").first().find(".translation").html(),UI.copySuggestionInEditarea(b,f,d,h,!1,!0,1),UI.body.hasClass("searchActive")&&UI.addWarningToSearchDisplay(),UI.setChosenSuggestion(1),i=!0),$(".translated",b).removeAttr("disabled"),$(".draft",b).removeAttr("disabled")}else UI.debug&&console.log("no matches"),$(b).addClass("loaded"),$(".sub-editor.matches .overflow",b).append(config.mt_enabled&&!config.id_translator?'<ul class="graysmall message"><li>No matches could be found for this segment. Please, contact <a href="mailto:support@matecat.com">support@matecat.com</a> if you think this is an error.</li></ul>':'<ul class="graysmall message"><li>Translation Matches are not available when the TM feature is disabled</li></ul>')},setContribution:function(a,b,c){this.addToSetContributionTail("setContribution",a,b,c),this.offline||this.executingSetContribution||this.executingSetContributionMT||this.execSetContributionTail()},addToSetContributionTail:function(a,b,c,d){var e={operation:a,segment_id:b,status:c,byStatus:d};this.setContributionTail.push(e)},execSetContributionTail:function(){UI.setContributionTail.length&&(item=UI.setContributionTail[0],UI.setContributionTail.shift(),"setContribution"==item.operation?UI.execSetContribution(item.segment_id,item.status,item.byStatus):UI.execSetContributionMT(item.segment_id,item.status,item.byStatus))
},execSetContribution:function(a,b,c){return this.executingSetContribution=!0,logData={segment_id:a,status:b,byStatus:c},this.log("setContribution1",logData),segment=$("#segment-"+a),"draft"==b||"rejected"==b?!1:(this.log("setContribution2",{}),config.brPlaceholdEnabled?(source=this.postProcessEditarea(segment,".source"),target=this.postProcessEditarea(segment),this.log("setContribution3",{})):(source=$(".source",segment).text(),target=$(".editarea",segment).text()),this.log("setContribution4",{}),""===target&&c&&(this.log("setContribution5",{}),APP.alert({msg:"Cannot change status on an empty segment. Add a translation first!"})),""===target?(this.log("setContribution6",{}),!1):void this.updateContribution(source,target,a,b,c))},updateContribution:function(a,b,c){reqArguments=arguments,a=view2rawxliff(a),b=view2rawxliff(b),logData={source:a,target:b},this.log("updateContribution",logData),APP.doRequest({data:{action:"setContribution",id_job:config.job_id,source:a,target:b,source_lang:config.source_rfc,target_lang:config.target_rfc,password:config.password,id_translator:config.id_translator,private_translator:config.private_translator,id_customer:config.id_customer,private_customer:config.private_customer},context:reqArguments,error:function(){UI.addToSetContributionTail("setContribution",$(this)[2],$(this)[3],$(this)[4]),UI.failedConnection(this,"updateContribution")},success:function(a){console.log("execSetContribution success"),UI.executingSetContribution=!1,UI.removeFromStorage("contribution-"+config.job_id+"-"+c),UI.execSetContributionTail(),a.errors.length&&UI.processErrors(a.error,"setContribution")}})},setContributionMT:function(a,b,c){console.log("setContribution"),this.addToSetContributionTail("setContributionMT",a,b,c),this.offline||this.executingSetContribution||this.executingSetContributionMT||this.execSetContributionTail()},execSetContributionMT:function(a,b,c){return console.log("execSetContribution"),this.executingSetContributionMT=!0,segment=$("#segment-"+a),reqArguments=arguments,"draft"==b||"rejected"==b?!1:(config.brPlaceholdEnabled?(source=this.postProcessEditarea(segment,".source"),target=this.postProcessEditarea(segment)):(source=$(".source",segment).text(),target=$(".editarea",segment).text()),source=view2rawxliff(source),""===target&&c&&APP.alert({msg:"Cannot change status on an empty segment. Add a translation first!"}),""===target?!1:void this.updateContributionMT(source,target,a,b,c))},updateContributionMT:function(a,b){reqArguments=arguments,b=view2rawxliff(b);var c=$(segment).attr("id").split("-"),d=c[1],e=UI.editTime,f=$(".editarea",segment).data("lastChosenSuggestion");APP.doRequest({data:{action:"setContributionMT",id_segment:d,source:a,target:b,source_lang:config.source_lang,target_lang:config.target_lang,password:config.password,time_to_edit:e,id_job:config.job_id,chosen_suggestion_index:f},context:reqArguments,error:function(){UI.addToSetContributionTail("setContributionMT",$(this)[2],$(this)[3],$(this)[4]),UI.failedConnection(this,"setContributionMT")},success:function(a){console.log("execSetContributionMT success"),UI.executingSetContributionMT=!1,UI.execSetContributionTail(),a.errors.length&&UI.processErrors(a.error,"setContributionMT")}})},setDeleteSuggestion:function(a){$(".sub-editor .overflow a.trash",a).click(function(a){a.preventDefault();var b=$(this).parents(".graysmall");config.brPlaceholdEnabled?(source=UI.postProcessEditarea(b,".suggestion_source"),target=UI.postProcessEditarea(b,".translation")):(source=$(".suggestion_source",b).text(),target=$(".translation",b).text()),target=view2rawxliff(target),source=view2rawxliff(source),b.remove(),APP.doRequest({data:{action:"deleteContribution",source_lang:config.source_lang,target_lang:config.target_lang,id_job:config.job_id,password:config.password,seg:source,tra:target,id_translator:config.id_translator},error:function(){UI.failedConnection(0,"deleteContribution")},success:function(a){UI.setDeleteSuggestion_success(a)}})})},setDeleteSuggestion_success:function(a){a.errors.length&&this.processErrors(a.errors,"setDeleteSuggestion"),this.debug&&console.log("match deleted"),$(".editor .matches .graysmall").each(function(a){$(this).find(".graysmall-message").text(UI.suggestionShortcutLabel+(a+1)),$(this).attr("data-item",a+1)})},reinitMMShortcuts:function(){var a=this.isMac?"alt+meta":"alt+ctrl";$("body").unbind("keydown.alt1").unbind("keydown.alt2").unbind("keydown.alt3").unbind("keydown.alt4").unbind("keydown.alt5"),$("body, .editarea").bind("keydown.alt1",a+"+1",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("1")}).bind("keydown.alt2",a+"+2",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("2")}).bind("keydown.alt3",a+"+3",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("3")}).bind("keydown.alt4",a+"+4",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("4")}).bind("keydown.alt5",a+"+5",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("5")}).bind("keydown.alt6",a+"+6",function(a){a.preventDefault(),a.stopPropagation(),UI.chooseSuggestion("6")})},setChosenSuggestion:function(a){this.editarea.data("lastChosenSuggestion",a)},setContributionSourceDiff:function(){sourceText="",$.each($.parseHTML($(".editor .source").html()),function(){sourceText+="#text"==this.nodeName?this.data:this.innerText}),UI.currentSegment.find(".sub-editor.matches ul.suggestion-item").each(function(){percent=parseInt($(this).find(".graysmall-details .percent").text().split("%")[0]),percent>74&&(ss=$(this).find(".suggestion_source"),suggestionSourceText="",$.each($.parseHTML($(ss).html()),function(){suggestionSourceText+="#text"==this.nodeName?this.data:this.innerText}),$(this).find(".suggestion_source").html(UI.dmp.diff_prettyHtml(UI.execDiff(sourceText,suggestionSourceText))))})},setContributionSourceDiff_Old:function(){sourceText="",$.each($.parseHTML($(".editor .source").html()),function(){sourceText+="#text"==this.nodeName?this.data:this.innerText}),console.log("sourceText: ",sourceText),UI.currentSegment.find(".sub-editor.matches ul.suggestion-item").each(function(){ss=$(this).find(".suggestion_source"),suggestionSourceText="",$.each($.parseHTML($(ss).html()),function(){suggestionSourceText+="#text"==this.nodeName?this.data:this.innerText}),console.log("suggestionSourceText: ",suggestionSourceText),console.log("diff: ",UI.execDiff(sourceText,suggestionSourceText)),diff=UI.dmp.diff_main(sourceText,suggestionSourceText),diffTxt="",$.each(diff,function(){diffTxt+=-1==this[0]?"<del>"+this[1]+"</del>":1==this[0]?"<ins>"+this[1]+"</ins>":this[1]}),console.log("diffTxt: ",diffTxt),$(ss).html(diffTxt),UI.lockTags()})}}),$("html").on("copySourceToTarget","section",function(){UI.lockTags(UI.editarea)}),$.extend(UI,{noTagsInSegment:function(a){if(editarea=a.area,starting=a.starting)return!1;try{return $(editarea).html().match(/\&lt;.*?\&gt;/gi)?!1:!0}catch(b){return!0}},tagCompare:function(a,b,c){for(var d=!1,e=0;e<a.length;e++)for(var f=0;f<b.length;f++)a[e]==b[f]&&(a.splice(e,1),b.splice(f,1),UI.tagCompare(a,b,c++));return d=a.length||b.length?!0:!1},disableTagMark:function(){this.taglockEnabled=!1,this.body.addClass("tagmarkDisabled"),$(".source span.locked").each(function(){$(this).replaceWith($(this).html())}),$(".editarea span.locked").each(function(){$(this).replaceWith($(this).html())})},enableTagMark:function(){this.taglockEnabled=!0,this.body.removeClass("tagmarkDisabled"),saveSelection(),this.markTags(),restoreSelection()},markSuggestionTags:function(a){return this.taglockEnabled?($(".footer .suggestion_source",a).each(function(){$(this).html($(this).html().replace(/(&lt;[\/]*(g|x|bx|ex|bpt|ept|ph|it|mrk).*?&gt;)/gi,'<span contenteditable="false" class="locked">$1</span>')),$(this).html(UI.isFirefox?$(this).html().replace(/(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"):$(this).html().replace(/(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>")),UI.detectTagType(this)}),void $(".footer .translation").each(function(){$(this).html($(this).html().replace(/(&lt;[\/]*(g|x|bx|ex|bpt|ept|ph|it|mrk).*?&gt;)/gi,'<span contenteditable="false" class="locked">$1</span>')),$(this).html(UI.isFirefox?$(this).html().replace(/(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(<span class=\"(.*?locked.*?)\" contenteditable=\"false\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>"):$(this).html().replace(/(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(<span contenteditable=\"false\" class=\"(.*?locked.*?)\"\>)(.*?)(<\/span\>){2,}/gi,"$1$5</span>")),UI.detectTagType(this)})):!1},markTags:function(){return this.taglockEnabled?this.noTagsInSegment({area:!1,starting:!0})?!1:void $(".source, .editarea").each(function(){UI.lockTags(this)}):!1},markTagsInSearch:function(a){if(!this.taglockEnabled)return!1;var b="undefined"==typeof a?$(".editor .cc-search .input"):a;b.each(function(){})},lockTags:function(a){return this.body.hasClass("tagmarkDisabled")?!1:(editarea="undefined"==typeof a?UI.editarea:a,a="undefined"==typeof a?UI.editarea:a,this.taglockEnabled?""!=a&&this.noTagsInSegment({area:a,starting:!1})?!1:void $(editarea).first().each(function(){saveSelection();var a=$(this).html();brTx1=UI.isFirefox?'<pl class="locked" contenteditable="false">$1</pl>':'<pl contenteditable="false" class="locked">$1</pl>',brTx2=UI.isFirefox?'<span class="locked" contenteditable="false">$1</span>':'<span contenteditable="false" class="locked">$1</span>',a=a.replace(/<span/gi,"<pl").replace(/<\/span/gi,"</pl").replace(/&lt;/gi,"<").replace(/(<(g|x|bx|ex|bpt|ept|ph[^a-z]*|it|mrk)\sid[^<]*?&gt;)/gi,brTx1).replace(/</gi,"&lt;").replace(/\&lt;pl/gi,"<span").replace(/\&lt;\/pl/gi,"</span").replace(/\&lt;div\>/gi,"<div>").replace(/\&lt;\/div\>/gi,"</div>").replace(/\&lt;br\>/gi,"<br>").replace(/\&lt;br class=["\'](.*?)["\'][\s]*[\/]*(\&gt;|\>)/gi,'<br class="$1" />').replace(/(&lt;\s*\/\s*(g|x|bx|ex|bpt|ept|ph|it|mrk)\s*&gt;)/gi,brTx2),a=UI.isFirefox?a.replace(/(<span class="[^"]*" contenteditable="false"\>)(:?<span class="[^"]*" contenteditable="false"\>)(.*?)(<\/span\>){2}/gi,"$1$3</span>"):a.replace(/(<span contenteditable="false" class="[^"]*"\>)(:?<span contenteditable="false" class="[^"]*"\>)(.*?)(<\/span\>){2}/gi,"$1$3</span>"),a=a.replace(/(<\/span\>)$(\s){0,}/gi,"</span> "),a=a.replace(/(<\/span\>\s)$/gi,'</span><br class="end">');var b=$("span.locked",this).length;$(this).html(a),restoreSelection(),$("span.locked",this).length!=b&&UI.closeTagAutocompletePanel(),segment=$(this).parents("section"),$("span.locked",this).length?segment.addClass("hasTags"):segment.removeClass("hasTags"),$("span.locked",this).addClass("monad"),UI.detectTagType(this)}):!1)},detectTagType:function(a){$("span.locked",a).each(function(){$(this).addClass($(this).text().startsWith("</")?"endTag":$(this).text().endsWith("/>")?"selfClosingTag":"startTag")})},unlockTags:function(){return this.taglockEnabled?void this.editarea.html(this.removeLockTagsFromString(this.editarea.html())):!1},removeLockTagsFromString:function(a){return a.replace(/<span contenteditable=\"false\" class=\"locked\"\>(.*?)<\/span\>/gi,"$1")},cleanDroppedTag:function(a,b){this.droppingInEditarea=!1,diff=this.dmp.diff_main(b,$(a).html()),draggedText="",$(diff).each(function(){1==this[0]&&(draggedText+=this[1])}),draggedText=draggedText.replace(/^(\&nbsp;)(.*?)(\&nbsp;)$/gi,"$2"),dr2=draggedText.replace(/(<br>)$/,"").replace(/(<span.*?>)\&nbsp;/,"$1"),a.html(a.html().replace(draggedText,dr2)),div=document.createElement("div"),div.innerHTML=draggedText,isMarkup=draggedText.match(/^<span style=\"font\-size\: 13px/gi),saveSelection(),$("span .rangySelectionBoundary",a).length>1&&$(".rangySelectionBoundary",a).last().remove(),$("span .rangySelectionBoundary",a).length&&(spel=$("span",a).has(".rangySelectionBoundary"),rsb=$("span .rangySelectionBoundary",a).detach(),spel.after(rsb)),phcode=$(".rangySelectionBoundary")[0].outerHTML,$(".rangySelectionBoundary").text(this.cursorPlaceholder),newTag=$(div).text();var c=a;$("br",c).each(function(){$(this).replaceWith('[**[br class="'+this.className+'"]**]')}),newText=c.text().replace(draggedText,newTag),c=null,"undefined"==typeof phcode&&(phcode=""),a.text(newText),a.html(a.html().replace(this.cursorPlaceholder,phcode)),restoreSelection(),a.html(a.html().replace(this.cursorPlaceholder,"").replace(/\[\*\*\[(.*?)\]\*\*\]/gi,"<$1>"))},setTagMode:function(){this.custom.extended_tagmode?this.setExtendedTagMode():this.setCrunchedTagMode()},setExtendedTagMode:function(){this.body.addClass("tagmode-default-extended"),"undefined"!=typeof UI.currentSegment&&UI.pointToOpenSegment(),this.custom.extended_tagmode=!0,this.saveCustomization()},setCrunchedTagMode:function(){this.body.removeClass("tagmode-default-extended"),"undefined"!=typeof UI.currentSegment&&UI.pointToOpenSegment(),this.custom.extended_tagmode=!1,this.saveCustomization()},enableTagMode:function(){UI.render({tagModesEnabled:!0})},disableTagMode:function(){UI.render({tagModesEnabled:!1})},nearTagOnRight:function(a,b){return $(b[a]).hasClass("locked")?0==UI.numCharsUntilTagRight?(indexTags=0,$.each(b,function(b){return b==a?!1:void($(this).hasClass("locked")&&indexTags++)}),!0):!1:"undefined"==typeof b[a]?!1:("#text"==b[a].nodeName&&(UI.numCharsUntilTagRight+=b[a].data.length),void this.nearTagOnRight(a+1,b))},nearTagOnLeft:function(a,b){return 0>a?!1:$(b[a]).hasClass("locked")?0==UI.numCharsUntilTagLeft?(indexTags=0,$.each(b,function(b){return b==a?!1:void($(this).hasClass("locked")&&indexTags++)}),!0):!1:("#text"==b[a].nodeName&&(UI.numCharsUntilTagLeft+=b[a].data.length),void this.nearTagOnLeft(a-1,b))},checkTagProximity:function(){return""==UI.editarea.html()?!1:(selection=window.getSelection(),selection.rangeCount<1?!1:(range=selection.getRangeAt(0),range.collapsed?(nextEl=$(range.endContainer.nextElementSibling),prevEl=$(range.endContainer.previousElementSibling),tempRange=range,UI.editarea.find(".test-invisible").remove(),pasteHtmlAtCaret('<span class="test-invisible"></span>'),coso=$.parseHTML(UI.editarea.html()),void $.each(coso,function(a){return $(this).hasClass("test-invisible")?(UI.numCharsUntilTagRight=0,UI.numCharsUntilTagLeft=0,nearTagOnRight=UI.nearTagOnRight(a+1,coso),nearTagOnLeft=UI.nearTagOnLeft(a-1,coso),"undefined"!=typeof nearTagOnRight&&nearTagOnRight?(UI.removeHighlightCorrespondingTags(),UI.highlightCorrespondingTags($(UI.editarea.find(".locked")[indexTags]))):"undefined"!=typeof nearTagOnLeft&&nearTagOnLeft?(UI.removeHighlightCorrespondingTags(),UI.highlightCorrespondingTags($(UI.editarea.find(".locked")[indexTags]))):UI.removeHighlightCorrespondingTags(),UI.numCharsUntilTagRight=null,UI.numCharsUntilTagLeft=null,UI.editarea.find(".test-invisible").remove(),!1):void 0})):!0))},highlightCorrespondingTags:function(a){a.hasClass("startTag")?a.next(".endTag").length?a.next(".endTag").addClass("highlight"):(num=1,ind=0,$(a).nextAll(".locked").each(function(){if(ind++,$(this).hasClass("startTag"))num++;else if($(this).hasClass("selfClosingTag"));else if(num--,0==num)return pairEl=$(this),!1}),$(pairEl).addClass("highlight")):a.hasClass("endTag")&&(a.prev(".startTag").length?a.prev(".startTag").first().addClass("highlight"):(num=1,ind=0,$(a).prevAll(".locked").each(function(){if(ind++,$(this).hasClass("endTag"))num++;else if($(this).hasClass("selfClosingTag"));else if(num--,0==num)return pairEl=$(this),!1}),$(pairEl).addClass("highlight"))),$(a).addClass("highlight")},removeHighlightCorrespondingTags:function(){$(UI.editarea).find(".locked.highlight").removeClass("highlight")},markTagMismatch:function(a){$.parseJSON(a.warnings).length,"undefined"==typeof a.tag_mismatch.order||""===a.tag_mismatch.order?("undefined"!=typeof a.tag_mismatch.source&&$.each(a.tag_mismatch.source,function(b){$("#segment-"+a.id_segment+" .source span.locked:not(.temp)").filter(function(){return $(this).text()===a.tag_mismatch.source[b]}).last().addClass("temp")}),"undefined"!=typeof a.tag_mismatch.target&&$.each(a.tag_mismatch.target,function(b){$("#segment-"+a.id_segment+" .editarea span.locked:not(.temp)").filter(function(){return $(this).text()===a.tag_mismatch.target[b]}).last().addClass("temp")}),$("#segment-"+a.id_segment+" span.locked.mismatch").addClass("mismatch-old").removeClass("mismatch"),$("#segment-"+a.id_segment+" span.locked.temp").addClass("mismatch").removeClass("temp"),$("#segment-"+a.id_segment+" span.locked.mismatch-old").removeClass("mismatch-old")):$("#segment-"+a.id_segment+" .editarea .locked").filter(function(){return $(this).text()===a.tag_mismatch.order[0]}).addClass("order-error")},checkAutocompleteTags:function(){if(added=this.getPartialTagAutocomplete(),$(".tag-autocomplete li.hidden").removeClass("hidden"),$(".tag-autocomplete li").each(function(){var a=$(this).text();a.substring(0,added.length)===added?$(this).removeClass("hidden"):$(this).addClass("hidden")}),$(".tag-autocomplete li:not(.hidden)").length)$(".tag-autocomplete li.current").removeClass("current"),$(".tag-autocomplete li:not(.hidden)").first().addClass("current"),$(".tag-autocomplete").removeClass("empty"),UI.preCloseTagAutocomplete=!1;else{if($(".tag-autocomplete").addClass("empty"),UI.preCloseTagAutocomplete)return UI.closeTagAutocompletePanel(),!1;UI.preCloseTagAutocomplete=!0}},closeTagAutocompletePanel:function(){$(".tag-autocomplete, .tag-autocomplete-endcursor").remove(),UI.preCloseTagAutocomplete=!1},getPartialTagAutocomplete:function(){var a=UI.editarea.html().match(/&lt;(?:[a-z]*(?:&nbsp;)*["\w\s\/=]*)?<span class="tag-autocomplete-endcursor">/gi);return a=null===a?"":htmlDecode(a[0].replace(/<span class="tag-autocomplete-endcursor"\>/gi,"")).replace(/\xA0/gi," ")},openTagAutocompletePanel:function(){if(!UI.sourceTags.length)return!1;$(".tag-autocomplete-marker").remove();var a=document.createElement("span");a.setAttribute("class","tag-autocomplete-marker"),insertNodeAtCursor(a);var b=document.createElement("span");b.setAttribute("class","tag-autocomplete-endcursor"),insertNodeAtCursor(b);var c=$(".tag-autocomplete-marker").offset(),d=$(":first-child",UI.editarea).hasClass("tag-autocomplete-endcursor")?30:20;$(".tag-autocomplete-marker").remove(),UI.body.append('<div class="tag-autocomplete"><ul></ul></div>');var e=function(a){return a.reduce(function(a,b){return a.indexOf(b)<0&&a.push(b),a},[])};UI.sourceTags=e(UI.sourceTags),$.each(UI.sourceTags,function(a){$(".tag-autocomplete ul").append("<li"+(0===a?' class="current"':"")+">"+this+"</li>")}),$(".tag-autocomplete").css("top",c.top+d),$(".tag-autocomplete").css("left",c.left),this.checkAutocompleteTags()},jumpTag:function(a){"undefined"!=typeof a.endContainer.data&&a.endContainer.data.length==a.endOffset&&"monad"==a.endContainer.nextElementSibling.className&&setCursorAfterNode(a,a.endContainer.nextElementSibling)}}),$.extend(UI,{getConcordance:function(a,b){$(".cc-search",UI.currentSegment).addClass("loading"),$(".sub-editor.concordances .overflow .results",this.currentSegment).empty(),a=view2rawxliff(a),APP.doRequest({data:{action:"getContribution",is_concordance:1,from_target:b,id_segment:UI.currentSegmentId,text:a,id_job:config.job_id,num_results:UI.numMatchesResults,id_translator:config.id_translator,password:config.password},error:function(){UI.failedConnection(this,"getConcordance")},success:function(a){UI.renderConcordances(a,b)}})},openConcordance:function(){this.closeContextMenu(),$(".editor .submenu .tab-switcher-cc a").click(),$(".editor .cc-search .input").text(""),$(".editor .concordances .results").empty();var a=$(this.currentSearchInTarget?".editor .cc-search .search-target":".editor .cc-search .search-source");$(a).text(this.currentSelectedText),this.getConcordance(this.currentSelectedText,this.currentSearchInTarget)},preOpenConcordance:function(){var a=window.getSelection();if("Range"==a.type){var b=$(a.baseNode.parentElement).hasClass("source"),c=a.toString().trim();c.length&&(this.currentSelectedText=c,this.currentSearchInTarget=b?0:1,this.openConcordance())}},setExtendedConcordances:function(a){a?($(".sub-editor.concordances .overflow").css("height",$(".sub-editor.concordances").height()+"px"),$(".sub-editor.concordances").addClass("extended"),$(".sub-editor.concordances .more").length?$(".sub-editor.concordances .more").text("Fewer"):$(".sub-editor.concordances",segment).append('<a href="#" class="more">Fewer</a>'),this.custom.extended_concordance=!0,this.saveCustomization()):($(".sub-editor.concordances").removeClass("extended"),$(".sub-editor.concordances .overflow").removeAttr("style"),$(".sub-editor.concordances .more").length?$(".sub-editor.concordances .more").text("More"):$(".sub-editor.concordances",segment).append('<br class="clear"><a href="#" class="more">More</a>'),this.custom.extended_concordance=!1,this.saveCustomization())},renderConcordances:function(a,b){segment=this.currentSegment,segment_id=this.currentSegmentId,$(".sub-editor.concordances .overflow .results",segment).empty(),$(".sub-editor.concordances .overflow .message",segment).remove(),a.data.matches.length?($.each(a.data.matches,function(a){if(""!==this.segment&&""!==this.translation){prime=a<UI.numDisplayContributionMatches?" prime":"";var c="0"==this.id?!0:!1;cb=this.created_by,cl_suggestion=UI.getPercentuageClass(this.match);var d=b?this.translation:this.segment;d=UI.decodePlaceholdersToText(d),d=d.replace(/\#\{/gi,"<mark>"),d=d.replace(/\}\#/gi,"</mark>");var e=b?this.segment:this.translation;e=UI.decodePlaceholdersToText(e),e=e.replace(/\#\{/gi,"<mark>"),e=e.replace(/\}\#/gi,"</mark>"),$(".sub-editor.concordances .overflow .results",segment).append('<ul class="graysmall'+prime+'" data-item="'+(a+1)+'" data-id="'+this.id+'"><li class="sugg-source">'+(c?"":' <a id="'+segment_id+"-tm-"+this.id+'-delete" href="#" class="trash" title="delete this row"></a>')+'<span id="'+segment_id+"-tm-"+this.id+'-source" class="suggestion_source">'+d+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span id="'+segment_id+"-tm-"+this.id+'-translation" class="translation">'+e+'</span></li><ul class="graysmall-details"><!-- li class="percent '+cl_suggestion+'">'+this.match+"</li --><li>"+this.last_update_date+'</li><li class="graydesc">Source: <span class="bold">'+cb+"</span></li></ul></ul>")}}),UI.setExtendedConcordances(UI.custom.extended_concordance?!0:!1)):(console.log("no matches"),$(".sub-editor.concordances .overflow",segment).append('<ul class="graysmall message"><li>Can\'t find any matches. Check the language combination.</li></ul>')),$(".cc-search",this.currentSegment).removeClass("loading"),this.setDeleteSuggestion(segment)},markTagsInSearch:function(a){if(!this.taglockEnabled)return!1;var b="undefined"==typeof a?$(".editor .cc-search .input"):a;b.each(function(){})}}),$.extend(UI,{deleteGlossaryItem:function(a){APP.doRequest({data:{action:"glossary",exec:"delete",segment:a.find(".suggestion_source").text(),translation:a.find(".translation").text(),id_job:config.job_id,password:config.password},error:function(){UI.failedConnection(0,"deleteGlossaryItem")}}),dad=$(a).prevAll(".glossary-item").first(),$(a).remove(),($(dad).next().hasClass("glossary-item")||!$(dad).next().length)&&($(dad).remove(),numLabel=$(".tab-switcher-gl a .number",UI.currentSegment),num=parseInt(numLabel.attr("data-num"))-1,num?$(numLabel).text("("+num+")").attr("data-num",num):$(numLabel).text("").attr("data-num",0))},getGlossary:function(a,b,c){return"undefined"!=typeof c?b&&(n=$(0===c?a:1==c?"#segment-"+this.nextSegmentId:"#segment-"+this.nextUntranslatedSegmentId)):n=a,$(n).addClass("glossary-loaded"),$(".gl-search",n).addClass("loading"),config.tms_enabled&&($(".sub-editor.glossary .overflow .results",n).empty(),$(".sub-editor.glossary .overflow .graysmall.message",n).empty()),txt=b?htmlDecode($(".text .source",n).attr("data-original")):view2rawxliff($(".gl-search .search-source",n).text()),"undefined"==typeof txt||""==txt?!1:void APP.doRequest({data:{action:"glossary",exec:"get",segment:txt,automatic:b,translation:null,id_job:config.job_id,password:config.password},context:[n,c],error:function(){UI.failedConnection(0,"glossary")},success:function(a){"undefined"!=typeof a.errors&&a.errors.length&&-1==a.errors[0].code&&(UI.noGlossary=!0),n=this[0],UI.processLoadedGlossary(a,this),this[1]||UI.markGlossaryItemsInSource(a,this)},complete:function(){$(".gl-search",UI.currentSegment).removeClass("loading")}})},processLoadedGlossary:function(a,b){segment=b[0],next=b[1],(1==next||2==next)&&($(".footer .submenu",segment).length||setTimeout(function(){UI.processLoadedGlossary(a,b)},200)),numMatches=Object.size(a.data.matches),numMatches?(UI.renderGlossary(a,segment),$(".tab-switcher-gl a .number",segment).text("("+numMatches+")").attr("data-num",numMatches)):$(".tab-switcher-gl a .number",segment).text("").attr("data-num",0)},markGlossaryItemsInSource:function(a){if(Object.size(a.data.matches)){i=0,cleanString=$(".source",UI.currentSegment).html();var b=[];matches=[],$.each(a.data.matches,function(){matches.push(this[0].raw_segment)}),matchesToRemove=[],$.each(matches,function(a){$.each(matches,function(b){a!=b&&matches[a].indexOf(this)>-1&&matchesToRemove.push(matches[b])})}),$.each(a.data.matches,function(a){if(i++,k1=UI.decodePlaceholdersToText(a,!0),toRemove=!1,$.each(matchesToRemove,function(){this==k1&&(toRemove=!0)}),toRemove)return!0;k2=k1.replace(/<\//gi,"<\\/").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)");var c=new RegExp(k2.trim(),"gi"),d=cleanString;coso=d.replace(c,"<mark>"+k1+"</mark>"),-1!=coso.indexOf("<mark>")&&(int={x:coso.indexOf("<mark>"),y:coso.indexOf("</mark>")-6},b.push(int))}),UI.intervalsUnion=[],UI.checkIntervalsUnions(b),UI.startGlossaryMark='<mark class="inGlossary">',UI.endGlossaryMark="</mark>",markLength=UI.startGlossaryMark.length+UI.endGlossaryMark.length,sourceString=$(".editor .source").html(),$.each(UI.intervalsUnion,function(a){added=markLength*a,sourceString=sourceString.splice(this.x+added,0,UI.startGlossaryMark),sourceString=sourceString.splice(this.y+added+UI.startGlossaryMark.length,0,UI.endGlossaryMark),$(".editor .source").html(sourceString)}),$(".editor .source mark mark").each(function(){$(this).replaceWith($(this).html())})}},removeGlossaryMarksFormSource:function(){$(".editor mark.inGlossary").each(function(){$(this).replaceWith($(this).html())})},checkIntervalsUnions:function(a){return UI.endedIntervalAnalysis=!1,smallest=UI.smallestInterval(a),$.each(a,function(a){this===smallest&&(smallestIndex=a)}),mod=0,$.each(a,function(b){b!=smallestIndex&&smallest.x<=this.x&&smallest.y>=this.x&&(mod++,smallest.y=this.y,a.splice(b,1),UI.checkIntervalsUnions(a))}),UI.endedIntervalAnalysis?a.length?(UI.checkIntervalsUnions(a),!1):!1:(smallest.x<1e6&&UI.intervalsUnion.push(smallest),"undefined"==typeof smallestIndex?smallestIndex=0:null,a.splice(smallestIndex,1),a.length?(mod||UI.checkIntervalsUnions(a),UI.endedIntervalAnalysis=!0,!1):!1)},smallestInterval:function(a){return smallest={x:1e6,y:2e6},$.each(a,function(){this.x<smallest.x&&(smallest=this)}),smallest},renderGlossary:function(a,b){segment=b,segment_id=segment.attr("id"),$(".sub-editor.glossary .overflow .results",segment).empty(),$(".sub-editor.glossary .overflow .message",segment).remove(),numRes=0,Object.size(a.data.matches)?$.each(a.data.matches,function(a){numRes++,$(".sub-editor.glossary .overflow .results",segment).append('<div class="glossary-item"><span>'+a+"</span></div>"),$.each(this,function(a){if(""!==this.segment&&""!==this.translation){var b="0"==this.id?!0:!1;cb=this.created_by,this.comment="undefined"==typeof this.target_note?"":this.target_note,cl_suggestion=UI.getPercentuageClass(this.match);var c=this.segment;c=c.replace(/\#\{/gi,"<mark>"),c=c.replace(/\}\#/gi,"</mark>");var d=this.translation;d=d.replace(/\#\{/gi,"<mark>"),d=d.replace(/\}\#/gi,"</mark>"),$(".sub-editor.glossary .overflow .results",segment).append('<ul class="graysmall" data-item="'+(a+1)+'" data-id="'+this.id+'"><li class="sugg-source">'+(b?"":' <a id="'+segment_id+"-tm-"+this.id+'-delete" href="#" class="trash" title="delete this row"></a>')+'<span id="'+segment_id+"-tm-"+this.id+'-source" class="suggestion_source">'+UI.decodePlaceholdersToText(c,!0)+'</span></li><li class="b sugg-target"><!-- span class="switch-editing">Edit</span --><span id="'+segment_id+"-tm-"+this.id+'-translation" class="translation">'+UI.decodePlaceholdersToText(d,!0)+'</span></li><li class="details">'+(""===this.comment?"":'<div class="comment">'+this.comment+"</div>")+'<ul class="graysmall-details"><li>'+this.last_update_date+'</li><li class="graydesc">Source: <span class="bold">'+cb+"</span></li></ul></li></ul>")}})}):(console.log("no matches"),$(".sub-editor.glossary .overflow",segment).append('<ul class="graysmall message"><li>Sorry. Can\'t help you this time.</li></ul>'))},setGlossaryItem:function(){$(".gl-search",UI.currentSegment).addClass("setting"),APP.doRequest({data:{action:"glossary",exec:"set",segment:UI.currentSegment.find(".gl-search .search-source").text(),translation:UI.currentSegment.find(".gl-search .search-target").text(),comment:UI.currentSegment.find(".gl-search .gl-comment").text(),id_job:config.job_id,password:config.password},context:[UI.currentSegment,next],error:function(){UI.failedConnection(0,"glossary")},success:function(a){a.data.created_tm_key?(UI.footerMessage("A Private TM Key has been created for this job",this[0]),UI.noGlossary=!1):(msg=a.errors.length?a.errors[0].message:"A glossary item has been added",UI.footerMessage(msg,this[0])),UI.processLoadedGlossary(a,this)},complete:function(){$(".gl-search",UI.currentSegment).removeClass("setting")}})},copyGlossaryItemInEditarea:function(a){translation=a.find(".translation").text(),$(".editor .editarea .focusOut").before(translation+'<span class="tempCopyGlossaryPlaceholder"></span>').remove(),this.lockTags(this.editarea),range=window.getSelection().getRangeAt(0),node=$(".editor .editarea .tempCopyGlossaryPlaceholder")[0],setCursorAfterNode(range,node),$(".editor .editarea .tempCopyGlossaryPlaceholder").remove(),this.highlightEditarea()}}),$.extend(UI,{applySearch:function(a){this.body.hasClass("searchActive")&&this.markSearchResults({singleSegment:a,where:"no"})},resetSearch:function(){console.log("reset search"),this.body.removeClass("searchActive"),this.clearSearchMarkers(),this.setFindFunction("find"),$("#exec-find").removeAttr("disabled"),this.enableTagMark()},execFind:function(){if(this.searchResultsSegments=!1,$(".search-display").removeClass("displaying"),$("section.currSearchSegment").removeClass("currSearchSegment"),""!==$("#search-source").val()?this.searchParams.source=$("#search-source").val():delete this.searchParams.source,""!==$("#search-target").val()?(this.searchParams.target=$("#search-target").val(),$("#enable-replace").is(":checked")&&$("#replace-target, #exec-replace, #exec-replaceall").removeAttr("disabled")):(delete this.searchParams.target,$("#replace-target, #exec-replace, #exec-replaceall").attr("disabled","disabled")),""!==$("#select-status").val()?(this.searchParams.status=$("#select-status").val(),this.body.attr("data-filter-status",$("#select-status").val())):delete this.searchParams.status,""!==$("#replace-target").val()?this.searchParams.replace=$("#replace-target").val():delete this.searchParams.replace,this.searchParams["match-case"]=$("#match-case").is(":checked"),this.searchParams["exact-match"]=$("#exact-match").is(":checked"),this.searchParams.search=1,"undefined"==typeof this.searchParams.source&&"undefined"==typeof this.searchParams.target&&"all"==this.searchParams.status)return APP.alert({msg:"Enter text in source or target input boxes<br /> or select a status."}),!1;this.disableTagMark();var a=this.searchParams;this.searchMode="undefined"==typeof a.source&&"undefined"==typeof a.target?"onlyStatus":"undefined"!=typeof a.source&&"undefined"!=typeof a.target?"source&target":"normal","onlyStatus"==this.searchMode||"source&target"==this.searchMode;
var b=a.source?a.source:"",c=a.target?a.target:"",d=a.replace?a.replace:"";this.markSearchResults(),this.gotoSearchResultAfter({el:"segment-"+this.currentSegmentId}),this.setFindFunction("next"),this.body.addClass("searchActive");var e=new Date;APP.doRequest({data:{action:"getSearch","function":"find",job:config.job_id,token:e.getTime(),password:config.password,source:b,target:c,status:this.searchParams.status,matchcase:this.searchParams["match-case"],exactmatch:this.searchParams["exact-match"],replace:d},success:function(a){UI.execFind_success(a)}})},execFind_success:function(a){console.log("execFind_success"),this.numSearchResultsItem=a.total,this.searchResultsSegments=a.segments,this.numSearchResultsSegments=a.segments?a.segments.length:0,this.updateSearchDisplay(),this.pendingRender&&(this.pendingRender.detectSegmentToScroll&&(this.pendingRender.segmentToScroll=this.nextUnloadedResultSegment()),$("#outer").empty(),this.render(this.pendingRender),this.pendingRender=!1)},execReplaceAll:function(){if($(".search-display .numbers").text("No segments found"),$(".editarea mark.searchMarker").remove(),this.applySearch(),""===$("#search-target").val())return APP.alert({msg:"You must specify the Target value to replace."}),delete this.searchParams.target,!1;if(this.searchParams.target=$("#search-target").val(),""===$("#replace-target").val())return APP.alert({msg:"You must specify the replacement value."}),delete this.searchParams.replace,!1;this.searchParams.replace=$("#replace-target").val(),""!==$("#select-status").val()?(this.searchParams.status=$("#select-status").val(),this.body.attr("data-filter-status",$("#select-status").val())):delete this.searchParams.status,this.searchParams["match-case"]=$("#match-case").is(":checked"),this.searchParams["exact-match"]=$("#exact-match").is(":checked");var a=this.searchParams,b=a.source?a.source:"",c=a.target?a.target:"",d=a.replace?a.replace:"",e=new Date;APP.doRequest({data:{action:"getSearch","function":"replaceAll",job:config.job_id,token:e.getTime(),password:config.password,source:b,target:c,status:a.status,matchcase:a["match-case"],exactmatch:a["exact-match"],replace:d},success:function(a){return a.errors.length?(APP.alert({msg:a.errors[0].message}),!1):($("#outer").empty(),void UI.render({firstLoad:!1}))}})},checkSearchStrings:function(){s=this.searchParams.source,s.match(/[<\>]/gi)?this.disableTagMark():this.enableTagMark()},updateSearchDisplay:function(){"onlyStatus"==this.searchMode?(res=this.numSearchResultsSegments?this.numSearchResultsSegments:0,resNumString=1==res?"":"s",numbers=res?'Found <span class="segments">...</span> segment'+resNumString:"No segments found",$(".search-display .numbers").html(numbers)):"source&target"==this.searchMode?(res=this.numSearchResultsSegments?this.numSearchResultsSegments:0,resNumString=1==res?"":"s",numbers=res?'Found <span class="segments">...</span> segment'+resNumString:"No segments found",$(".search-display .numbers").html(numbers)):(res=this.numSearchResultsItem?this.numSearchResultsItem:0,resNumString=1==res?"":"s",numbers=res?'Found <span class="results">...</span> result'+resNumString+' in <span class="segments">...</span> segment'+resNumString:"No segments found",$(".search-display .numbers").html(numbers),$(".search-display .results").text(res)),$(".search-display .segments").text(this.numSearchResultsSegments),query="",this.searchParams["exact-match"]&&(query+=" exactly"),this.searchParams.source&&(query+=' <span class="param">'+this.searchParams.source+"</span> in source"),this.searchParams.target&&(query+=' <span class="param">'+this.searchParams.target+"</span> in target"),this.searchParams.status&&(query+=(this.searchParams.source||this.searchParams.target?" and":"")+' status <span class="param">'+this.searchParams.status+"</span>"),query+=" ("+(this.searchParams["match-case"]?"case sensitive":"case insensitive")+")",$(".search-display .query").html(query),$(".search-display").addClass("displaying"),"normal"==this.searchMode&&this.numSearchResultsItem<2&&$("#exec-find[data-func=next]").attr("disabled","disabled"),"source&target"==this.searchMode&&this.numSearchResultsSegments<2&&$("#exec-find[data-func=next]").attr("disabled","disabled"),this.updateSearchItemsCount(),this.someSegmentToSave()?this.addWarningToSearchDisplay():this.removeWarningFromSearchDisplay()},addWarningToSearchDisplay:function(){$(".search-display .found .warning").length||$(".search-display .found").append('<span class="warning"></span>'),$(".search-display .found .warning").text(" (maybe some results in segments modified but not saved)")},removeWarningFromSearchDisplay:function(){$(".search-display .found .warning").remove()},updateSearchDisplayCount:function(a){numRes=$(".search-display .numbers .results"),numRes.text(parseInt(numRes.text())-1),$(".targetarea mark.searchMarker",a).length-1===0&&(numSeg=$(".search-display .numbers .segments"),numSeg.text(parseInt(numSeg.text())-1)),this.updateSearchItemsCount()},updateSearchItemsCount:function(){c=parseInt($(".search-display .numbers .results").text()),c>0&&$("#filterSwitch .numbererror").text(c).attr("title",$(".search-display .found").text())},execNext:function(){this.gotoNextResultItem(!1)},markSearchResults:function(a){a=a||{},where=a.where,seg=a.seg,singleSegment=a.singleSegment||!1,"undefined"==typeof where&&this.clearSearchMarkers();var b=this.searchParams,c=b["match-case"]?"contains":"containsNC",d=b["match-case"]?"":"i";if(openTagReg=new RegExp(UI.openTagPlaceholder,"g"),closeTagReg=new RegExp(UI.closeTagPlaceholder,"g"),"onlyStatus"==this.searchMode);else if("source&target"==this.searchMode){console.log("source & target"),status="all"==b.status?"":".status-"+b.status,q=singleSegment?"#"+$(singleSegment).attr("id"):"section"+status+":not(.status-new)",psource=b.source.replace(/(\W)/gi,"\\$1"),ptarget=b.target.replace(/(\W)/gi,"\\$1");var e=new RegExp("("+htmlEncode(psource).replace(/\(/g,"\\(").replace(/\)/g,"\\)")+")","g"+d),f=new RegExp("("+htmlEncode(ptarget).replace(/\(/g,"\\(").replace(/\)/g,"\\)")+")","g"+d);txtSrc=b.source,txtTrg=b.target,srcHasTags=null!==txtSrc.match(/<.*?\>/gi)?!0:!1,trgHasTags=null!==txtTrg.match(/<.*?\>/gi)?!0:!1,"undefined"==typeof where?(UI.doMarkSearchResults(srcHasTags,$(q+" .source:"+c+"('"+txtSrc+"')"),e,q,txtSrc,d),UI.doMarkSearchResults(trgHasTags,$(q+" .targetarea:"+c+"('"+txtTrg+"')"),f,q,txtTrg,d),$("section").has(".source mark.searchPreMarker").has(".targetarea mark.searchPreMarker").find("mark.searchPreMarker").addClass("searchMarker").removeClass("searchPreMarker"),$("mark.searchPreMarker:not(.searchMarker)").each(function(){var a=$(this).text();$(this).replaceWith(a)})):(sid=$(seg).attr("id"),$("section").each("before"==where?function(){$(this).attr("id")<sid&&$(this).addClass("justAdded")}:function(){$(this).attr("id")>sid&&$(this).addClass("justAdded")}),UI.execSearchResultsMarking(UI.filterExactMatch($(q+".justAdded:not(.status-new) .source:"+c+"('"+txtSrc+"')"),txtSrc),e,!1),UI.execSearchResultsMarking(UI.filterExactMatch($(q+".justAdded:not(.status-new) .targetarea:"+c+"('"+txtTrg+"')"),txtTrg),f,!1),$("section").has(".source mark.searchPreMarker").has(".targetarea mark.searchPreMarker").find("mark.searchPreMarker").addClass("searchMarker"),$("mark.searchPreMarker").removeClass("searchPreMarker"),$("section.justAdded").removeClass("justAdded"))}else{status="all"==b.status?"":".status-"+b.status;var g="undefined"!=typeof b.source?b.source:"undefined"!=typeof b.target?b.target:"";singleSegment?(what="undefined"!=typeof b.source?" .source":"undefined"!=typeof b.target?" .targetarea":"",q="#"+$(singleSegment).attr("id")+what):(what="undefined"!=typeof b.source?" .source":"undefined"!=typeof b.target?":not(.status-new) .targetarea":"",q="section"+status+what),hasTags=null!==g.match(/<.*?\>/gi)?!0:!1;var h=g.replace("<",UI.openTagPlaceholder).replace(">",UI.closeTagPlaceholder);h=h.replace(/(\W)/gi,"\\$1");var i=new RegExp("("+htmlEncode(h).replace(/\(/g,"\\(").replace(/\)/g,"\\)")+")","g"+d);"undefined"==typeof where||"no"==where?UI.doMarkSearchResults(hasTags,$(q+":"+c+"('"+g+"')"),i,q,g,d):(sid=$(seg).attr("id"),$("section").each("before"==where?function(){$(this).attr("id")<sid&&$(this).addClass("justAdded")}:function(){$(this).attr("id")>sid&&$(this).addClass("justAdded")}),UI.doMarkSearchResults(hasTags,$("section"+status+".justAdded"+what+":"+c+"('"+g+"')"),i,q,g,d),$("section.justAdded").removeClass("justAdded"))}singleSegment||(UI.unmarkNumItemsInSegments(),UI.markNumItemsInSegments())},doMarkSearchResults:function(a,b,c,d,e,f){a?(inputReg=new RegExp(e,"g"+f),this.execSearchResultsMarking($(d),c,inputReg)):this.execSearchResultsMarking(UI.filterExactMatch(b,e),c,!1)},execSearchResultsMarking:function(a,b,c){searchMarker="source&target"==UI.searchMode?"searchPreMarker":"searchMarker",$(a).each(function(){if(!c||null!==$(this).text().match(c)){var a=$(this).html().replace(/&lt;/g,UI.openTagPlaceholder).replace(/&gt;/g,UI.closeTagPlaceholder).replace(b,'<mark class="'+searchMarker+'">$1</mark>').replace(openTagReg,"&lt;").replace(closeTagReg,"&gt;").replace(/(<span[^>]+>)[^<]*<mark[^>]*>(.*?)<\/mark>[^<]*(<\/span>?)/gi,"$1$3$4");$(this).html(a)}})},filterExactMatch:function(a,b){return this.searchParams["exact-match"]?a.filter(function(){return UI.searchParams["match-case"]?$(this).text()==b:$(this).text().toUpperCase()==b.toUpperCase()}):a},clearSearchFields:function(){$(".searchbox form")[0].reset()},clearSearchMarkers:function(){$("mark.searchMarker").each(function(){$(this).replaceWith($(this).text())}),$("section.currSearchResultSegment").removeClass("currSearchResultSegment")},gotoNextResultItem:function(a){var b=this.searchParams;if("onlyStatus"==this.searchMode){console.log("only status");var c="all"==b.status?"":".status-"+b.status;el=$("section.currSearchSegment"),"all"==b.status?this.scrollSegment($(el).next()):el.nextAll(c).length?(nextToGo=el.nextAll(c).first(),$(el).removeClass("currSearchSegment"),nextToGo.addClass("currSearchSegment"),this.scrollSegment(nextToGo)):(this.pendingRender={firstLoad:!1,applySearch:!0,detectSegmentToScroll:!0,segmentToScroll:this.nextUnloadedResultSegment()},$("#outer").empty(),this.render(this.pendingRender),this.pendingRender=!1)}else"source&target"==this.searchMode?(m=$(".targetarea mark.currSearchItem"),$(m).nextAll("mark.searchMarker").length?(console.log("altri item nel segmento"),$(m).removeClass("currSearchItem"),$(m).nextAll("mark.searchMarker").first().addClass("currSearchItem"),a&&$(m).replaceWith($(m).text()),UI.goingToNext=!1):(console.log("m.length: "+m.length),seg=m.length?$(m).parents("section"):$("mark.searchMarker").first().parents("section"),seg.length?(skipCurrent=$(seg).has("mark.currSearchItem").length,this.gotoSearchResultAfter({el:"segment-"+$(seg).attr("id").split("-")[1],skipCurrent:skipCurrent,unmark:a})):setTimeout(function(){UI.gotoNextResultItem(!1)},500))):(m=$("mark.currSearchItem"),$(m).nextAll("mark.searchMarker").length?(console.log("altri item nel segmento"),$(m).removeClass("currSearchItem"),$(m).nextAll("mark.searchMarker").first().addClass("currSearchItem"),a&&$(m).replaceWith($(m).text()),UI.goingToNext=!1):(seg=m.length?$(m).parents("section"):$("mark.searchMarker").first().parents("section"),seg.length?(skipCurrent=$(seg).has("mark.currSearchItem").length,this.gotoSearchResultAfter({el:"segment-"+$(seg).attr("id").split("-")[1],skipCurrent:skipCurrent,unmark:a})):setTimeout(function(){UI.gotoNextResultItem(!1)},500)))},gotoSearchResultAfter:function(a){console.log("options: ",a),el=a.el,skipCurrent=a.skipCurrent||!1,unmark=a.unmark||!1;var b=this.searchParams;if("onlyStatus"==this.searchMode){var c="all"==b.status?"":".status-"+b.status;"all"==b.status?this.scrollSegment($("#"+el).next()):$("#"+el).nextAll(c).length?(nextToGo=$("#"+el).nextAll(c).first(),nextToGo.addClass("currSearchSegment"),this.scrollSegment(nextToGo)):this.searchResultsSegments?(seg2scroll=this.nextUnloadedResultSegment(),$("#outer").empty(),this.render({firstLoad:!1,applySearch:!0,segmentToScroll:seg2scroll})):this.pendingRender={firstLoad:!1,applySearch:!0,detectSegmentToScroll:!0}}else{var d="source&target"==this.searchMode?" .targetarea":"";seg=$("section"+d).has("mark.searchMarker"),ss="source&target"==this.searchMode?el+"-editarea":el,found=!1,$.each(seg,function(){if($(this).attr("id")>=ss&&($(this).attr("id")!=ss||!skipCurrent)){found=!0,$("html,body").animate({scrollTop:$(this).offset().top-200},500),setTimeout(function(){UI.goingToNext=!1},500);var a=$("mark.currSearchItem");return $(a).removeClass("currSearchItem"),$(this).find("mark.searchMarker").first().addClass("currSearchItem"),unmark&&$(a).replaceWith($(a).text()),!1}}),found||(this.searchResultsSegments?(seg2scroll=this.nextUnloadedResultSegment(),$("#outer").empty(),this.render({firstLoad:!1,applySearch:!0,segmentToScroll:seg2scroll})):this.pendingRender={firstLoad:!1,applySearch:!0,detectSegmentToScroll:!0})}},checkSearchChanges:function(){changes=!1;var a=this.searchParams;return a.source!=$("#search-source").val()&&("undefined"!=typeof a.source||""!==$("#search-source").val())&&(changes=!0),a.target!=$("#search-target").val()&&("undefined"!=typeof a.target||""!==$("#search-target").val())&&(changes=!0),a.status!=$("#select-status").val()&&"undefined"!=typeof a.status&&(changes=!0),a["match-case"]!=$("#match-case").is(":checked")&&(changes=!0),a["exact-match"]!=$("#exact-match").is(":checked")&&(changes=!0),changes},setFindFunction:function(a){var b=$("#exec-find");"next"==a?b.attr("data-func","next").attr("value","Next"):b.attr("data-func","find").attr("value","Find"),b.removeAttr("disabled")},unmarkNumItemsInSegments:function(){$("section[data-searchItems]").removeAttr("data-searchItems")},markNumItemsInSegments:function(){$("section").has("mark.searchMarker").each(function(){$(this).attr("data-searchItems",$("mark.searchMarker",this).length)})},toggleSearch:function(a){this.searchEnabled&&(a.preventDefault(),$("body").hasClass("filterOpen")?$("body").removeClass("filterOpen"):($("body").addClass("filterOpen"),$("#search-source").focus()),this.fixHeaderHeightChange())}});var LTPLACEHOLDER="##LESSTHAN##",GTPLACEHOLDER="##GREATERTHAN##",re_lt=new RegExp(LTPLACEHOLDER,"g"),re_gt=new RegExp(GTPLACEHOLDER,"g");$.fn.isOnScreen=function(){var a=$(window),b={top:a.scrollTop(),left:a.scrollLeft()};console.log("viewport: ",b),b.right=b.left+a.width(),b.bottom=b.top+a.height();var c=this.offset();return c.right=c.left+this.outerWidth(),c.bottom=c.top+this.outerHeight(),!(b.right<c.left||b.left>c.right||b.bottom<c.top||b.top>c.bottom)},$.fn.countdown=function(a,b,c){c=c||"";var d=$(this[0]).html(b+c),e=setInterval(function(){--b?d.html(b+c):(clearInterval(e),console.log("container: ",d),a.call(d))},1e3);return e},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},String.prototype.splice=function(a,b,c){return this.slice(0,a)+c+this.slice(a+Math.abs(b))},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0==this.indexOf(a)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)}),$.extend(UI,{loadCustomization:function(){$.cookie("user_customization")?this.custom=$.parseJSON($.cookie("user_customization")):(this.custom={extended_concordance:!1,extended_tagmode:!1},this.saveCustomization())},saveCustomization:function(){$.cookie("user_customization",JSON.stringify(this.custom),{expires:3650})},setShortcuts:function(){$("#settings-shortcuts .list").length||($("#settings-shortcuts #default-shortcuts").before('<table class="list"></table>'),$.each(this.shortcuts,function(){$("#settings-shortcuts .list").append('<tr><td class="label">'+this.label+'</td><td class="combination"><span contenteditable="true" class="keystroke">'+UI.viewShortcutSymbols(UI.isMac?"undefined"==typeof this.keystrokes.mac?this.keystrokes.standard:this.keystrokes.mac:this.keystrokes.standard)+"</span></td></tr>")}))},viewShortcutSymbols:function(a){return a=a.replace(/meta/gi,"&#8984").replace(/return/gi,"&#8629").replace(/alt/gi,"&#8997").replace(/shift/gi,"&#8679").replace(/up/gi,"&#8593").replace(/down/gi,"&#8595").replace(/left/gi,"&#8592").replace(/right/gi,"&#8594")},writeNewShortcut:function(a,b,c){$(c).html(b.html().substring(0,b.html().length-1)).removeClass("changing").addClass("modified").blur(),$(b).remove(),$(".msg",a).remove(),$("#settings-shortcuts.modifying").removeClass("modifying"),$('.popup-settings .submenu li[data-tab="settings-shortcuts"]').addClass("modified"),$(".popup-settings").addClass("modified")}}),config.enableReview&&config.isReview&&($("html").on("just-open","section",function(){($(this).hasClass("status-new")||$(this).hasClass("status-draft"))&&(sid=$(this).attr("id").split("-")[1],APP.confirm({name:"confirmNotYetTranslated",cancelTxt:"Close",callback:"openNextTranslated",okTxt:"Open next translated segment",context:sid,msg:"This segment is not translated yet.<br /> Only translated segments can be revised."}),UI.openableSegment=!1)}).on("open","section",function(){$(this).hasClass("opened")&&$(this).find(".tab-switcher-review").click()}).on("start",function(){config.stat_quality=[{type:"Typing",allowed:5,found:1,vote:"Excellent"},{type:"Translation",allowed:5,found:1,vote:"Excellent"},{type:"Terminology",allowed:5,found:1,vote:"Excellent"},{type:"Language Quality",allowed:5,found:1,vote:"Excellent"},{type:"Style",allowed:5,found:1,vote:"Excellent"}]}).on("buttonsCreation","section",function(){var a=$("<ul>"+UI.segmentButtons+"</ul>");a.find(".translated").text("APPROVED").removeClass("translated").addClass("approved"),a.find(".next-untranslated").parent().remove(),UI.segmentButtons=a.html()}).on("footerCreation","section",function(){var a=$("<div>"+UI.footerHTML+"</div>");a.find(".submenu").append('<li class="active tab-switcher-review" id="'+$(this).attr("id")+'-review"><a tabindex="-1" href="#">Revise</a></li>'),a.append('<div class="tab sub-editor review" style="display: block" id="segment-'+UI.currentSegmentId+'-review">'+$("#tpl-review-tab").html()+"</div>"),UI.footerHTML=a.html(),UI.currentSegment.find(".tab-switcher-review").click()}).on("afterFooterCreation","section",function(){}).on("click",".editor .tab-switcher-review",function(a){a.preventDefault(),$(".editor .submenu .active").removeClass("active"),$(this).addClass("active"),$(".editor .sub-editor").hide(),$(".editor .sub-editor.review").show()}).on("input",".editor .editarea",function(){UI.trackChanges(this)}).on("afterFormatSelection",".editor .editarea",function(){UI.trackChanges(this)}).on("click",".editor .outersource .copy",function(){UI.trackChanges(UI.editarea)}).on("click","a.approved",function(a){if(a.preventDefault(),UI.tempDisablingReadonlyAlert=!0,UI.hideEditToolbar(),UI.currentSegment.removeClass("modified"),noneSelected=!(UI.currentSegment.find(".sub-editor.review .error-type input[value=1]").is(":checked")||UI.currentSegment.find(".sub-editor.review .error-type input[value=2]").is(":checked")),noneSelected&&$(".editor .track-changes p span").length)$(".editor .tab-switcher-review").click(),$(".sub-editor.review .error-type").addClass("error");else{original=UI.currentSegment.find(".original-translation").text(),$(".sub-editor.review .error-type").removeClass("error"),UI.changeStatus(this,"approved",0),sid=UI.currentSegmentId,err=$(".sub-editor.review .error-type"),err_typing=$(err).find("input[name=t1]:checked").val(),err_translation=$(err).find("input[name=t2]:checked").val(),err_terminology=$(err).find("input[name=t3]:checked").val(),err_language=$(err).find("input[name=t4]:checked").val(),err_style=$(err).find("input[name=t5]:checked").val(),UI.openNextTranslated();var b={action:"setRevision",job:config.job_id,jpassword:config.password,segment:sid,original:original,err_typing:err_typing,err_translation:err_translation,err_terminology:err_terminology,err_language:err_language,err_style:err_style};UI.setRevision(b)}}).on("click",".sub-editor.review .error-type input[type=radio]",function(){$(".sub-editor.review .error-type").removeClass("error")}).on("setCurrentSegment_success",function(a,b){""==b.original&&(b.original=UI.editarea.text()),UI.currentSegment.find(".original-translation").length||UI.editarea.after('<div class="original-translation" style="display: none">'+b.original+"</div>"),UI.setReviewErrorData(b.error_data),UI.trackChanges(UI.editarea)}),$.extend(UI,{setRevision:function(a){APP.doRequest({data:a,error:function(){UI.failedConnection(a,"setRevision")},success:function(a){$("#quality-report").attr("data-vote",a.data.overall_quality_class)}})},trackChanges:function(a){var b=UI.dmp.diff_main(UI.currentSegment.find(".original-translation").text().replace(config.lfPlaceholderRegex,"\n").replace(config.crPlaceholderRegex,"\r").replace(config.crlfPlaceholderRegex,"\r\n").replace(config.tabPlaceholderRegex,"	").replace(config.nbspPlaceholderRegex,String.fromCharCode(parseInt(160,10))),$(a).text().replace(/(<([^>]+)>)/gi,""));diffTxt="",$.each(b,function(){diffTxt+=-1==this[0]?'<span class="deleted">'+this[1]+"</span>":1==this[0]?'<span class="added">'+this[1]+"</span>":this[1],$(".editor .sub-editor.review .track-changes p").html(diffTxt)})},setReviewErrorData:function(a){$.each(a,function(){"Typing"==this.type&&$(".editor .error-type input[name=t1][value="+this.value+"]").prop("checked",!0),"Translation"==this.type&&$(".editor .error-type input[name=t2][value="+this.value+"]").prop("checked",!0),"Terminology"==this.type&&$(".editor .error-type input[name=t3][value="+this.value+"]").prop("checked",!0),"Language Quality"==this.type&&$(".editor .error-type input[name=t4][value="+this.value+"]").prop("checked",!0),"Style"==this.type&&$(".editor .error-type input[name=t5][value="+this.value+"]").prop("checked",!0)})},openNextTranslated:function(a){a=a||UI.currentSegmentId,el=$("#segment-"+a);var b=[],c=[];el.nextAll(".status-translated, .status-approved").length?(console.log("A"),b=el.nextAll(".status-translated"),c=el.nextAll(".status-approved"),b.length?b.first().find(".editarea").click():c.first().find(".editarea").click()):(file=el.parents("article"),file.nextAll(":has(section.status-translated), :has(section.status-approved)").each(function(){var a=$(this).find(".status-translated"),b=$(this).find(".status-approved");return a.length?a.first().find(".editarea").click():b.first().find(".editarea").click(),!1}),$("section.status-translated, section.status-approved").length?(b=$("section.status-translated"),c=$("section.status-approved"),b.length?b.first().is(UI.currentSegment)?UI.scrollSegment(b.first()):b.first().find(".editarea").click():c.first().is(UI.currentSegment)?UI.scrollSegment(c.first()):c.first().find(".editarea").click()):(console.log("D"),APP.doRequest({data:{action:"getNextReviseSegment",id_job:config.job_id,password:config.password,id_segment:a},error:function(){},success:function(a){return null==a.nextId?!1:void UI.render({firstLoad:!1,segmentToOpen:a.nextId})}})))}})),$.extend(UI,{initTM:function(){UI.setDropDown(),$(".popup-tm .x-popup, .popup-tm h1 .continue").click(function(a){a.preventDefault(),UI.closeTMPanel()}),$(".outer-tm").click(function(){UI.saveTMdata(!0)}),$(".popup-tm li.mgmt-tm").click(function(a){a.preventDefault(),console.log("questo"),$(this).addClass("active"),$(".mgmt-mt").removeClass("active"),$(".mgmt-table-mt").hide(),$(".mgmt-table-tm").show()}),$(".popup-tm .tm-mgmt").click(function(a){a.preventDefault(),$(".mgmt-mt").addClass("active"),$(".mgmt-tm").removeClass("active"),$(".mgmt-table-tm").hide(),$(".mgmt-table-mt").show()}),$(".mgmt-mt").click(function(a){a.preventDefault(),$(this).addClass("active"),$(".mgmt-tm").removeClass("active"),$(".mgmt-table-tm").hide(),$(".mgmt-table-mt").show()}),$("#mt_engine").change(function(){0==$(this).val()?$("table.mgmt-mt tr.activemt").removeClass("activemt"):(checkbox=$("table.mgmt-mt tr[data-id="+$(this).val()+"] .enable-mt input"),UI.activateMT(checkbox))}),$("#mt_engine_int").change(function(){$("#add-mt-provider-cancel").hide(),$("#mt-provider-details .error").empty(),$(".insert-tm").show(),provider=$(this).val(),"none"==provider?($(".step2 .fields").html(""),$(".step2").hide(),$(".step3").hide(),$("#add-mt-provider-cancel").show()):($(".step2 .fields").html($("#mt-provider-"+provider+"-fields").html()),$(".step3 .text-left").html($("#mt-provider-"+provider+"-msg").html()),$(".step2").show(),$(".step3").show(),$("#add-mt-provider-confirm").removeClass("hide"))}),$(".add-mt-engine").click(function(){$(this).hide(),$("#add-mt-provider-cancel").show(),$("#add-mt-provider-confirm").addClass("hide"),$(".insert-tm").removeClass("hide")}),$("#add-mt-provider-confirm").click(function(a){return a.preventDefault(),$(this).hasClass("disabled")?!1:(provider=$("#mt_engine_int").val(),providerName=$("#mt_engine_int option:selected").text(),void UI.addMTEngine(provider,providerName))}),$("#add-mt-provider-cancel").click(function(){console.log("clicked add-mt-provider-cancel"),$(".add-mt-engine").show(),$(".insert-tm").addClass("hide")}),$("#add-mt-provider-cancel-int").click(function(){$(".add-mt-engine").show(),$(".insert-tm").addClass("hide"),$("#mt_engine_int").val("none").trigger("change"),$(".insert-tm").addClass("hide").removeAttr("style"),$("#add-mt-provider-cancel").show()}),$("html").on("input","#mt-provider-details input",function(){num=0,$("#mt-provider-details input.required").each(function(){""==$(this).val()&&num++}),num?$("#add-mt-provider-confirm").addClass("disabled"):$("#add-mt-provider-confirm").removeClass("disabled")}),$(".mgmt-tm .new .privatekey .btn-ok").click(function(a){return a.preventDefault(),$(this).hasClass("disabled")?!1:($(this).addClass("disabled"),$("#new-tm-key").attr("disabled","disabled"),void APP.doRequest({data:{action:"createRandUser"},success:function(a){return data=a.data,$("#new-tm-key").val(data.key),$("#activetm tr.new").removeClass("badkey"),$("#activetm tr.new .error .tm-error-key").text("").hide(),UI.checkTMAddAvailability(),!1}}))}),$("body").on("click","tr.mine a.canceladdtmx, tr.ownergroup a.canceladdtmx, #inactivetm tr.new .action .addtmxfile",function(){$(this).parents("tr").find(".action .addtmx").removeClass("disabled"),$(this).parents("td.uploadfile").remove()}).on("click","#activetm tr.uploadpanel a.canceladdtmx, #inactivetm tr.uploadpanel a.canceladdtmx",function(){$("#activetm tr.uploadpanel, #inactivetm tr.uploadpanel").addClass("hide"),$("#activetm tr.new .action .addtmxfile, #inactivetm tr.new .action .addtmxfile").removeClass("disabled")}).on("mousedown",".addtmx:not(.disabled)",function(a){a.preventDefault(),$(this).parents(".action").find(".addtmx").each(function(){$(this).addClass("disabled")});var b='<td class="uploadfile"><form class="existing add-TM-Form pull-left" action="/" method="post">    <input type="hidden" name="action" value="loadTMX" />    <input type="hidden" name="exec" value="newTM" />    <input type="hidden" name="tm_key" value="" />    <input type="hidden" name="name" value="" />    <input type="submit" class="addtm-add-submit" style="display: none" />    <input type="file" name="tmx_file" /></form>  <a class="pull-left btn-grey canceladdtmx">      <span class="text">Cancel</span>  </a>   <a class="existingKey pull-left btn-ok addtmxfile">       <span class="text">Confirm</span>   </a>   <span class="error"></span>  <div class="uploadprogress">       <span class="progress">           <span class="inner"></span>       </span>       <span class="msgText">Uploading</span>       <span class="error"></span>  </div></td>';$(this).parents("tr").append(b)}).on("change paste","#new-tm-key",function(){setTimeout(function(){UI.checkTMKey("change")},200)}).on("click",".mgmt-tm tr.new a.uploadtm:not(.disabled)",function(){UI.checkTMKey("key"),UI.saveTMkey($(this))}).on("click","tr.mine .uploadfile .addtmxfile:not(.disabled), tr.ownergroup .uploadfile .addtmxfile:not(.disabled)",function(){$(this).addClass("disabled"),$(this).parents(".uploadfile").find(".error").text("").hide(),UI.execAddTM(this)}).on("click",".mgmt-tm tr.mine td.description .edit-desc",function(){$(".mgmt-tm .edit-desc[contenteditable=true]").blur(),$("#activetm tr.mine td.description .edit-desc:not(.current)").removeAttr("contenteditable"),$(this).attr("contenteditable",!0)}).on("blur","#activetm td.description .edit-desc",function(){$(this).removeAttr("contenteditable"),UI.saveTMdata(!1)}).on("blur","#inactivetm td.description .edit-desc",function(){$(this).removeAttr("contenteditable"),UI.saveTMdescription($(this))}).on("keydown",".mgmt-tm td.description .edit-desc","return",function(a){13==a.which&&(a.preventDefault(),$(this).trigger("blur"))}).on("click",".mgmt-mt td.engine-name .edit-desc",function(){$(".mgmt-mt .edit-desc[contenteditable=true]").blur(),$(this).attr("contenteditable",!0)}).on("blur",".mgmt-mt td.engine-name .edit-desc",function(){$(this).removeAttr("contenteditable")}).on("keydown",".mgmt-mt td.engine-name .edit-desc","return",function(a){a.preventDefault(),$(this).trigger("blur")}).on("click","#activetm tr.uploadpanel .uploadfile .addtmxfile:not(.disabled)",function(){$(this).addClass("disabled"),UI.execAddTM(this)}).on("click",".popup-tm h1 .btn-ok",function(a){a.preventDefault(),UI.saveTMdata(!0)}).on("click","#activetm tr.new a.addtmxfile:not(.disabled)",function(){console.log("upload file"),UI.checkTMKey("tm"),$("#activetm tr.uploadpanel").removeClass("hide"),$(this).addClass("disabled")}).on("click","a.disabletm",function(){UI.disableTM(this)}).on("change",".mgmt-table-tm tr.mine .lookup input, .mgmt-table-tm tr.mine .update input",function(){APP.isCattool&&UI.saveTMdata(!1),UI.checkTMGrantsModifications(this)}).on("change",".mgmt-table-mt tr .enable-mt input",function(){$(this).is(":checked")?UI.activateMT(this):UI.deactivateMT(this)}).on("click",".mgmt-table-mt tr .action .deleteMT",function(){$(".mgmt-table-mt .tm-warning-message").html('Do you really want to delete this MT? <a href="#" class="continueDeletingMT" data-id="'+$(this).parents("tr").attr("data-id")+'">Continue</a>').show()}).on("click",".continueDeletingMT",function(a){a.preventDefault(),UI.deleteMT($('.mgmt-table-mt table.mgmt-mt tr[data-id="'+$(this).attr("data-id")+'"] .deleteMT')),$(".mgmt-table-mt .tm-warning-message").empty().hide()}).on("click","a.usetm",function(){UI.useTM(this)}).on("change","#new-tm-read, #new-tm-write",function(){UI.checkTMgrants()}).on("change",'tr.mine td.uploadfile input[type="file"], tr.ownergroup td.uploadfile input[type="file"]',function(){return this.files[0].size>config.maxTMXFileSize?(numMb=config.maxTMXFileSize/1048576,APP.alert("File too big.<br/>The maximuxm allowed size is "+numMb+"Mb."),!1):void(""==$(this).val()?$(this).parents(".uploadfile").find(".addtmxfile").hide():$(this).parents(".uploadfile").find(".addtmxfile").show())}).on("change",'.mgmt-tm tr.uploadpanel td.uploadfile input[type="file"]',function(){""==$(this).val()?$(this).parents(".uploadfile").find(".addtmxfile").hide():$(this).parents(".uploadfile").find(".addtmxfile").show()}).on("keyup","#filterInactive",function(){""==$(this).val()?($("#inactivetm").removeClass("filtering"),$("#inactivetm tbody tr.found").removeClass("found")):($("#inactivetm").addClass("filtering"),UI.filterInactiveTM($("#filterInactive").val()))}).on("mousedown",".mgmt-tm .downloadtmx",function(){if($(this).hasClass("downloading"))return!1;UI.downloadTM($(this).parentsUntil("tbody","tr"),"downloadtmx"),$(this).addClass("disabled"),$(this).prepend('<span class="uploadloader"></span>');var a='<span class="notify"><span class="uploadloader"></span> Downloading TMX... '+(APP.isCattool?"You can close the panel and continue translating.":"This can take a few minutes.")+"</span>";$(this).parents("td").first().append(a)}).on("mousedown",".mgmt-tm .deleteTM",function(){UI.deleteTM($(this))}),$(document).ready(function(){UI.setTMsortable(),$("#inactivetm").tablesorter({textExtraction:function(a){return $(a).hasClass("privatekey"),$(a).text()
},headers:{4:{sorter:!1},5:{sorter:!1},6:{sorter:!1},7:{sorter:!1}}})}),$(".add-mt-engine").click(function(){$(this).hide(),console.log("ADD MT ENGINE"),UI.resetMTProviderPanel(),$(".mgmt-table-mt tr.new").removeClass("hide").show()}),$(".mgmt-table-tm .add-tm").click(function(){$(this).hide(),$(".mgmt-table-tm tr.new").removeClass("hide").show()}),$(".mgmt-tm tr.new .canceladdtmx").click(function(){$("#activetm tr.new").hide(),$("#activetm tr.new .addtmxfile").removeClass("disabled"),$("#activetm tr.uploadpanel").addClass("hide"),$(".mgmt-table-tm .add-tm").show(),UI.clearAddTMRow()}),$(".add-gl").click(function(){$(this).hide(),$(".addrow-gl").show()}),$(".cancel-tm").click(function(){$(".mgmt-tm tr.new").hide(),$(".add-tm").show()}),$("#sign-in").click(function(){$(".loginpopup").show()})},openLanguageResourcesPanel:function(a,b){console.log("openLanguageResourcesPanel"),a=a||"tm",b=b||null,$("body").addClass("side-popup"),$(".popup-tm").addClass("open").show("slide",{direction:"right"},400),$("#SnapABug_Button").hide(),$(".outer-tm").show(),$(".mgmt-panel-tm .nav-tabs .mgmt-"+a).click(),b&&$(b).click(),$.cookie("tmpanel-open",1,{path:"/"})},uploadTM:function(a,b,c){console.log("div_id: ",c)},setTMsortable:function(){var a=function(a,b){return b.children().each(function(){$(this).width($(this).width())}),b};$("#activetm tbody").sortable({helper:a,handle:".dragrow",items:".mine"})},checkTMKey:function(a){console.log("checkTMKey"),console.log("operation: ",a);var b=$('#activetm tbody tr:not(".new") .privatekey'),c=!1;return $(b).each(function(a,b){return $(b).text().slice(-5)==$("#new-tm-key").val().slice(-5)?(console.log("key is bad"),$("#activetm tr.new").addClass("badkey"),$("#activetm tr.new .error .tm-error-key").text("The key is already present in this project.").show(),$("#activetm tr.new .error").show(),UI.checkTMAddAvailability(),c=!0,!1):void 0}),c?!1:void APP.doRequest({data:{action:"ajaxUtils",exec:"checkTMKey",tm_key:$("#new-tm-key").val()},context:a,error:function(){console.log("checkTMKey error!!")},success:function(a){a.success===!0?(console.log("key is good"),console.log("adding a tm"),$("#activetm tr.new").removeClass("badkey"),$("#activetm tr.new .error .tm-error-key").text("").hide(),$("#activetm tr.new .error").hide(),UI.checkTMAddAvailability(),"key"==this&&(UI.addTMKeyToList(!1),UI.clearTMUploadPanel())):(console.log("key is bad"),$("#activetm tr.new").addClass("badkey"),$("#activetm tr.new .error .tm-error-key").text("The key is not valid").show(),$("#activetm tr.new .error").show(),UI.checkTMAddAvailability())}})},checkTMAddAvailability:function(){console.log("checkTMAddAvailability"),$("#activetm tr.new").hasClass("badkey")||$("#activetm tr.new").hasClass("badgrants")?($("#activetm tr.new .uploadtm").addClass("disabled"),$("#activetm tr.uploadpanel .addtmxfile").addClass("disabled")):($("#activetm tr.new .uploadtm").removeClass("disabled"),$("#activetm tr.uploadpanel .addtmxfile").removeClass("disabled"))},checkTMgrants:function(){console.log("checkTMgrants"),panel=$(".mgmt-tm tr.new");var a=$(panel).find(".r").is(":checked")?1:0,b=$(panel).find(".w").is(":checked")?1:0;return a||b?(console.log("checkTMgrants POSITIVE"),$("#activetm tr.new").removeClass("badgrants"),$(panel).find(".action .error .tm-error-grants").text("").hide(),UI.checkTMAddAvailability(),!0):(console.log("checkTMgrants NEGATIVE"),$("#activetm tr.new").addClass("badgrants"),$(panel).find(".action .error .tm-error-grants").text('Either "Lookup" or "Update" must be checked').show(),UI.checkTMAddAvailability(),!1)},checkTMGrantsModifications:function(a){if(console.log("el: ",a),tr=$(a).parents("tr.mine"),isActive="activetm"==$(tr).parents("table").attr("id")?!0:!1,tr.find(".lookup input").is(":checked")||tr.find(".update input").is(":checked"))isActive||(UI.useTM(a),$("#inactivetm").trigger("update"));else if(isActive){if(config.isAnonymousUser){var b={grant:$(a).parents("td").hasClass("lookup")?"lookup":"update",key:$(tr).find(".privatekey").text()};return APP.confirm({name:"confirmTMDisable",cancelTxt:"Cancel",onCancel:"cancelTMDisable",callback:"continueTMDisable",okTxt:"Continue",context:JSON.stringify(b),msg:"If you confirm this action, your Private TM key will be lost. <br />If you want to avoid this, please, log in with your account now."}),!1}UI.disableTM(a),$("#inactivetm").trigger("update")}},cancelTMDisable:function(a){options=$.parseJSON(a),$('.mgmt-tm tr.mine[data-key="'+options.key+'"] td.'+options.grant+" input").click()},continueTMDisable:function(a){options=$.parseJSON(a),el=$('.mgmt-tm tr.mine[data-key="'+options.key+'"] td.'+options.grant+" input"),UI.disableTM(el),$("#inactivetm").trigger("update")},disableTM:function(a){var b=$(a).closest("tr");b.find("td.uploadfile").length&&(b.find("td.uploadfile .canceladdtmx").click(),b.find(".addtmx").removeAttr("style")),b.detach(),$("#inactivetm").append(b),b.css("display","block"),b.fadeOut(),b.fadeIn(),$(".addtmxrow").hide()},useTM:function(a){var b=$(a).closest("tr");b.detach(),$("#activetm tr.new").before(b),$("#inactivetm tbody tr:not(.noresults)").length||$("#inactivetm tr.noresults").show(),b.addClass("mine"),b.css("display","block"),b.fadeOut(),b.fadeIn(),$(".addtmxrow").hide()},execAddTM:function(a){table=$(a).parents("table"),existing=$(a).hasClass("existingKey")?!0:!1,existing?$(a).parents(".uploadfile").addClass("uploading"):$(table).find("tr.uploadpanel .uploadfile").addClass("uploading"),trClass=existing?$(a).parents("tr").hasClass("mine")?"mine":"ownergroup":"uploadpanel",form=$(table).find("tr."+trClass+" .add-TM-Form")[0],path=$(a).parents(".uploadfile").find('input[type="file"]').val(),file=path.split("\\")[path.split("\\").length-1],this.TMFileUpload(form,"/?action=loadTMX","uploadCallback",file)},addTMKeyToList:function(a){var b=$("#new-tm-read").is(":checked")?1:0,c=$("#new-tm-write").is(":checked")?1:0,d=$("#new-tm-description").val(),e=$("#new-tm-key").val();newTr='<tr class="mine" data-tm="1" data-glos="1" data-key="'+e+'" data-owner="'+config.ownerIsMe+'">    <td class="dragrow"><div class="status"></div></td>    <td class="privatekey">'+e+'</td>    <td class="owner">You</td>    <td class="description"><div class="edit-desc">'+d+'</div></td>    <td class="lookup check text-center"><input type="checkbox"'+(b?' checked="checked"':"")+' /></td>    <td class="update check text-center"><input type="checkbox"'+(c?' checked="checked"':"")+' /></td>    <td class="action">       <a class="btn pull-left addtmx"><span class="text">Import TMX</span></a>          <div class="wrapper-dropdown-5 pull-left" tabindex="1">&nbsp;              <ul class="dropdown pull-left">                   <li><a class="downloadtmx" title="Export TMX" alt="Export TMX"><span class="icon-download"></span>Export TMX</a></li>                  <li><a class="deleteTM" title="Delete TMX" alt="Delete TMX"><span class="icon-trash-o"></span>Delete TM</a></li>              </ul>          </div></td></tr>',$("#activetm tr.new").before(newTr),a?$(".mgmt-tm tr.new").addClass("hide"):$(".mgmt-tm tr.new .canceladdtmx").click(),UI.pulseTMadded($("#activetm tr.mine").last()),UI.setTMsortable(),APP.isCattool&&UI.saveTMdata(!1)},pulseTMadded:function(a){setTimeout(function(){$("#activetm tbody").animate({scrollTop:5e3},0),a.fadeOut(),a.fadeIn()},10),setTimeout(function(){$("#activetm tbody").animate({scrollTop:5e3},0)},1e3)},clearTMUploadPanel:function(){$("#new-tm-key, #new-tm-description").val(""),$("#new-tm-key").removeAttr("disabled"),$(".mgmt-tm tr.new .privatekey .btn-ok").removeClass("disabled"),$("#new-tm-read, #new-tm-write").prop("checked",!0)},clearAddTMRow:function(){$("#new-tm-description").val(""),$("#new-tm-key").removeAttr("disabled"),$(".mgmt-tm tr.new .privatekey .btn-ok").removeClass("disabled"),$("#activetm .fileupload").val(""),$(".mgmt-tm tr.new").removeClass("badkey badgrants"),$(".mgmt-tm tr.new .message").text(""),$(".mgmt-tm tr.new .error span").text("").hide(),$(".mgmt-tm tr.new .addtmxfile").show()},clearTMPanel:function(){$(".mgmt-container .tm-error-message").hide(),$(".mgmt-container .tm-warning-message").hide(),$("#activetm .edit-desc").removeAttr("contenteditable"),$("#activetm td.action .addtmx").removeClass("disabled"),$("#activetm tr.new .canceladdtmx").click()},TMFileUpload:function(a,b,c,d){ts=(new Date).getTime(),ifId="upload_iframe-"+ts;var e=document.createElement("iframe");e.setAttribute("id",ifId),console.log("iframe: ",e),e.setAttribute("name","upload_iframe"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("border","0"),e.setAttribute("style","width: 0; height: 0; border: none;"),document.body.appendChild(e),window.frames.upload_iframe.name="upload_iframe",iframeId=document.getElementById(ifId),UI.TMuploadIframeId=iframeId;var f=function(){iframeId.detachEvent?iframeId.detachEvent("onload",f):iframeId.removeEventListener("load",f,!1),iframeId.contentDocument?content=iframeId.contentDocument.body.innerHTML:iframeId.contentWindow?content=iframeId.contentWindow.document.body.innerHTML:iframeId.document&&(content=iframeId.document.body.innerHTML),document.getElementById(c).innerHTML=content};return iframeId.addEventListener&&iframeId.addEventListener("load",f,!0),iframeId.attachEvent&&iframeId.attachEvent("onload",f),existing=$(a).hasClass("existing")?!0:!1,existing?(TR=$(a).parents("tr"),TMKey=TR.find(".privatekey").first().text()):TMKey=$("#new-tm-key").val(),a.setAttribute("target","upload_iframe"),a.setAttribute("action",b),a.setAttribute("method","post"),a.setAttribute("enctype","multipart/form-data"),a.setAttribute("encoding","multipart/form-data"),$(a).append('<input type="hidden" name="exec" value="newTM" />').append('<input type="hidden" name="tm_key" value="'+TMKey+'" />').append('<input type="hidden" name="name" value="'+d+'" />').append('<input type="hidden" name="r" value="1" />').append('<input type="hidden" name="w" value="1" />'),APP.isCattool&&$(a).append('<input type="hidden" name="job_id" value="'+config.job_id+'" />').append('<input type="hidden" name="job_pass" value="'+config.password+'" />'),a.submit(),document.getElementById(c).innerHTML="",TMPath=existing?$(a).find('input[type="file"]').val():$('.mgmt-tm tr.uploadpanel td.uploadfile input[type="file"]').val(),TMName=TMPath.split("\\")[TMPath.split("\\").length-1],TRcaller=existing?$(a).parents(".uploadfile"):$("#activetm .uploadpanel .uploadfile"),TRcaller.addClass("startUploading"),existing||UI.addTMKeyToList(!0),setTimeout(function(){UI.pollForUploadCallback(TMKey,TMName,existing,TRcaller)},3e3),!1},pollForUploadCallback:function(a,b,c,d){""!=$("#uploadCallback").text()?(msg=$.parseJSON($("#uploadCallback pre").text()),msg.success===!0?setTimeout(function(){d.removeClass("startUploading"),UI.pollForUploadProgress(a,b,c,d)},3e3):(console.log("error"),d.removeClass("startUploading"),$(d).find(".error").text(msg.errors[0].message).show())):setTimeout(function(){UI.pollForUploadCallback(a,b,c,d)},1e3)},pollForUploadProgress:function(a,b,c,d){APP.doRequest({data:{action:"loadTMX",exec:"uploadStatus",tm_key:a,name:b},context:[a,b,c,d],error:function(){c=this[2],c?console.log("error"):$("#activetm tr.uploadpanel .uploadfile").removeClass("uploading")},success:function(a){if(console.log("progress success data: ",a),c=this[2],d=this[3],a.errors.length)c?(console.log("error"),console.log($(d)),$(d).find(".error").text(a.errors[0].message).show()):$("#activetm tr.uploadpanel .uploadfile").removeClass("uploading");else if($(d).find(".uploadprogress .msgText").text("Uploading "+this[1]),$(d).find(".uploadprogress").show(),null==a.data.total)pollForUploadProgressContext=this,setTimeout(function(){UI.pollForUploadProgress(pollForUploadProgressContext[0],pollForUploadProgressContext[1],pollForUploadProgressContext[2],pollForUploadProgressContext[3])},1e3);else{if(a.completed){if(c){console.log(config.isAnonymousUser?"anonimo":"loggato");var b=$(d).parents("tr.mine");$(b).find(".addtmx").removeClass("disabled"),UI.pulseTMadded(b)}return $(d).find(".uploadprogress").hide(),$(d).find(".uploadprogress .msgText").text("Uploading"),c?($(d).addClass("tempTRcaller").append('<span class="msg">Import Complete</span>'),setTimeout(function(){$(".tempTRcaller").remove()},3e3)):($(".mgmt-tm tr.new .canceladdtmx").click(),$(".mgmt-tm tr.new").removeClass("hide"),$("#activetm tr.uploadpanel .uploadfile").removeClass("uploading")),UI.TMuploadIframeId.parentNode.removeChild(UI.TMuploadIframeId),!1}progress=parseInt(a.data.done)/parseInt(a.data.total)*100,$(d).find(".progress .inner").css("width",progress+"%"),pollForUploadProgressContext=this,setTimeout(function(){UI.pollForUploadProgress(pollForUploadProgressContext[0],pollForUploadProgressContext[1],pollForUploadProgressContext[2],pollForUploadProgressContext[3])},1e3)}}})},allTMUploadsCompleted:function(){return $("#activetm .uploadfile.uploading").length?(APP.alert({msg:"There is one or more TM uploads in progress. Try again when all uploads are completed!"}),!1):$("tr td a.downloading").length?(APP.alert({msg:"There is one or more TM downloads in progress. Try again when all downloads are completed or open another browser tab."}),!1):!0},extractTMdataFromTable:function(){categories=["ownergroup","mine","anonymous"];var a={};return $.each(categories,function(b,c){data=UI.extractTMDataFromRowCategory(this),a[c]=data}),JSON.stringify(a)},extractTMDataFromRowCategory:function(a){return tt=$("#activetm tbody tr."+a),dataOb=[],$(tt).each(function(){return r=$(this).find(".lookup input").is(":checked")?1:0,w=$(this).find(".update input").is(":checked")?1:0,r||w?(dd={tm:$(this).attr("data-tm"),glos:$(this).attr("data-glos"),owner:$(this).attr("data-owner"),key:$(this).find(".privatekey").text().trim(),name:$(this).find(".description").text().trim(),r:r,w:w},void dataOb.push(dd)):!0}),dataOb},extractTMdataFromRow:function(a){return data={tm_key:a.find(".privatekey").text(),key:this.tm_key,tmx_name:a.find(".description").text(),name:this.tmx_name,r:a.find(".lookup input").is(":checked")?1:0,w:a.find(".update input").is(":checked")?1:0}},saveTMdata:function(a){return $(".popup-tm").addClass("saving"),a&&(UI.closeTMPanel(),UI.clearTMPanel()),APP.isCattool?(data=this.extractTMdataFromTable(),void APP.doRequest({data:{action:"updateJobKeys",job_id:config.job_id,job_pass:config.password,data:data},error:function(){console.log("Error saving TM data!!"),$(".tm-error-message").text("There was an error saving your data. Please retry!").show(),$(".popup-tm").removeClass("saving")},success:function(a){$(".popup-tm").removeClass("saving"),a.errors.length?APP.showMessage({msg:a.errors[0].message}):console.log("TM data saved!!")}})):(UI.updateTMAddedMsg(),!1)},saveTMdescription:function(a){console.log(a);var b=a.parents("tr").first();APP.doRequest({data:{action:"userKeys",exec:"update",key:b.find(".privatekey").text(),description:a.text()},error:function(){console.log("Error saving TM description!!"),APP.showMessage({msg:"There was an error saving your description. Please retry!"}),$(".popup-tm").removeClass("saving")},success:function(a){$(".popup-tm").removeClass("saving"),a.errors.length?APP.showMessage({msg:a.errors[0].message}):console.log("TM description saved!!")}})},saveTMkey:function(){APP.doRequest({data:{action:"userKeys",exec:"newKey",key:$("#new-tm-key").val(),description:$("#new-tm-description").val()},error:function(){console.log("Error saving TM key!"),$(".popup-tm").removeClass("saving")},success:function(a){$(".popup-tm").removeClass("saving"),a.errors.length||console.log("TM key saved!!")}})},closeTMPanel:function(){if($(".mgmt-tm tr.uploadpanel").hide(),$(".popup-tm").removeClass("open").hide("slide",{direction:"right"},400),$("#SnapABug_Button").show(),$(".outer-tm").hide(),$("body").removeClass("side-popup"),$.cookie("tmpanel-open",0,{path:"/"}),!APP.isCattool&&!checkAnalyzability("closing tmx panel")&&(disableAnalyze(),!a))var a=window.setInterval(function(){checkAnalyzability("set interval")&&(enableAnalyze(),window.clearInterval(a))},500)},filterInactiveTM:function(a){$("#inactivetm tbody tr").removeClass("found"),$('#inactivetm tbody td.privatekey:containsNC("'+a+'"), #inactivetm tbody td.description:containsNC("'+a+'")').parents("tr").addClass("found")},downloadTM:function(a,b){if(!$(a).find("."+b).hasClass("disabled")){var c=(new Date).getTime()+"_"+parseInt(1e7*Math.random(0,1)),d="iframeDownload_"+c,e="form_"+c,f=$(document.createElement("iframe")).hide().prop({id:d,src:""});$("body").append(f),f.ready(function(){var e=window.setInterval(function(){var f=$.cookie(c);f==c&&($(a).find("."+b).removeClass("disabled").removeClass("downloading"),$(a).find("span.notify").remove(),window.clearInterval(e),$.cookie(c,null,{path:"/",expires:-1}),errorMsg=$("#"+d).contents().find("body").text(),errorKey=$(a).attr("data-key"),""!=errorMsg&&APP.alert("Error on downloading a TM with key "+errorKey+":<br />"+errorMsg),$("#"+d).remove())},2e3)});var g=$(document.createElement("form")).attr({id:e,action:"/",method:"POST"}).append($(document.createElement("input")).prop({type:"hidden",name:"action",value:"downloadTMX"}),$(document.createElement("input")).prop({type:"hidden",name:"downloadToken",value:c}),$(document.createElement("input")).prop({type:"hidden",name:"tm_key",value:$(".privatekey",a).text()}));f.contents().find("body").append(g),console.log(f.contents().find("#"+e)),f.contents().find("#"+e).submit()}},deleteTM:function(a){tr=$(a).parents("tr").first(),$(tr).fadeOut("normal",function(){$(this).remove()}),APP.doRequest({data:{action:"userKeys",exec:"delete",key:tr.find(".privatekey").text()},error:function(){console.log("Error deleting TM!!")},success:function(){}})},deleteMT:function(a){id=$(a).parents("tr").first().attr("data-id"),APP.doRequest({data:{action:"engine",exec:"delete",id:id},context:id,error:function(){console.log("error")},success:function(){console.log("success"),$(".mgmt-table-mt tr[data-id="+this+"]").remove(),$("#mt_engine option[value="+this+"]").remove(),$("#mt_engine option[selected=selected]").length||$("#mt_engine option[value=0]").attr("selected","selected")}})},addMTEngine:function(a,b){providerData={},$(".insert-tm .provider-data .provider-field").each(function(){field=$(this).find("input").first(),providerData[field.attr("data-field-name")]=field.val()}),name=$("#new-engine-name").val(),data={action:"engine",exec:"add",name:name,provider:a,data:JSON.stringify(providerData)},context=data,context.providerName=b,APP.doRequest({data:data,context:context,error:function(){console.log("error")},success:function(a){a.errors.length?(console.log("error"),$("#mt-provider-details .error").text(a.errors[0].message)):(console.log("success"),UI.renderNewMT(this,a.data.id),APP.isCattool||(UI.activateMT($("table.mgmt-mt tr[data-id="+a.data.id+"] .enable-mt input")),$("#mt_engine").append('<option value="'+a.data.id+'">'+this.name+"</option>"),$("#mt_engine option:selected").removeAttr("selected"),$('#mt_engine option[value="'+a.data.id+'"]').attr("selected","selected")),$("#mt_engine_int").val("none").trigger("change"))}})},renderNewMT:function(a,b){newTR='<tr data-id="'+b+'">    <td class="mt-provider">'+a.providerName+'</td>    <td class="engine-name">'+a.name+'</td>    <td class="enable-mt text-center">        <input type="checkbox" checked />    </td>    <td class="action">        <a class="deleteMT btn pull-left"><span class="text">Delete</span></a>    </td></tr>',APP.isCattool?$("table.mgmt-mt tbody tr:not(.activemt)").first().before(newTR):($("table.mgmt-mt tbody tr.activetm").removeClass("activetm").find(".enable-mt input").removeAttr("checked"),$("table.mgmt-mt tbody").prepend(newTR))},pulseMTadded:function(a){setTimeout(function(){$(".activemt").animate({scrollTop:5e3},0),a.fadeOut(),a.fadeIn()},10),setTimeout(function(){$(".activemt").animate({scrollTop:5e3},0)},1e3)},resetMTProviderPanel:function(){"block"==$(".insert-tm .step2").css("display")&&($("#add-mt-provider-cancel-int").click(),$(".add-mt-engine").click())},activateMT:function(a){tr=$(a).parents("tr"),$(a).replaceWith('<input type="checkbox" checked class="temp" />'),cbox=tr.find("input[type=checkbox]"),tbody=tr.parents("tbody"),$(tbody).prepend(tr),tbody.find(".activemt input[type=checkbox]").replaceWith('<input type="checkbox" />'),tbody.find(".activemt").removeClass("activemt"),tr.addClass("activemt").removeClass("temp"),$("#mt_engine option").removeAttr("selected"),$("#mt_engine option[value="+tr.attr("data-id")+"]").attr("selected","selected"),UI.pulseMTadded($(".activemt").last())},deactivateMT:function(a){tr=$(a).parents("tr"),$(a).replaceWith('<input type="checkbox" />'),tr.removeClass("activemt"),$("#mt_engine option").removeAttr("selected"),$("#mt_engine option[value=0]").attr("selected","selected")},openTMActionDropdown:function(a){$(a).parents("td").find(".dropdown").toggle()},closeTMActionDropdown:function(a){$(a).parents("td").find(".wrapper-dropdown-5").click()},setDropDown:function(){new UI.DropDown($(".wrapper-dropdown-5")),$(".action").mouseleave(function(){$(".wrapper-dropdown-5").removeClass("activeMenu")}),$(document).click(function(){$(".wrapper-dropdown-5").removeClass("activeMenu")})},DropDown:function(a){this.initEvents=function(){var a=this;a.dd.on("click",function(a){$(this).toggleClass("activeMenu"),a.preventDefault(),$(this).hasClass("activeMenu")&&a.stopPropagation()})},this.dd=a,this.initEvents()}}),UI.offlineCacheSize=30,UI.offlineCacheRemaining=UI.offlineCacheSize,UI.checkingConnection=!1,UI.currentConnectionCountdown=null,$.extend(UI,{startOfflineMode:function(){UI.offline||(UI.offline=!0,UI.body.attr("data-offline-mode","light-off"),UI.showMessage({msg:'<span class="icon-power-cord"></span><span class="icon-power-cord2"></span>No connection available. You can still translate <span class="remainingSegments">'+UI.offlineCacheSize+"</span> segments in offline mode. Do not refresh or you lose the segments!"}),UI.checkingConnection=setInterval(function(){UI.checkConnection("Recursive Check authorized")},5e3))},endOfflineMode:function(){UI.offline&&(UI.offline=!1,UI.showMessage({msg:"Connection is back. We are saving translated segments in the database."}),setTimeout(function(){$("#messageBar .close").click()},1e4),clearInterval(UI.currentConnectionCountdown),clearInterval(UI.checkingConnection),UI.currentConnectionCountdown=null,UI.checkingConnection=!1,UI.body.removeAttr("data-offline-mode"),$(".noConnectionMsg").text("The connection is back. Your last, interrupted operation has now been done."),setTimeout(function(){$(".noConnection").addClass("reConnection"),setTimeout(function(){$(".noConnection, .noConnectionMsg").remove()},500)},3e3))},failedConnection:function(a,b){if(UI.startOfflineMode(),"getWarning"!=b){var c={operation:b,args:a};UI.abortedOperations.push(c)}},activateOfflineCountdown:function(a){$(".noConnection").length||UI.body.append('<div class="noConnection"></div><div class="noConnectionMsg"></div>'),$(".noConnectionMsg").html('<div class="noConnectionMsg">'+a+'<br /><span class="reconnect">Trying to reconnect in <span class="countdown">30 seconds</span>.</span><br /><br /><input type="button" id="checkConnection" value="Try to reconnect now" /></div>'),UI.currentConnectionCountdown=$(".noConnectionMsg .countdown").countdown(function(){console.log("offlineCountdownEnd"),UI.checkConnection("Clear countdown authorized"),UI.activateOfflineCountdown("Still no connection.")},30," seconds")},checkConnection:function(a){console.log(a),console.log("check connection"),APP.doRequest({data:{action:"ajaxUtils",exec:"ping"},error:function(){},success:function(){console.log("check connection success"),UI.restoringAbortedOperations||(UI.restoringAbortedOperations=!0,UI.execAbortedOperations(UI.endOfflineMode),UI.restoringAbortedOperations=!1,UI.executingSetTranslation=!1,UI.execSetTranslationTail(),UI.execSetContributionTail())}})},extractLocalStoredItems:function(a,b){return b=b||!1,items=[],$.each(localStorage,function(c,d){if(op=c.substring(0,a.length),op===a){if(kAr=c.split("-"),b&&kAr[1]===b)return console.log(kAr[1]),!0;items.push({operation:op,job:kAr[1],sid:kAr[2],value:JSON.parse(d)})}}),items},failover:function(a,b){if("getWarning"!=b){var c={operation:b,args:a},d=new Date;c.args&&UI.addInStorage("pending-"+d.getTime(),JSON.stringify(c),"contribution"),UI.checkConnectionTimeout||(UI.checkConnectionTimeout=setTimeout(function(){UI.checkConnection(),UI.checkConnectionTimeout=!1},5e3))}},execAbortedOperations:function(a){a=a||{},$.each(UI.abortedOperations,function(){args=this.args,operation=this.operation,"setTranslation"==operation?UI[operation](args[0],args[1],args[2],UI.incrementOfflineCacheRemaining):"updateContribution"==operation?UI[operation](args[0],args[1]):"setContributionMT"==operation?UI[operation](args[0],args[1],args[2]):"setCurrentSegment"==operation?UI[operation](args[0]):"getSegments"==operation?UI.reloadWarning():"setRevision"==operation&&UI[operation](args)}),UI.abortedOperations=[],a.call()},checkOfflineCacheSize:function(){UI.offlineCacheRemaining||UI.activateOfflineCountdown("No connection available.")},decrementOfflineCacheRemaining:function(){$("#messageBar .remainingSegments").text(--this.offlineCacheRemaining),UI.checkOfflineCacheSize()},incrementOfflineCacheRemaining:function(){UI.offlineCacheRemaining+=1}}),$("html").on("mousedown",'body[data-offline-mode="light-off"] .editor .actions .split',function(a){a.preventDefault(),APP.alert("Split is disabled in Offline Mode")}),config.splitSegmentEnabled&&(UI.splittedTranslationPlaceholder="##$_SPLIT$##",$("html").on("mouseover",".editor .source, .editor .sid",function(){actions=$(".editor .sid").parent().find(".actions"),actions.show()}).on("mouseout",".sid, .editor:not(.split-action) .source, .editor:not(.split-action) .outersource .actions",function(){actions=$(".editor .sid").parent().find(".actions"),actions.hide()}).on("click","body:not([data-offline-mode]) .outersource .actions .split:not(.cancel)",function(a){a.preventDefault(),segment=$(this).parents("section"),$(".editor .split-shortcut").html("CTRL + W"),console.log("split"),UI.currentSegment.addClass("split-action"),actions=$(this).parent().find(".actions"),actions.show(),UI.createSplitArea(segment)}).on("click","body:not([data-offline-mode]) .sid .actions .split",function(a){a.preventDefault(),$(".sid .actions .split").addClass("cancel"),$(".split-shortcut").html("CTRL + W"),UI.currentSegment.addClass("split-action"),actions=$(this).parent().find(".actions"),actions.show(),UI.createSplitArea($(this).parents("section"))}).on("click","body[data-offline-mode] .sid .actions .split",function(a){a.preventDefault()}).on("click",".sid .actions .split.cancel",function(a){a.preventDefault(),$(".sid .actions .split").removeClass("cancel"),source=$(segment).find(".source"),$(source).removeAttr("style"),UI.currentSegment.removeClass("split-action"),$(".split-shortcut").html("CTRL + S"),console.log("cancel"),segment=$(this).parents("section"),segment.find(".splitBar, .splitArea").remove(),segment.find(".sid .actions").hide()}).on("keydown",".splitArea",function(a){console.log("keydown"),a.preventDefault()}).on("keypress",".splitArea",function(a){console.log("keypress"),a.preventDefault()}).on("keyup",".splitArea",function(a){console.log("keyup"),a.preventDefault()}).on("click",".splitArea",function(a){return a.preventDefault(),"Range"==window.getSelection().type?!1:$(this).hasClass("splitpoint")?!1:(pasteHtmlAtCaret('<span class="splitpoint"><span class="splitpoint-delete"></span></span>'),UI.cleanSplitPoints($(this)),UI.updateSplitNumber($(this)),void $(this).blur())}).on("mousedown",".splitArea .splitpoint",function(a){a.preventDefault(),a.stopPropagation(),segment=$(this).parents("section"),$(this).remove(),UI.updateSplitNumber($(segment).find(".splitArea"))}).on("click",".splitBar .buttons .done",function(a){segment=$(this).parents("section"),a.preventDefault(),UI.splitSegment(segment)}),$("html").bind("keydown","ctrl+s",function(a){a.preventDefault(),UI.currentSegment.find(".sid .actions .split").click()}).bind("keydown","ctrl+w",function(a){a.preventDefault(),UI.currentSegment.find(".sid .actions .split").click()}),$.extend(UI,{splitSegment:function(a){ss=this.cleanSplittedSource(a.find(".splitArea").html()),splittedSource=ss.split('<span class="splitpoint"><span class="splitpoint-delete"></span></span>'),a.find(".splitBar .buttons .cancel").click(),oldSid=a.attr("id").split("-")[1],this.setSegmentSplit(oldSid,splittedSource)},cleanSplittedSource:function(a){return a=a.replace(/<span contenteditable=\"false\" class=\"locked(.*?)\"\>(.*?)<\/span\>/gi,"$2"),a=a.replace(/<span class=\"currentSplittedSegment\">(.*?)<\/span>/gi,"$1")},setSegmentSplit:function(a,b){splitAr=[0],splitIndex=0,$.each(b,function(a){cc=UI.cleanSplittedSource(b[a]),ll=$("<div>").html(cc).text().length,cc=cc.replace(/"/gi,"&quot;"),splitIndex+=ll,splitAr.push(splitIndex)}),splitAr.pop(),onlyOne=1==b.length?!0:!1,splitArString="0"==splitAr.toString()?"":splitAr.toString(),totalSource="",$.each(b,function(a){totalSource+=$(document.createElement("div")).html(b[a]).text(),a<b.length-1&&(totalSource+=UI.splittedTranslationPlaceholder)}),APP.doRequest({data:{action:"setSegmentSplit",segment:totalSource,id_segment:a,id_job:config.job_id,password:config.password},context:{splittedSource:b,sid:a,splitAr:splitAr},error:function(){UI.setSegmentSplitSuccess(this),console.log("error")},success:function(a){UI.setSegmentSplitSuccess(this),console.log("success"),"OK"==a.data}})},setSegmentSplitSuccess:function(a){oldSid=a.sid,console.log("oldSid: ",oldSid),splittedSource=a.splittedSource,console.log("splittedSource: ",splittedSource),splitAr=a.splitAr,newSegments=[],splitGroup=[],onlyOne=1==splittedSource.length?!0:!1,translation="",onlyOne&&$("div[id*=segment-"+oldSid+"]").filter(function(){return this.id.match(/-editarea/)}).each(function(a,b){translation+=$(b).html()}),$.each(splittedSource,function(a){onlyOne||(translation=0==a?UI.editarea.html():""),segData={autopropagated_from:"0",has_reference:"false",parsed_time_to_edit:["00","00","00","00"],readonly:"false",segment:this.toString(),segment_hash:segment.attr("data-hash"),sid:onlyOne?oldSid:oldSid+"-"+(a+1),split_points_source:[],status:"DRAFT",time_to_edit:"0",translation:translation,version:segment.attr("data-version"),warning:"0"},newSegments.push(segData),splitGroup.push(oldSid+"-"+(a+1))}),oldSegment=$("#segment-"+oldSid),alreadySplitted=oldSegment.length?!1:!0,onlyOne&&(splitGroup=[]),$(".test-invisible").remove(),alreadySplitted?(prevSeg=$("#segment-"+oldSid+"-1").prev("section"),prevSeg.length?($("section[data-split-original-id="+oldSid+"]").remove(),$(prevSeg).after(UI.renderSegments(newSegments,!0,splitAr,splitGroup))):(file=$("#segment-"+oldSid+"-1").parents("article"),$("section[data-split-original-id="+oldSid+"]").remove(),$(file).prepend(UI.renderSegments(newSegments,!0,splitAr,splitGroup))),splitGroup.length?($.each(splitGroup,function(){UI.lockTags($("#segment-"+this+" .source"))}),this.gotoSegment(oldSid+"-1")):(UI.lockTags($("#segment-"+oldSid+" .source")),this.gotoSegment(oldSid))):($(oldSegment).after(UI.renderSegments(newSegments,!0,splitAr,splitGroup)),$.each(splitGroup,function(){UI.lockTags($("#segment-"+this+" .source"))}),$(oldSegment).remove(),this.gotoSegment(oldSid+"-1"))},createSplitArea:function(a){isSplitted=""!=a.attr("data-split-group"),source=$(a).find(".source"),$(source).removeAttr("style"),targetHeight=$(".targetarea").height(),a.find(".splitContainer").remove(),source.after('<div class="splitContainer"><div class="splitArea" contenteditable="true"></div><div class="splitBar"><div class="buttons"><a class="cancel hide" href="#">Cancel</a><a href="#" class="done btn-ok pull-right">Confirm</a></div><div class="splitNum pull-right">Split in <span class="num">1</span> segment<span class="plural"></span></div></div></div>'),splitArea=a.find(".splitArea"),setTimeout(function(){sourceHeight=$(source).height(),splitAreaHeight=$(splitArea).height(),sourceHeight>=splitAreaHeight?($(".splitBar").css("top",sourceHeight+70+"px"),$(source).css("height",sourceHeight+"px"),$(".editor .wrap").css("padding-bottom",splitAreaHeight-targetHeight+"px")):splitAreaHeight>sourceHeight&&($(source).css("height",splitAreaHeight+100+"px"),$(".splitBar").css("top",splitAreaHeight+70+"px"))
},100),isSplitted&&splitArea.removeAttr("style"),isSplitted?(segments=a.attr("data-split-group").split(","),totalMarkup="",$.each(segments,function(a){newMarkup=$("#segment-"+this+" .source").attr("data-original"),this==UI.currentSegmentId&&(newMarkup='<span class="currentSplittedSegment">'+newMarkup+"</span>"),totalMarkup+=newMarkup,a!=segments.length-1&&(totalMarkup+='<span class="splitpoint"><span class="splitpoint-delete"></span></span>')}),splitAreaMarkup=totalMarkup):splitAreaMarkup=source.attr("data-original"),splitArea.html(splitAreaMarkup),this.lockTags(splitArea),splitArea.find(".rangySelectionBoundary").remove()},updateSplitNumber:function(a){segment=$(a).parents("section"),numSplits=$(a).find(".splitpoint").length+1,splitnum=$(segment).find(".splitNum"),$(splitnum).find(".num").text(numSplits),numSplits>1?($(splitnum).find(".plural").text("s"),splitnum.show()):($(splitnum).find(".plural").text(""),splitnum.hide())},cleanSplitPoints:function(a){a.html(a.html().replace(/(<span class="splitpoint"><span class="splitpoint-delete"><\/span><\/span>)<span class="splitpoint"><span class="splitpoint-delete"><\/span><\/span>/gi,"$1")),a.html(a.html().replace(/(<span class="splitpoint"><span class="splitpoint-delete"><\/span><\/span>)$/gi,""))}}));